<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>CashChat — بيع/مشتريات + خصم/ضريبة لكل بند + تحصيل مربوط بفاتورة</title>
<style>
:root{--dark:#075e54;--mid:#128c7e;--paper:#e5ddd5}
*{box-sizing:border-box}body{margin:0;background:#0b0b0b;color:#e5e7eb;font-family:Tahoma,system-ui,-apple-system,sans-serif}
.wrap{max-width:1080px;margin:0 auto;padding:12px}
.hero{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.logo{font-weight:800}.logo span{background:#fff;color:#075e54;padding:2px 8px;border-radius:10px;margin:0 4px}
.pill{background:#0f172a;border:1px solid #273046;border-radius:999px;padding:6px 10px}
select,input{background:#0f172a;color:#e5e7eb;border:1px solid #273046;border-radius:8px;padding:4px 6px}
.tabs{display:flex;gap:8px;overflow-x:auto;padding:10px 0}
.tab{padding:10px;border-radius:12px;border:1px solid #2e3441;background:#0f172a;color:#e5e7eb;cursor:pointer;white-space:nowrap}
.tab.active{background:#128c7e;border-color:#128c7e;color:#fff}
.panel{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:12px;margin-top:8px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
/* phone chat */
.phone{width:100%;height:72vh;background:var(--paper);border-radius:18px;border:8px solid #000;box-shadow:0 14px 40px rgba(0,0,0,.35);position:relative;overflow:hidden}
.header{background:var(--dark);color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
.chat{position:absolute;inset:52px 0 170px 0;background:var(--paper);padding:12px;overflow:auto}
.bubble{max-width:85%;padding:10px 12px;margin:6px 10px;border-radius:12px;font-size:15px;box-shadow:0 1px 0 rgba(0,0,0,.05);color:#111}
.bot{background:#ffffff;margin-left:auto;margin-right:10px;border-top-right-radius:4px}
.me{background:#dcf8c6;margin-right:auto;margin-left:10px;border-top-left-radius:4px}
.actions{position:absolute;left:0;right:0;bottom:0;background:#f9fafb;border-top:1px solid #e5e7eb;padding:8px}
.quick{display:flex;gap:8px;overflow-x:auto;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.quick button{flex:0 0 auto;padding:8px 12px;border:1px solid #cbd5e1;background:#ffffff;color:#0b0b0b;border-radius:12px;cursor:pointer}
.quick select,.quick input{background:#fff;color:#111;border:1px solid #cbd5e1;border-radius:10px;padding:6px 8px}
.input{display:flex;gap:8px;align-items:center}
.field{flex:1;border:1px solid #cbd5e1;border-radius:24px;padding:10px 14px;background:#fff;color:#111}
/* docs */
.doc-head{background:#075e54;color:#fff;padding:10px 12px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.btn{background:#0f172a;border:1px solid #273046;color:#e5e7eb;padding:8px 12px;border-radius:12px;cursor:pointer}
.btn.primary{background:#128c7e;border-color:#128c7e}
table{width:100%;border-collapse:collapse}th,td{border:1px solid #2b3242;padding:8px;background:#0f172a}th{background:#0c1220}
td.num,th.num{text-align:left;font-variant-numeric:tabular-nums}
.note{font-size:12px;color:#9aa4b2}.ghost{opacity:.55}.hidden{display:none}
@media print{ body{background:#fff;color:#000}.hero,.tabs,.actions{display:none}.panel{border:0;background:#fff}.doc-head{background:#fff;color:#000;border:0;padding:0}th,td{background:#fff;color:#000;border:1px solid #ccc}}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="logo">Cash<span>Chat</span> — <span style="background:#25d366;color:#0b0b0b">SAMPLE</span></div>
    <div class="pill">
      اسم الشركة: <input id="company" value="البركة للمقاولات" style="width:180px"/>
      · الضريبة:
      <select id="taxMode"><option value="taxed" selected>خاضع</option><option value="exempt">معفى</option></select>
      · النسبة: <input id="taxRate" type="number" value="15" min="0" step="0.5" style="width:64px"/>%
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="openTab('chatTab', this)">المحادثة</div>
    <div class="tab" onclick="openTab('invoiceTab', this)">الفاتورة / الإيصال</div>
    <div class="tab" onclick="openTab('reportsTab', this)">التقارير</div>
    <div class="tab" onclick="openTab('listsTab', this)">العملاء/الموردون</div>
  </div>

  <div id="chatTab" class="panel">
    <div class="grid">
      <div>
        <div class="phone">
          <div class="header">
            <div>شات محاسبي</div>
            <div class="note"><button class="btn" onclick="seedFullDemo()">تشغيل سيناريو كامل</button></div>
          </div>
          <div id="chat" class="chat"></div>
          <div class="actions">
            <div class="quick" id="quick"></div>
            <div class="input">
              <input id="manual" class="field" placeholder="اكتب ردّك هنا (اختياري)"/>
              <button class="btn" onclick="sendManual()">إرسال</button>
              <button class="btn" onclick="resetFlow()">مسح</button>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="doc-head"><strong>مختصر العملية</strong><span id="flowBadge" class="note">—</span></div>
        <div class="note">ابدأ: بيع / مشتريات / هتدفع-هتحصّل → اختيار جهة → بنود (سعر/كمية/خصم٪/ضريبة٪ لكل بند) → حفظ → طباعة/قيد/تحصيل بفاتورة.</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="quickStart('sale')">🧾 بيع</button>
          <button class="btn" onclick="quickStart('purchase')">🛒 مشتريات</button>
          <button class="btn" onclick="quickStart('cash')">💰 هتدفع/هتحصّل</button>
        </div>
      </div>
    </div>
  </div>

  <div id="invoiceTab" class="panel hidden">
    <div class="doc-head">
      <strong id="docTitle">مستند</strong>
      <div>
        <button class="btn" onclick="window.print()">🖨️ تصدير PDF</button>
        <button class="btn" onclick="toggleJournal()">📒 القيد المحاسبي</button>
      </div>
    </div>
    <table>
      <thead id="docHead"><tr>
        <th>الوصف</th><th>الوحدة</th><th class="num">كمية</th><th class="num">سعر</th><th class="num">خصم٪</th><th class="num">ضريبة٪</th><th class="num">صافي</th><th class="num">ضريبة</th><th class="num">الإجمالي</th>
      </tr></thead>
      <tbody id="docBody"><tr><td class="ghost" colspan="9">— لا توجد بيانات —</td></tr></tbody>
      <tfoot id="docFoot"></tfoot>
    </table>
    <div id="journal" class="panel hidden"></div>
  </div>

  <div id="reportsTab" class="panel hidden">
    <div class="row">
      <span class="btn">كشف حساب</span>
      <select id="partyType"><option value="customer">عميل</option><option value="supplier">مورد</option></select>
      <input id="partyName" placeholder="اسم العميل/المورد" style="width:220px"/>
      <button class="btn" onclick="buildStatement()">عرض</button>
    </div>
    <table>
      <thead><tr><th>التاريخ</th><th>البيان</th><th class="num">مدين</th><th class="num">دائن</th><th class="num">الرصيد</th></tr></thead>
      <tbody id="stBody"><tr><td colspan="5" class="ghost">— اختر جهة واعرض كشف الحساب —</td></tr></tbody>
    </table>

    <div class="panel" style="margin-top:12px">
      <div class="doc-head"><strong>ميزان مراجعة مبسّط</strong></div>
      <table>
        <thead><tr><th>الحساب</th><th class="num">مدين</th><th class="num">دائن</th></tr></thead>
        <tbody id="tbBody"></tbody>
        <tfoot><tr><td>الإجمالي</td><td id="tbDr" class="num">0</td><td id="tbCr" class="num">0</td></tr></tfoot>
      </table>
    </div>
  </div>

  <div id="listsTab" class="panel hidden">
    <div class="grid">
      <div>
        <div class="doc-head"><strong>العملاء — أرصدة</strong></div>
        <table>
          <thead><tr><th>العميل</th><th class="num">إجمالي الفواتير</th><th class="num">التحصيل</th><th class="num">الرصيد</th><th>إجراء</th></tr></thead>
          <tbody id="custBalances"></tbody>
        </table>
      </div>
      <div>
        <div class="doc-head"><strong>الموردون — أرصدة</strong></div>
        <table>
          <thead><tr><th>المورد</th><th class="num">إجمالي المشتريات</th><th class="num">السداد</th><th class="num">الرصيد</th><th>إجراء</th></tr></thead>
          <tbody id="suppBalances"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== أصناف ====== */
const ITEMS = [
  {id:'srv_maint', name:'خدمة صيانة', unit:'ساعة', price:200},
  {id:'oil_box',   name:'زيوت',       unit:'علبة', price:450},
  {id:'paint',     name:'سنفرة ودهان', unit:'سيارة',price:500},
  {id:'leather_4x4',name:'فرش جلد (4×4)', unit:'سيارة', price:1500}
];

/* ====== تخزين محلي ====== */
const DBKEY='cashchat_db_v7';
let DB = loadDB();
function loadDB(){ try{
  const d=JSON.parse(localStorage.getItem(DBKEY))||{};
  d.invoices=d.invoices||[]; d.payments=d.payments||[];
  d.customers=d.customers&&d.customers.length?d.customers:[
    {name:'الشرق للأسمنت'},{name:'العبور للتوريدات'},{name:'العبقري للأثاث'},{name:'العربي للاستيراد'}
  ];
  d.suppliers=d.suppliers&&d.suppliers.length?d.suppliers:[
    {name:'الصيني للتوريدات'},{name:'العالمي للمصاعد'},{name:'السد العالي للأخشاب'},{name:'الفيومي للمأكولات'}
  ];
  return d;
}catch{ return {invoices:[],payments:[],customers:[{name:'الشرق للأسمنت'},{name:'العبور للتوريدات'},{name:'العبقري للأثاث'},{name:'العربي للاستيراد'}],suppliers:[{name:'الصيني للتوريدات'},{name:'العالمي للمصاعد'},{name:'السد العالي للأخشاب'},{name:'الفيومي للمأكولات'}]}; } }
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); renderPartyBalances(); buildTrialBalance(); }

/* ====== أدوات ====== */
const chat=document.getElementById('chat'); const quick=document.getElementById('quick');
const state={mode:null,step:0,payType:null,partyType:null,partyName:'',lines:[],invoiceNo:1001,rcptNo:5001,lastDoc:null,purchaseKind:null};
function fmt(n){return Number(n||0).toLocaleString('ar-EG');}
function today(){return new Date().toLocaleDateString('ar-EG');}
function addBubble(html,who='bot'){const d=document.createElement('div');d.className='bubble '+(who==='me'?'me':'bot');d.innerHTML=html;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function setQuick(btns=[]){quick.innerHTML='';btns.forEach(b=>{const x=document.createElement('button');x.textContent=b.label;x.onclick=b.onClick;quick.appendChild(x);});}
function addQuickHTML(h){quick.innerHTML=h;}
function resetFlow(){chat.innerHTML='';setQuick([]);state.mode=null;state.step=0;state.lines=[];document.getElementById('flowBadge').textContent='—';}
function openTab(id,el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));if(el)el.classList.add('active');['chatTab','invoiceTab','reportsTab','listsTab'].forEach(x=>document.getElementById(x).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function sendManual(){const i=document.getElementById('manual');if(!i.value.trim())return;addBubble(i.value,'me');i.value='';}

/* ====== بدء سريع ====== */
function quickStart(k){resetFlow(); if(k==='sale') return startSale(); if(k==='purchase') return startPurchase(); if(k==='cash') return startCash();}
function startSale(){state.mode='sale';document.getElementById('flowBadge').textContent='بيع';addBubble('هنسجّل **بيع**. اختر طريقة الدفع:');setQuick([{label:'نقدي',onClick:()=>pickPay('cash')},{label:'آجل',onClick:()=>pickPay('credit')}]);}
function startPurchase(){state.mode='purchase';document.getElementById('flowBadge').textContent='مشتريات';addBubble('هنسجّل **مشتريات** — اختر النوع:');setQuick([
  {label:'خامات',onClick:()=>pickItemKind('raw')},{label:'مصروفات تشغيل',onClick:()=>pickItemKind('exp')},{label:'أصول ثابتة',onClick:()=>pickItemKind('asset')}
]);}
function startCash(){state.mode='cash';document.getElementById('flowBadge').textContent='دفعات/تحصيل';addBubble('اختر العملية:');setQuick([{label:'تحصيل من عميل',onClick:()=>cashFlow('recv')},{label:'سداد لمورد',onClick:()=>cashFlow('pay')}]);}

/* ====== بيع ====== */
function pickPay(t){state.payType=t;addBubble(t==='cash'?'بيع نقدي':'بيع آجل','me');state.partyType='customer';askParty();}
function askParty(){
  const list=(state.partyType==='customer'?DB.customers:DB.suppliers).map(x=>x.name);
  const label=state.partyType==='customer'?'اسم العميل؟':'اسم المورد؟';
  addBubble(label);
  const options=['— جديد… —',...list].map(n=>`<option value="${n}">${n}</option>`).join('');
  addQuickHTML(`<select id="partySel">${options}</select> <input id="partyNew" placeholder="اكتب الاسم" class="hidden"/> <button onclick="confirmParty()">اختيار</button>`);
  document.getElementById('partySel').addEventListener('change',e=>{const v=e.target.value;const inp=document.getElementById('partyNew');if(v==='— جديد… —'){inp.classList.remove('hidden');inp.focus();}else inp.classList.add('hidden');});
}
function confirmParty(){
  const sel=document.getElementById('partySel'),inp=document.getElementById('partyNew');
  let name=sel.value==='— جديد… —'?(inp.value||'').trim():sel.value;
  if(!name){alert('اكتب الاسم');return;}
  addBubble(name,'me'); state.partyName=name; ensureParty(state.partyType,name);
  if(state.mode==='cash'){ return askCashAmount(); }
  state.lines=[]; askItem(); // يبدأ البنود مباشرة
}

/* ====== بنود مع خصم/ضريبة لكل بند ====== */
function askItem(){
  const opts = ITEMS.map(it=>`<option value="${it.id}" data-price="${it.price}" data-unit="${it.unit}">${it.name} — ${it.price}/${it.unit}</option>`).join('');
  const gRate= +document.getElementById('taxRate').value||0;
  addBubble('اختر الصنف وحدّد الكمية/السعر/الخصم٪/الضريبة٪ ثم “إضافة”.');
  addQuickHTML(`
    <select id="itemSel">${opts}</select>
    <input id="qty" type="number" min="1" value="1" style="width:70px" title="كمية"/>
    <input id="price" type="number" min="0" value="" style="width:90px" placeholder="سعر"/>
    <input id="disc" type="number" min="0" value="0" style="width:70px" title="خصم٪"/>
    <input id="lineVat" type="number" min="0" value="${gRate}" style="width:80px" title="ضريبة٪"/>
    <button onclick="addLine()">إضافة</button>
    <button onclick="finishLines()">إنهاء البنود</button>
  `);
  const sel=document.getElementById('itemSel'); const price=document.getElementById('price');
  price.value = sel.selectedOptions[0].dataset.price;
  sel.addEventListener('change',()=>{price.value=sel.selectedOptions[0].dataset.price;});
}
function addLine(){
  const sel=document.getElementById('itemSel'); const it=ITEMS.find(x=>x.id===sel.value);
  const q = Math.max(1,+document.getElementById('qty').value||1);
  const p = Math.max(0,+document.getElementById('price').value||it.price);
  const d = Math.max(0,+document.getElementById('disc').value||0);      // خصم٪
  const v = Math.max(0,+document.getElementById('lineVat').value||0);   // ضريبة٪
  const gross = p*q, net = +(gross*(1 - d/100)).toFixed(2);
  const vat   = (document.getElementById('taxMode').value==='taxed')? +(net*v/100).toFixed(2) : 0;
  const total = +(net+vat).toFixed(2);
  state.lines.push({name:it.name, unit:it.unit, qty:q, price:p, disc:d, vatPct:v, net, vat, line:total});
  addBubble(`+ ${it.name} × ${q} ${it.unit} @ ${fmt(p)} - خصم ${d}% + ضريبة ${v}% ⇒ الإجمالي ${fmt(total)}`,'me');
}

/* ====== إنهاء وحفظ ====== */
function finishLines(){
  const net   = state.lines.reduce((s,l)=>s+l.net,0);
  const vat   = state.lines.reduce((s,l)=>s+l.vat,0);
  const total = +(net+vat).toFixed(2);
  state.net=+net.toFixed(2); state.vat=+vat.toFixed(2); state.total=total;
  addBubble(`ملخص: صافي ${fmt(state.net)} + ضريبة ${fmt(state.vat)} = إجمالي <b>${fmt(total)}</b>.`);
  setQuick([{label:'حفظ الفاتورة',onClick:()=> state.mode==='sale' ? saveSale() : finalizePurchase()},
            {label:'إضافة بنود أخرى',onClick:askItem}]);
}
function saveSale(){
  const doc={type:'sale',payType:state.payType,partyType:'customer',partyName:state.partyName,lines:state.lines,subtotal:state.net,vat:state.vat,total:state.total,date:today(),no:'INV-'+(state.invoiceNo++)};
  DB.invoices.push(doc); saveDB(); state.lastDoc=doc;
  addBubble(`تم إصدار فاتورة <b>${doc.no}</b> للعميل ${doc.partyName}.`);
  buildInvoice(doc,'فاتورة بيع'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
  setQuick([
    {label:'تحصيل على هذه الفاتورة',onClick:()=>collectOnInvoice(doc)},
    {label:'اذهب إلى كشف الحساب',onClick:()=>goStatement('customer',state.partyName)},
    {label:'الأرصدة',onClick:()=>openTab('listsTab',document.querySelectorAll('.tab')[3])}
  ]);
}

/* ====== مشتريات ====== */
function pickItemKind(k){ state.purchaseKind=k; addBubble(k==='raw'?'مشتريات خامات':k==='exp'?'مصروفات تشغيل':'شراء أصل ثابت','me'); state.partyType='supplier'; askParty(); }
function finalizePurchase(){
  const doc={type:'purchase',kind:state.purchaseKind,partyType:'supplier',partyName:state.partyName,lines:state.lines,subtotal:state.net,vat:state.vat,total:state.total,date:today(),payType:'credit',no:'PINV-'+(state.invoiceNo++)};
  DB.invoices.push(doc); saveDB(); state.lastDoc=doc;
  addBubble(`تم حفظ فاتورة مشتريات <b>${doc.no}</b> للمورد ${doc.partyName}.`);
  buildInvoice(doc,'فاتورة مشتريات'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
  setQuick([
    {label:'سداد على هذه الفاتورة',onClick:()=>payOnInvoice(doc)},
    {label:'اذهب إلى كشف الحساب',onClick:()=>goStatement('supplier',state.partyName)},
    {label:'الأرصدة',onClick:()=>openTab('listsTab',document.querySelectorAll('.tab')[3])}
  ]);
}

/* ====== تحصيل/سداد مربوط بفاتورة ====== */
function openInvoicesOf(partyType, partyName){
  return DB.invoices.filter(i=>i.partyType===partyType && i.partyName===partyName)
    .map(inv=>{
      const paid = DB.payments.filter(p=>p.invoiceNo===inv.no).reduce((s,p)=>s+p.amount,0);
      const remain = +(inv.total - paid).toFixed(2);
      return {...inv, remain};
    }).filter(i=>i.remain>0);
}
function collectOnInvoice(inv){
  const list = openInvoicesOf('customer', inv.partyName);
  addBubble('اختَر الفاتورة للتحصيل:', 'bot');
  const opts = list.map(i=>`<option value="${i.no}">${i.no} — متبقّي ${fmt(i.remain)}</option>`).join('');
  addQuickHTML(`
    <select id="selInv">${opts||`<option>لا يوجد فواتير مفتوحة</option>`}</select>
    <input id="amt" placeholder="المبلغ" style="width:120px"/>
    <button onclick="postLinked('recv')">تسجيل</button>
  `);
}
function payOnInvoice(inv){
  const list = openInvoicesOf('supplier', inv.partyName);
  addBubble('اختَر الفاتورة للسداد:', 'bot');
  const opts = list.map(i=>`<option value="${i.no}">${i.no} — متبقّي ${fmt(i.remain)}</option>`).join('');
  addQuickHTML(`
    <select id="selInv">${opts||`<option>لا يوجد فواتير مفتوحة</option>`}</select>
    <input id="amt" placeholder="المبلغ" style="width:120px"/>
    <button onclick="postLinked('pay')">تسجيل</button>
  `);
}
function postLinked(dir){
  const invoiceNo = (document.getElementById('selInv')||{}).value;
  const val = +(document.getElementById('amt').value||'0');
  if(!invoiceNo || val<=0){ alert('اختر الفاتورة واكتب مبلغ صحيح'); return; }
  const inv = DB.invoices.find(i=>i.no===invoiceNo);
  DB.payments.push({dir,partyType:inv.partyType,partyName:inv.partyName,amount:val,date:today(),no:'RCPT-'+(state.rcptNo++),invoiceNo});
  saveDB();
  const title = (dir==='recv')?'إيصال تحصيل':'إيصال سداد';
  const desc  = (dir==='recv')?`تحصيل على ${invoiceNo}`:`سداد على ${invoiceNo}`;
  const doc={isReceipt:true,desc,lines:[{name:'دفعة',unit:'',qty:1,price:val,line:val}],subtotal:val,vat:0,total:val,date:today(),no:'RCPT-'+(state.rcptNo-1)};
  addBubble(`تم تسجيل ${dir==='recv'?'تحصيل':'سداد'} بمبلغ ${fmt(val)} على الفاتورة ${invoiceNo}.`);
  buildInvoice(doc,title); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
}

/* ====== تحصيل/سداد عام (لو محتاج) ====== */
function cashFlow(kind){ state.partyType=(kind==='recv')?'customer':'supplier'; addBubble(kind==='recv'?'تحصيل من عميل':'سداد لمورد','me'); askParty(); }
function askCashAmount(){
  addBubble('أدخل المبلغ ثم اضغط تسجيل:'); addQuickHTML(`<input id="amt" placeholder="المبلغ" style="width:130px"/> <button onclick="postAmount()">تسجيل</button>`);
}
function postAmount(){
  const val=+(document.getElementById('amt').value||'0'); if(val<=0){alert('اكتب مبلغ صحيح');return;}
  const dir=(state.partyType==='customer')?'recv':'pay';
  DB.payments.push({dir,partyType:state.partyType,partyName:state.partyName,amount:val,date:today(),no:'RCPT-'+(state.rcptNo++)});
  saveDB();
  const doc={isReceipt:true,desc:(dir==='recv'?'تحصيل':'سداد'),lines:[{name:'دفعة',qty:1,price:val,line:val}],subtotal:val,vat:0,total:val,date:today(),no:'RCPT-'+(state.rcptNo-1)};
  buildInvoice(doc, dir==='recv'?'إيصال تحصيل':'إيصال سداد'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
}

/* ====== المستند + القيد ====== */
let lastBuiltDoc=null,lastBuiltTitle='';
function buildInvoice(doc,title){
  document.getElementById('docTitle').textContent=title+' — '+document.getElementById('company').value;
  const head=document.getElementById('docHead'), body=document.getElementById('docBody'), foot=document.getElementById('docFoot');
  head.innerHTML='<tr><th>الوصف</th><th>الوحدة</th><th class="num">كمية</th><th class="num">سعر</th><th class="num">خصم٪</th><th class="num">ضريبة٪</th><th class="num">صافي</th><th class="num">ضريبة</th><th class="num">الإجمالي</th></tr>'; 
  body.innerHTML='';
  const lines = doc.lines && doc.lines.length ? doc.lines : [{name:doc.desc||'—', unit:'', qty:1, price:doc.total, disc:0, vatPct:0, net:doc.total, vat:0, line:doc.total}];
  lines.forEach(l=>{
    body.insertAdjacentHTML('beforeend', `<tr>
      <td>${l.name}</td><td>${l.unit||'—'}</td>
      <td class="num">${fmt(l.qty||1)}</td><td class="num">${fmt(l.price||0)}</td>
      <td class="num">${fmt(l.disc||0)}</td><td class="num">${fmt(l.vatPct||0)}</td>
      <td class="num">${fmt(l.net||0)}</td><td class="num">${fmt(l.vat||0)}</td><td class="num">${fmt(l.line||0)}</td></tr>`);
  });
  const totals = `
    <tr><td colspan="7"></td><td>الضريبة</td><td class="num">${fmt(doc.vat||0)}</td></tr>
    <tr><td colspan="7"></td><td>الصافي</td><td class="num">${fmt(doc.subtotal||0)}</td></tr>
    <tr><td colspan="7"></td><td><strong>الإجمالي</strong></td><td class="num"><strong>${fmt(doc.total||0)}</strong></td></tr>`;
  foot.innerHTML=totals;
  lastBuiltDoc = doc; lastBuiltTitle=title; renderJournal();
}
function toggleJournal(){ const j=document.getElementById('journal'); j.classList.toggle('hidden'); if(!j.classList.contains('hidden')) renderJournal(); }
function renderJournal(){
  if(!lastBuiltDoc){ document.getElementById('journal').innerHTML=''; return; }
  const d=lastBuiltDoc; let rows=[];
  if(d.isReceipt){
    if((d.desc||'').includes('تحصيل')) rows=[{acc:'الصندوق/البنك',dr:d.total,cr:0},{acc:'العملاء',dr:0,cr:d.total}];
    else rows=[{acc:'الموردون',dr:d.total,cr:0},{acc:'الصندوق/البنك',dr:0,cr:d.total}];
  }else if(d.type==='sale'){
    rows=[{acc:'العملاء',dr:d.total,cr:0},{acc:'المبيعات (صافي)',dr:0,cr:d.subtotal},{acc:'ضريبة مخرجات',dr:0,cr:d.vat}];
  }else if(d.type==='purchase'){
    const cap = d.kind==='asset' ? 'أصول ثابتة' : (d.kind==='exp'?'مصروفات تشغيل':'مشتريات خامات');
    rows=[{acc:cap,dr:d.subtotal,cr:0},{acc:'ضريبة مدخلات',dr:d.vat,cr:0},{acc:'الموردون',dr:0,cr:d.total}];
  }
  document.getElementById('journal').innerHTML = `
    <div class="doc-head"><strong>القيد المحاسبي — ${lastBuiltTitle}</strong></div>
    <table><thead><tr><th>الحساب</th><th class="num">مدين</th><th class="num">دائن</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${r.acc}</td><td class="num">${fmt(r.dr)}</td><td class="num">${fmt(r.cr)}</td></tr>`).join('')}</tbody></table>`;
}

/* ====== تقارير ====== */
function buildStatement(){
  const type=document.getElementById('partyType').value, name=(document.getElementById('partyName').value||'').trim();
  if(!name){alert('اكتب الاسم');return;}
  const tbody=document.getElementById('stBody'); tbody.innerHTML=''; let bal=0;
  DB.invoices.filter(i=>i.partyType===type && i.partyName===name).forEach(i=>{
    const sign=(i.type==='sale')? +1 : -1; bal += sign*i.total;
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${i.date}</td><td>${i.type==='sale'?'فاتورة بيع':'فاتورة مشتريات'} ${i.no}</td><td class="num">${sign>0?fmt(i.total):''}</td><td class="num">${sign<0?fmt(i.total):''}</td><td class="num">${fmt(bal)}</td></tr>`);
  });
  DB.payments.filter(p=>p.partyType===type && p.partyName===name).forEach(p=>{
    const sign=(p.dir==='recv')? -1 : +1; bal += sign*p.amount;
    const link = p.invoiceNo? ` (${p.invoiceNo})` : '';
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${p.date}</td><td>${p.dir==='recv'?'تحصيل':'سداد'} ${p.no}${link}</td><td class="num">${sign>0?fmt(p.amount):''}</td><td class="num">${sign<0?fmt(p.amount):''}</td><td class="num">${fmt(bal)}</td></tr>`);
  });
  if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="5" class="ghost">لا توجد حركات</td></tr>';
}
function buildTrialBalance(){
  let dr=0,cr=0; const rows=[];
  const sales=DB.invoices.filter(i=>i.type==='sale').reduce((s,i)=>s+i.subtotal,0);
  const outVAT=DB.invoices.filter(i=>i.type==='sale').reduce((s,i)=>s+i.vat,0);
  const purchases=DB.invoices.filter(i=>i.type==='purchase' && i.kind!=='exp').reduce((s,i)=>s+i.subtotal,0);
  const expenses=DB.invoices.filter(i=>i.type==='purchase' && i.kind==='exp').reduce((s,i)=>s+i.subtotal,0);
  const inVAT=DB.invoices.filter(i=>i.type==='purchase').reduce((s,i)=>s+i.vat,0);
  const cashIn=DB.payments.filter(p=>p.dir==='recv').reduce((s,p)=>s+p.amount,0);
  const cashOut=DB.payments.filter(p=>p.dir==='pay').reduce((s,p)=>s+p.amount,0);
  rows.push({acc:'المبيعات',dr:0,cr:sales});
  rows.push({acc:'ضريبة مخرجات',dr:0,cr:outVAT});
  rows.push({acc:'مشتريات خامات/أصول',dr:purchases,cr:0});
  rows.push({acc:'مصروفات تشغيل',dr:expenses,cr:0});
  rows.push({acc:'ضريبة مدخلات',dr:inVAT,cr:0});
  rows.push({acc:'الصندوق (تحصيل - سداد)',dr:cashIn,cr:cashOut});
  const tbody=document.getElementById('tbBody'); tbody.innerHTML='';
  rows.forEach(r=>{dr+=r.dr;cr+=r.cr;tbody.insertAdjacentHTML('beforeend', `<tr><td>${r.acc}</td><td class="num">${fmt(r.dr)}</td><td class="num">${fmt(r.cr)}</td></tr>`);});
  document.getElementById('tbDr').textContent=fmt(dr); document.getElementById('tbCr').textContent=fmt(cr);
}

/* ====== أرصدة ====== */
function renderPartyBalances(){
  const C=document.getElementById('custBalances'); const S=document.getElementById('suppBalances');
  C.innerHTML = DB.customers.map(c=>{
    const inv = DB.invoices.filter(i=>i.partyType==='customer' && i.partyName===c.name && i.type==='sale').reduce((s,i)=>s+i.total,0);
    const rec = DB.payments.filter(p=>p.partyType==='customer' && p.partyName===c.name && p.dir==='recv').reduce((s,p)=>s+p.amount,0);
    const bal = +(inv - rec).toFixed(2);
    return `<tr><td>${c.name}</td><td class="num">${fmt(inv)}</td><td class="num">${fmt(rec)}</td><td class="num"><strong>${fmt(bal)}</strong></td>
      <td><button class="btn" onclick="goStatement('customer','${c.name}')">كشف</button></td></tr>`;
  }).join('') || '<tr><td colspan="5" class="ghost">لا يوجد</td></tr>';

  S.innerHTML = DB.suppliers.map(s=>{
    const inv = DB.invoices.filter(i=>i.partyType==='supplier' && i.partyName===s.name && i.type==='purchase').reduce((sum,i)=>sum+i.total,0);
    const pay = DB.payments.filter(p=>p.partyType==='supplier' && p.partyName===s.name && p.dir==='pay').reduce((sum,p)=>sum+p.amount,0);
    const bal = +(inv - pay).toFixed(2);
    return `<tr><td>${s.name}</td><td class="num">${fmt(inv)}</td><td class="num">${fmt(pay)}</td><td class="num"><strong>${fmt(bal)}</strong></td>
      <td><button class="btn" onclick="goStatement('supplier','${s.name}')">كشف</button></td></tr>`;
  }).join('') || '<tr><td colspan="5" class="ghost">لا يوجد</td></tr>';
}
function goStatement(type,name){
  openTab('reportsTab', document.querySelectorAll('.tab')[2]);
  document.getElementById('partyType').value=type;
  document.getElementById('partyName').value=name;
  buildStatement();
}

/* ====== سيناريو كامل ====== */
function seedFullDemo(){
  if(!confirm('سيتم مسح البيانات الحالية وزرع سيناريو جاهز. موافق؟')) return;
  DB={invoices:[],payments:[],customers:[{name:'الشرق للأسمنت'},{name:'العبور للتوريدات'},{name:'العبقري للأثاث'},{name:'العربي للاستيراد'}],
      suppliers:[{name:'الصيني للتوريدات'},{name:'العالمي للمصاعد'},{name:'السد العالي للأخشاب'},{name:'الفيومي للمأكولات'}]};
  const make = (net,name)=>{const r=+document.getElementById('taxRate').value||15;
    const netL=[{name:'خدمة صيانة',unit:'ساعة',qty:10,price:200,disc:0,vatPct:r,net:2000,vat:+(2000*r/100).toFixed(2),line:+(2000*(1+r/100)).toFixed(2)}];
    const vat = netL.reduce((s,l)=>s+l.vat,0); const total = netL.reduce((s,l)=>s+l.line,0);
    DB.invoices.push({type:'sale',partyType:'customer',partyName:name,lines:netL,subtotal:2000,vat,total,date:today(),no:'INV-'+(state.invoiceNo++)});
  };
  make(2000,'الشرق للأسمنت'); make(2000,'العبور للتوريدات');
  DB.payments.push({dir:'recv',partyType:'customer',partyName:'الشرق للأسمنت',amount:500,date:today(),no:'RCPT-'+(state.rcptNo++),invoiceNo:'INV-1001'});
  saveDB(); resetFlow(); openTab('listsTab', document.querySelectorAll('.tab')[3]);
}

/* ====== مساعدة ====== */
function ensureParty(type,name){
  const arr = type==='customer'?DB.customers:DB.suppliers;
  if(!arr.find(x=>x.name===name)) arr.push({name});
  saveDB();
}

/* ====== تهيئة ====== */
document.getElementById('manual').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendManual(); } });
renderPartyBalances(); buildTrialBalance(); resetFlow();
</script>
</body>
</html>
