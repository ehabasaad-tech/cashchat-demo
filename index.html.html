<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>CashChat â€” Ø¨ÙŠØ¹/Ù…Ø´ØªØ±ÙŠØ§Øª + Ø®ØµÙ…/Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯ + ØªØ­ØµÙŠÙ„ Ù…Ø±Ø¨ÙˆØ· Ø¨ÙØ§ØªÙˆØ±Ø©</title>
<style>
:root{--dark:#075e54;--mid:#128c7e;--paper:#e5ddd5}
*{box-sizing:border-box}body{margin:0;background:#0b0b0b;color:#e5e7eb;font-family:Tahoma,system-ui,-apple-system,sans-serif}
.wrap{max-width:1080px;margin:0 auto;padding:12px}
.hero{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.logo{font-weight:800}.logo span{background:#fff;color:#075e54;padding:2px 8px;border-radius:10px;margin:0 4px}
.pill{background:#0f172a;border:1px solid #273046;border-radius:999px;padding:6px 10px}
select,input{background:#0f172a;color:#e5e7eb;border:1px solid #273046;border-radius:8px;padding:4px 6px}
.tabs{display:flex;gap:8px;overflow-x:auto;padding:10px 0}
.tab{padding:10px;border-radius:12px;border:1px solid #2e3441;background:#0f172a;color:#e5e7eb;cursor:pointer;white-space:nowrap}
.tab.active{background:#128c7e;border-color:#128c7e;color:#fff}
.panel{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:12px;margin-top:8px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
/* phone chat */
.phone{width:100%;height:72vh;background:var(--paper);border-radius:18px;border:8px solid #000;box-shadow:0 14px 40px rgba(0,0,0,.35);position:relative;overflow:hidden}
.header{background:var(--dark);color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
.chat{position:absolute;inset:52px 0 170px 0;background:var(--paper);padding:12px;overflow:auto}
.bubble{max-width:85%;padding:10px 12px;margin:6px 10px;border-radius:12px;font-size:15px;box-shadow:0 1px 0 rgba(0,0,0,.05);color:#111}
.bot{background:#ffffff;margin-left:auto;margin-right:10px;border-top-right-radius:4px}
.me{background:#dcf8c6;margin-right:auto;margin-left:10px;border-top-left-radius:4px}
.actions{position:absolute;left:0;right:0;bottom:0;background:#f9fafb;border-top:1px solid #e5e7eb;padding:8px}
.quick{display:flex;gap:8px;overflow-x:auto;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.quick button{flex:0 0 auto;padding:8px 12px;border:1px solid #cbd5e1;background:#ffffff;color:#0b0b0b;border-radius:12px;cursor:pointer}
.quick select,.quick input{background:#fff;color:#111;border:1px solid #cbd5e1;border-radius:10px;padding:6px 8px}
.input{display:flex;gap:8px;align-items:center}
.field{flex:1;border:1px solid #cbd5e1;border-radius:24px;padding:10px 14px;background:#fff;color:#111}
/* docs */
.doc-head{background:#075e54;color:#fff;padding:10px 12px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.btn{background:#0f172a;border:1px solid #273046;color:#e5e7eb;padding:8px 12px;border-radius:12px;cursor:pointer}
.btn.primary{background:#128c7e;border-color:#128c7e}
table{width:100%;border-collapse:collapse}th,td{border:1px solid #2b3242;padding:8px;background:#0f172a}th{background:#0c1220}
td.num,th.num{text-align:left;font-variant-numeric:tabular-nums}
.note{font-size:12px;color:#9aa4b2}.ghost{opacity:.55}.hidden{display:none}
@media print{ body{background:#fff;color:#000}.hero,.tabs,.actions{display:none}.panel{border:0;background:#fff}.doc-head{background:#fff;color:#000;border:0;padding:0}th,td{background:#fff;color:#000;border:1px solid #ccc}}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="logo">Cash<span>Chat</span> â€” <span style="background:#25d366;color:#0b0b0b">SAMPLE</span></div>
    <div class="pill">
      Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©: <input id="company" value="Ø§Ù„Ø¨Ø±ÙƒØ© Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª" style="width:180px"/>
      Â· Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:
      <select id="taxMode"><option value="taxed" selected>Ø®Ø§Ø¶Ø¹</option><option value="exempt">Ù…Ø¹ÙÙ‰</option></select>
      Â· Ø§Ù„Ù†Ø³Ø¨Ø©: <input id="taxRate" type="number" value="15" min="0" step="0.5" style="width:64px"/>%
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="openTab('chatTab', this)">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
    <div class="tab" onclick="openTab('invoiceTab', this)">Ø§Ù„ÙØ§ØªÙˆØ±Ø© / Ø§Ù„Ø¥ÙŠØµØ§Ù„</div>
    <div class="tab" onclick="openTab('reportsTab', this)">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div class="tab" onclick="openTab('listsTab', this)">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡/Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†</div>
  </div>

  <div id="chatTab" class="panel">
    <div class="grid">
      <div>
        <div class="phone">
          <div class="header">
            <div>Ø´Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠ</div>
            <div class="note"><button class="btn" onclick="seedFullDemo()">ØªØ´ØºÙŠÙ„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙƒØ§Ù…Ù„</button></div>
          </div>
          <div id="chat" class="chat"></div>
          <div class="actions">
            <div class="quick" id="quick"></div>
            <div class="input">
              <input id="manual" class="field" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ù‘Ùƒ Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
              <button class="btn" onclick="sendManual()">Ø¥Ø±Ø³Ø§Ù„</button>
              <button class="btn" onclick="resetFlow()">Ù…Ø³Ø­</button>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="doc-head"><strong>Ù…Ø®ØªØµØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</strong><span id="flowBadge" class="note">â€”</span></div>
        <div class="note">Ø§Ø¨Ø¯Ø£: Ø¨ÙŠØ¹ / Ù…Ø´ØªØ±ÙŠØ§Øª / Ù‡ØªØ¯ÙØ¹-Ù‡ØªØ­ØµÙ‘Ù„ â†’ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø© â†’ Ø¨Ù†ÙˆØ¯ (Ø³Ø¹Ø±/ÙƒÙ…ÙŠØ©/Ø®ØµÙ…Ùª/Ø¶Ø±ÙŠØ¨Ø©Ùª Ù„ÙƒÙ„ Ø¨Ù†Ø¯) â†’ Ø­ÙØ¸ â†’ Ø·Ø¨Ø§Ø¹Ø©/Ù‚ÙŠØ¯/ØªØ­ØµÙŠÙ„ Ø¨ÙØ§ØªÙˆØ±Ø©.</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="quickStart('sale')">ğŸ§¾ Ø¨ÙŠØ¹</button>
          <button class="btn" onclick="quickStart('purchase')">ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§Øª</button>
          <button class="btn" onclick="quickStart('cash')">ğŸ’° Ù‡ØªØ¯ÙØ¹/Ù‡ØªØ­ØµÙ‘Ù„</button>
        </div>
      </div>
    </div>
  </div>

  <div id="invoiceTab" class="panel hidden">
    <div class="doc-head">
      <strong id="docTitle">Ù…Ø³ØªÙ†Ø¯</strong>
      <div>
        <button class="btn" onclick="window.print()">ğŸ–¨ï¸ ØªØµØ¯ÙŠØ± PDF</button>
        <button class="btn" onclick="toggleJournal()">ğŸ“’ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</button>
      </div>
    </div>
    <table>
      <thead id="docHead"><tr>
        <th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="num">ÙƒÙ…ÙŠØ©</th><th class="num">Ø³Ø¹Ø±</th><th class="num">Ø®ØµÙ…Ùª</th><th class="num">Ø¶Ø±ÙŠØ¨Ø©Ùª</th><th class="num">ØµØ§ÙÙŠ</th><th class="num">Ø¶Ø±ÙŠØ¨Ø©</th><th class="num">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr></thead>
      <tbody id="docBody"><tr><td class="ghost" colspan="9">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª â€”</td></tr></tbody>
      <tfoot id="docFoot"></tfoot>
    </table>
    <div id="journal" class="panel hidden"></div>
  </div>

  <div id="reportsTab" class="panel hidden">
    <div class="row">
      <span class="btn">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</span>
      <select id="partyType"><option value="customer">Ø¹Ù…ÙŠÙ„</option><option value="supplier">Ù…ÙˆØ±Ø¯</option></select>
      <input id="partyName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯" style="width:220px"/>
      <button class="btn" onclick="buildStatement()">Ø¹Ø±Ø¶</button>
    </div>
    <table>
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th class="num">Ù…Ø¯ÙŠÙ†</th><th class="num">Ø¯Ø§Ø¦Ù†</th><th class="num">Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead>
      <tbody id="stBody"><tr><td colspan="5" class="ghost">â€” Ø§Ø®ØªØ± Ø¬Ù‡Ø© ÙˆØ§Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ â€”</td></tr></tbody>
    </table>

    <div class="panel" style="margin-top:12px">
      <div class="doc-head"><strong>Ù…ÙŠØ²Ø§Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¨Ø³Ù‘Ø·</strong></div>
      <table>
        <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th class="num">Ù…Ø¯ÙŠÙ†</th><th class="num">Ø¯Ø§Ø¦Ù†</th></tr></thead>
        <tbody id="tbBody"></tbody>
        <tfoot><tr><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td id="tbDr" class="num">0</td><td id="tbCr" class="num">0</td></tr></tfoot>
      </table>
    </div>
  </div>

  <div id="listsTab" class="panel hidden">
    <div class="grid">
      <div>
        <div class="doc-head"><strong>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â€” Ø£Ø±ØµØ¯Ø©</strong></div>
        <table>
          <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="num">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th><th class="num">Ø§Ù„ØªØ­ØµÙŠÙ„</th><th class="num">Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody id="custBalances"></tbody>
        </table>
      </div>
      <div>
        <div class="doc-head"><strong>Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† â€” Ø£Ø±ØµØ¯Ø©</strong></div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th class="num">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th><th class="num">Ø§Ù„Ø³Ø¯Ø§Ø¯</th><th class="num">Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody id="suppBalances"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== Ø£ØµÙ†Ø§Ù ====== */
const ITEMS = [
  {id:'srv_maint', name:'Ø®Ø¯Ù…Ø© ØµÙŠØ§Ù†Ø©', unit:'Ø³Ø§Ø¹Ø©', price:200},
  {id:'oil_box',   name:'Ø²ÙŠÙˆØª',       unit:'Ø¹Ù„Ø¨Ø©', price:450},
  {id:'paint',     name:'Ø³Ù†ÙØ±Ø© ÙˆØ¯Ù‡Ø§Ù†', unit:'Ø³ÙŠØ§Ø±Ø©',price:500},
  {id:'leather_4x4',name:'ÙØ±Ø´ Ø¬Ù„Ø¯ (4Ã—4)', unit:'Ø³ÙŠØ§Ø±Ø©', price:1500}
];

/* ====== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ====== */
const DBKEY='cashchat_db_v7';
let DB = loadDB();
function loadDB(){ try{
  const d=JSON.parse(localStorage.getItem(DBKEY))||{};
  d.invoices=d.invoices||[]; d.payments=d.payments||[];
  d.customers=d.customers&&d.customers.length?d.customers:[
    {name:'Ø§Ù„Ø´Ø±Ù‚ Ù„Ù„Ø£Ø³Ù…Ù†Øª'},{name:'Ø§Ù„Ø¹Ø¨ÙˆØ± Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠ Ù„Ù„Ø£Ø«Ø§Ø«'},{name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'}
  ];
  d.suppliers=d.suppliers&&d.suppliers.length?d.suppliers:[
    {name:'Ø§Ù„ØµÙŠÙ†ÙŠ Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù…ØµØ§Ø¹Ø¯'},{name:'Ø§Ù„Ø³Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø£Ø®Ø´Ø§Ø¨'},{name:'Ø§Ù„ÙÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª'}
  ];
  return d;
}catch{ return {invoices:[],payments:[],customers:[{name:'Ø§Ù„Ø´Ø±Ù‚ Ù„Ù„Ø£Ø³Ù…Ù†Øª'},{name:'Ø§Ù„Ø¹Ø¨ÙˆØ± Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠ Ù„Ù„Ø£Ø«Ø§Ø«'},{name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'}],suppliers:[{name:'Ø§Ù„ØµÙŠÙ†ÙŠ Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù…ØµØ§Ø¹Ø¯'},{name:'Ø§Ù„Ø³Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø£Ø®Ø´Ø§Ø¨'},{name:'Ø§Ù„ÙÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª'}]}; } }
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); renderPartyBalances(); buildTrialBalance(); }

/* ====== Ø£Ø¯ÙˆØ§Øª ====== */
const chat=document.getElementById('chat'); const quick=document.getElementById('quick');
const state={mode:null,step:0,payType:null,partyType:null,partyName:'',lines:[],invoiceNo:1001,rcptNo:5001,lastDoc:null,purchaseKind:null};
function fmt(n){return Number(n||0).toLocaleString('ar-EG');}
function today(){return new Date().toLocaleDateString('ar-EG');}
function addBubble(html,who='bot'){const d=document.createElement('div');d.className='bubble '+(who==='me'?'me':'bot');d.innerHTML=html;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function setQuick(btns=[]){quick.innerHTML='';btns.forEach(b=>{const x=document.createElement('button');x.textContent=b.label;x.onclick=b.onClick;quick.appendChild(x);});}
function addQuickHTML(h){quick.innerHTML=h;}
function resetFlow(){chat.innerHTML='';setQuick([]);state.mode=null;state.step=0;state.lines=[];document.getElementById('flowBadge').textContent='â€”';}
function openTab(id,el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));if(el)el.classList.add('active');['chatTab','invoiceTab','reportsTab','listsTab'].forEach(x=>document.getElementById(x).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function sendManual(){const i=document.getElementById('manual');if(!i.value.trim())return;addBubble(i.value,'me');i.value='';}

/* ====== Ø¨Ø¯Ø¡ Ø³Ø±ÙŠØ¹ ====== */
function quickStart(k){resetFlow(); if(k==='sale') return startSale(); if(k==='purchase') return startPurchase(); if(k==='cash') return startCash();}
function startSale(){state.mode='sale';document.getElementById('flowBadge').textContent='Ø¨ÙŠØ¹';addBubble('Ù‡Ù†Ø³Ø¬Ù‘Ù„ **Ø¨ÙŠØ¹**. Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:');setQuick([{label:'Ù†Ù‚Ø¯ÙŠ',onClick:()=>pickPay('cash')},{label:'Ø¢Ø¬Ù„',onClick:()=>pickPay('credit')}]);}
function startPurchase(){state.mode='purchase';document.getElementById('flowBadge').textContent='Ù…Ø´ØªØ±ÙŠØ§Øª';addBubble('Ù‡Ù†Ø³Ø¬Ù‘Ù„ **Ù…Ø´ØªØ±ÙŠØ§Øª** â€” Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:');setQuick([
  {label:'Ø®Ø§Ù…Ø§Øª',onClick:()=>pickItemKind('raw')},{label:'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„',onClick:()=>pickItemKind('exp')},{label:'Ø£ØµÙˆÙ„ Ø«Ø§Ø¨ØªØ©',onClick:()=>pickItemKind('asset')}
]);}
function startCash(){state.mode='cash';document.getElementById('flowBadge').textContent='Ø¯ÙØ¹Ø§Øª/ØªØ­ØµÙŠÙ„';addBubble('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:');setQuick([{label:'ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„',onClick:()=>cashFlow('recv')},{label:'Ø³Ø¯Ø§Ø¯ Ù„Ù…ÙˆØ±Ø¯',onClick:()=>cashFlow('pay')}]);}

/* ====== Ø¨ÙŠØ¹ ====== */
function pickPay(t){state.payType=t;addBubble(t==='cash'?'Ø¨ÙŠØ¹ Ù†Ù‚Ø¯ÙŠ':'Ø¨ÙŠØ¹ Ø¢Ø¬Ù„','me');state.partyType='customer';askParty();}
function askParty(){
  const list=(state.partyType==='customer'?DB.customers:DB.suppliers).map(x=>x.name);
  const label=state.partyType==='customer'?'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ':'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ';
  addBubble(label);
  const options=['â€” Ø¬Ø¯ÙŠØ¯â€¦ â€”',...list].map(n=>`<option value="${n}">${n}</option>`).join('');
  addQuickHTML(`<select id="partySel">${options}</select> <input id="partyNew" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…" class="hidden"/> <button onclick="confirmParty()">Ø§Ø®ØªÙŠØ§Ø±</button>`);
  document.getElementById('partySel').addEventListener('change',e=>{const v=e.target.value;const inp=document.getElementById('partyNew');if(v==='â€” Ø¬Ø¯ÙŠØ¯â€¦ â€”'){inp.classList.remove('hidden');inp.focus();}else inp.classList.add('hidden');});
}
function confirmParty(){
  const sel=document.getElementById('partySel'),inp=document.getElementById('partyNew');
  let name=sel.value==='â€” Ø¬Ø¯ÙŠØ¯â€¦ â€”'?(inp.value||'').trim():sel.value;
  if(!name){alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…');return;}
  addBubble(name,'me'); state.partyName=name; ensureParty(state.partyType,name);
  if(state.mode==='cash'){ return askCashAmount(); }
  state.lines=[]; askItem(); // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
}

/* ====== Ø¨Ù†ÙˆØ¯ Ù…Ø¹ Ø®ØµÙ…/Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯ ====== */
function askItem(){
  const opts = ITEMS.map(it=>`<option value="${it.id}" data-price="${it.price}" data-unit="${it.unit}">${it.name} â€” ${it.price}/${it.unit}</option>`).join('');
  const gRate= +document.getElementById('taxRate').value||0;
  addBubble('Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù ÙˆØ­Ø¯Ù‘Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ø®ØµÙ…Ùª/Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©Ùª Ø«Ù… â€œØ¥Ø¶Ø§ÙØ©â€.');
  addQuickHTML(`
    <select id="itemSel">${opts}</select>
    <input id="qty" type="number" min="1" value="1" style="width:70px" title="ÙƒÙ…ÙŠØ©"/>
    <input id="price" type="number" min="0" value="" style="width:90px" placeholder="Ø³Ø¹Ø±"/>
    <input id="disc" type="number" min="0" value="0" style="width:70px" title="Ø®ØµÙ…Ùª"/>
    <input id="lineVat" type="number" min="0" value="${gRate}" style="width:80px" title="Ø¶Ø±ÙŠØ¨Ø©Ùª"/>
    <button onclick="addLine()">Ø¥Ø¶Ø§ÙØ©</button>
    <button onclick="finishLines()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
  `);
  const sel=document.getElementById('itemSel'); const price=document.getElementById('price');
  price.value = sel.selectedOptions[0].dataset.price;
  sel.addEventListener('change',()=>{price.value=sel.selectedOptions[0].dataset.price;});
}
function addLine(){
  const sel=document.getElementById('itemSel'); const it=ITEMS.find(x=>x.id===sel.value);
  const q = Math.max(1,+document.getElementById('qty').value||1);
  const p = Math.max(0,+document.getElementById('price').value||it.price);
  const d = Math.max(0,+document.getElementById('disc').value||0);      // Ø®ØµÙ…Ùª
  const v = Math.max(0,+document.getElementById('lineVat').value||0);   // Ø¶Ø±ÙŠØ¨Ø©Ùª
  const gross = p*q, net = +(gross*(1 - d/100)).toFixed(2);
  const vat   = (document.getElementById('taxMode').value==='taxed')? +(net*v/100).toFixed(2) : 0;
  const total = +(net+vat).toFixed(2);
  state.lines.push({name:it.name, unit:it.unit, qty:q, price:p, disc:d, vatPct:v, net, vat, line:total});
  addBubble(`+ ${it.name} Ã— ${q} ${it.unit} @ ${fmt(p)} - Ø®ØµÙ… ${d}% + Ø¶Ø±ÙŠØ¨Ø© ${v}% â‡’ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${fmt(total)}`,'me');
}

/* ====== Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­ÙØ¸ ====== */
function finishLines(){
  const net   = state.lines.reduce((s,l)=>s+l.net,0);
  const vat   = state.lines.reduce((s,l)=>s+l.vat,0);
  const total = +(net+vat).toFixed(2);
  state.net=+net.toFixed(2); state.vat=+vat.toFixed(2); state.total=total;
  addBubble(`Ù…Ù„Ø®Øµ: ØµØ§ÙÙŠ ${fmt(state.net)} + Ø¶Ø±ÙŠØ¨Ø© ${fmt(state.vat)} = Ø¥Ø¬Ù…Ø§Ù„ÙŠ <b>${fmt(total)}</b>.`);
  setQuick([{label:'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',onClick:()=> state.mode==='sale' ? saveSale() : finalizePurchase()},
            {label:'Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ø£Ø®Ø±Ù‰',onClick:askItem}]);
}
function saveSale(){
  const doc={type:'sale',payType:state.payType,partyType:'customer',partyName:state.partyName,lines:state.lines,subtotal:state.net,vat:state.vat,total:state.total,date:today(),no:'INV-'+(state.invoiceNo++)};
  DB.invoices.push(doc); saveDB(); state.lastDoc=doc;
  addBubble(`ØªÙ… Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© <b>${doc.no}</b> Ù„Ù„Ø¹Ù…ÙŠÙ„ ${doc.partyName}.`);
  buildInvoice(doc,'ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
  setQuick([
    {label:'ØªØ­ØµÙŠÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',onClick:()=>collectOnInvoice(doc)},
    {label:'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨',onClick:()=>goStatement('customer',state.partyName)},
    {label:'Ø§Ù„Ø£Ø±ØµØ¯Ø©',onClick:()=>openTab('listsTab',document.querySelectorAll('.tab')[3])}
  ]);
}

/* ====== Ù…Ø´ØªØ±ÙŠØ§Øª ====== */
function pickItemKind(k){ state.purchaseKind=k; addBubble(k==='raw'?'Ù…Ø´ØªØ±ÙŠØ§Øª Ø®Ø§Ù…Ø§Øª':k==='exp'?'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„':'Ø´Ø±Ø§Ø¡ Ø£ØµÙ„ Ø«Ø§Ø¨Øª','me'); state.partyType='supplier'; askParty(); }
function finalizePurchase(){
  const doc={type:'purchase',kind:state.purchaseKind,partyType:'supplier',partyName:state.partyName,lines:state.lines,subtotal:state.net,vat:state.vat,total:state.total,date:today(),payType:'credit',no:'PINV-'+(state.invoiceNo++)};
  DB.invoices.push(doc); saveDB(); state.lastDoc=doc;
  addBubble(`ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª <b>${doc.no}</b> Ù„Ù„Ù…ÙˆØ±Ø¯ ${doc.partyName}.`);
  buildInvoice(doc,'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
  setQuick([
    {label:'Ø³Ø¯Ø§Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',onClick:()=>payOnInvoice(doc)},
    {label:'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨',onClick:()=>goStatement('supplier',state.partyName)},
    {label:'Ø§Ù„Ø£Ø±ØµØ¯Ø©',onClick:()=>openTab('listsTab',document.querySelectorAll('.tab')[3])}
  ]);
}

/* ====== ØªØ­ØµÙŠÙ„/Ø³Ø¯Ø§Ø¯ Ù…Ø±Ø¨ÙˆØ· Ø¨ÙØ§ØªÙˆØ±Ø© ====== */
function openInvoicesOf(partyType, partyName){
  return DB.invoices.filter(i=>i.partyType===partyType && i.partyName===partyName)
    .map(inv=>{
      const paid = DB.payments.filter(p=>p.invoiceNo===inv.no).reduce((s,p)=>s+p.amount,0);
      const remain = +(inv.total - paid).toFixed(2);
      return {...inv, remain};
    }).filter(i=>i.remain>0);
}
function collectOnInvoice(inv){
  const list = openInvoicesOf('customer', inv.partyName);
  addBubble('Ø§Ø®ØªÙØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ­ØµÙŠÙ„:', 'bot');
  const opts = list.map(i=>`<option value="${i.no}">${i.no} â€” Ù…ØªØ¨Ù‚Ù‘ÙŠ ${fmt(i.remain)}</option>`).join('');
  addQuickHTML(`
    <select id="selInv">${opts||`<option>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…ÙØªÙˆØ­Ø©</option>`}</select>
    <input id="amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:120px"/>
    <button onclick="postLinked('recv')">ØªØ³Ø¬ÙŠÙ„</button>
  `);
}
function payOnInvoice(inv){
  const list = openInvoicesOf('supplier', inv.partyName);
  addBubble('Ø§Ø®ØªÙØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø³Ø¯Ø§Ø¯:', 'bot');
  const opts = list.map(i=>`<option value="${i.no}">${i.no} â€” Ù…ØªØ¨Ù‚Ù‘ÙŠ ${fmt(i.remain)}</option>`).join('');
  addQuickHTML(`
    <select id="selInv">${opts||`<option>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…ÙØªÙˆØ­Ø©</option>`}</select>
    <input id="amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:120px"/>
    <button onclick="postLinked('pay')">ØªØ³Ø¬ÙŠÙ„</button>
  `);
}
function postLinked(dir){
  const invoiceNo = (document.getElementById('selInv')||{}).value;
  const val = +(document.getElementById('amt').value||'0');
  if(!invoiceNo || val<=0){ alert('Ø§Ø®ØªØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
  const inv = DB.invoices.find(i=>i.no===invoiceNo);
  DB.payments.push({dir,partyType:inv.partyType,partyName:inv.partyName,amount:val,date:today(),no:'RCPT-'+(state.rcptNo++),invoiceNo});
  saveDB();
  const title = (dir==='recv')?'Ø¥ÙŠØµØ§Ù„ ØªØ­ØµÙŠÙ„':'Ø¥ÙŠØµØ§Ù„ Ø³Ø¯Ø§Ø¯';
  const desc  = (dir==='recv')?`ØªØ­ØµÙŠÙ„ Ø¹Ù„Ù‰ ${invoiceNo}`:`Ø³Ø¯Ø§Ø¯ Ø¹Ù„Ù‰ ${invoiceNo}`;
  const doc={isReceipt:true,desc,lines:[{name:'Ø¯ÙØ¹Ø©',unit:'',qty:1,price:val,line:val}],subtotal:val,vat:0,total:val,date:today(),no:'RCPT-'+(state.rcptNo-1)};
  addBubble(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${dir==='recv'?'ØªØ­ØµÙŠÙ„':'Ø³Ø¯Ø§Ø¯'} Ø¨Ù…Ø¨Ù„Øº ${fmt(val)} Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNo}.`);
  buildInvoice(doc,title); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
}

/* ====== ØªØ­ØµÙŠÙ„/Ø³Ø¯Ø§Ø¯ Ø¹Ø§Ù… (Ù„Ùˆ Ù…Ø­ØªØ§Ø¬) ====== */
function cashFlow(kind){ state.partyType=(kind==='recv')?'customer':'supplier'; addBubble(kind==='recv'?'ØªØ­ØµÙŠÙ„ Ù…Ù† Ø¹Ù…ÙŠÙ„':'Ø³Ø¯Ø§Ø¯ Ù„Ù…ÙˆØ±Ø¯','me'); askParty(); }
function askCashAmount(){
  addBubble('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ø¬ÙŠÙ„:'); addQuickHTML(`<input id="amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:130px"/> <button onclick="postAmount()">ØªØ³Ø¬ÙŠÙ„</button>`);
}
function postAmount(){
  const val=+(document.getElementById('amt').value||'0'); if(val<=0){alert('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');return;}
  const dir=(state.partyType==='customer')?'recv':'pay';
  DB.payments.push({dir,partyType:state.partyType,partyName:state.partyName,amount:val,date:today(),no:'RCPT-'+(state.rcptNo++)});
  saveDB();
  const doc={isReceipt:true,desc:(dir==='recv'?'ØªØ­ØµÙŠÙ„':'Ø³Ø¯Ø§Ø¯'),lines:[{name:'Ø¯ÙØ¹Ø©',qty:1,price:val,line:val}],subtotal:val,vat:0,total:val,date:today(),no:'RCPT-'+(state.rcptNo-1)};
  buildInvoice(doc, dir==='recv'?'Ø¥ÙŠØµØ§Ù„ ØªØ­ØµÙŠÙ„':'Ø¥ÙŠØµØ§Ù„ Ø³Ø¯Ø§Ø¯'); openTab('invoiceTab',document.querySelectorAll('.tab')[1]);
}

/* ====== Ø§Ù„Ù…Ø³ØªÙ†Ø¯ + Ø§Ù„Ù‚ÙŠØ¯ ====== */
let lastBuiltDoc=null,lastBuiltTitle='';
function buildInvoice(doc,title){
  document.getElementById('docTitle').textContent=title+' â€” '+document.getElementById('company').value;
  const head=document.getElementById('docHead'), body=document.getElementById('docBody'), foot=document.getElementById('docFoot');
  head.innerHTML='<tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="num">ÙƒÙ…ÙŠØ©</th><th class="num">Ø³Ø¹Ø±</th><th class="num">Ø®ØµÙ…Ùª</th><th class="num">Ø¶Ø±ÙŠØ¨Ø©Ùª</th><th class="num">ØµØ§ÙÙŠ</th><th class="num">Ø¶Ø±ÙŠØ¨Ø©</th><th class="num">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>'; 
  body.innerHTML='';
  const lines = doc.lines && doc.lines.length ? doc.lines : [{name:doc.desc||'â€”', unit:'', qty:1, price:doc.total, disc:0, vatPct:0, net:doc.total, vat:0, line:doc.total}];
  lines.forEach(l=>{
    body.insertAdjacentHTML('beforeend', `<tr>
      <td>${l.name}</td><td>${l.unit||'â€”'}</td>
      <td class="num">${fmt(l.qty||1)}</td><td class="num">${fmt(l.price||0)}</td>
      <td class="num">${fmt(l.disc||0)}</td><td class="num">${fmt(l.vatPct||0)}</td>
      <td class="num">${fmt(l.net||0)}</td><td class="num">${fmt(l.vat||0)}</td><td class="num">${fmt(l.line||0)}</td></tr>`);
  });
  const totals = `
    <tr><td colspan="7"></td><td>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td><td class="num">${fmt(doc.vat||0)}</td></tr>
    <tr><td colspan="7"></td><td>Ø§Ù„ØµØ§ÙÙŠ</td><td class="num">${fmt(doc.subtotal||0)}</td></tr>
    <tr><td colspan="7"></td><td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td><td class="num"><strong>${fmt(doc.total||0)}</strong></td></tr>`;
  foot.innerHTML=totals;
  lastBuiltDoc = doc; lastBuiltTitle=title; renderJournal();
}
function toggleJournal(){ const j=document.getElementById('journal'); j.classList.toggle('hidden'); if(!j.classList.contains('hidden')) renderJournal(); }
function renderJournal(){
  if(!lastBuiltDoc){ document.getElementById('journal').innerHTML=''; return; }
  const d=lastBuiltDoc; let rows=[];
  if(d.isReceipt){
    if((d.desc||'').includes('ØªØ­ØµÙŠÙ„')) rows=[{acc:'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ø¨Ù†Ùƒ',dr:d.total,cr:0},{acc:'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',dr:0,cr:d.total}];
    else rows=[{acc:'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†',dr:d.total,cr:0},{acc:'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚/Ø§Ù„Ø¨Ù†Ùƒ',dr:0,cr:d.total}];
  }else if(d.type==='sale'){
    rows=[{acc:'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',dr:d.total,cr:0},{acc:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ØµØ§ÙÙŠ)',dr:0,cr:d.subtotal},{acc:'Ø¶Ø±ÙŠØ¨Ø© Ù…Ø®Ø±Ø¬Ø§Øª',dr:0,cr:d.vat}];
  }else if(d.type==='purchase'){
    const cap = d.kind==='asset' ? 'Ø£ØµÙˆÙ„ Ø«Ø§Ø¨ØªØ©' : (d.kind==='exp'?'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„':'Ù…Ø´ØªØ±ÙŠØ§Øª Ø®Ø§Ù…Ø§Øª');
    rows=[{acc:cap,dr:d.subtotal,cr:0},{acc:'Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¯Ø®Ù„Ø§Øª',dr:d.vat,cr:0},{acc:'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†',dr:0,cr:d.total}];
  }
  document.getElementById('journal').innerHTML = `
    <div class="doc-head"><strong>Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ â€” ${lastBuiltTitle}</strong></div>
    <table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th class="num">Ù…Ø¯ÙŠÙ†</th><th class="num">Ø¯Ø§Ø¦Ù†</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${r.acc}</td><td class="num">${fmt(r.dr)}</td><td class="num">${fmt(r.cr)}</td></tr>`).join('')}</tbody></table>`;
}

/* ====== ØªÙ‚Ø§Ø±ÙŠØ± ====== */
function buildStatement(){
  const type=document.getElementById('partyType').value, name=(document.getElementById('partyName').value||'').trim();
  if(!name){alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…');return;}
  const tbody=document.getElementById('stBody'); tbody.innerHTML=''; let bal=0;
  DB.invoices.filter(i=>i.partyType===type && i.partyName===name).forEach(i=>{
    const sign=(i.type==='sale')? +1 : -1; bal += sign*i.total;
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${i.date}</td><td>${i.type==='sale'?'ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹':'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª'} ${i.no}</td><td class="num">${sign>0?fmt(i.total):''}</td><td class="num">${sign<0?fmt(i.total):''}</td><td class="num">${fmt(bal)}</td></tr>`);
  });
  DB.payments.filter(p=>p.partyType===type && p.partyName===name).forEach(p=>{
    const sign=(p.dir==='recv')? -1 : +1; bal += sign*p.amount;
    const link = p.invoiceNo? ` (${p.invoiceNo})` : '';
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${p.date}</td><td>${p.dir==='recv'?'ØªØ­ØµÙŠÙ„':'Ø³Ø¯Ø§Ø¯'} ${p.no}${link}</td><td class="num">${sign>0?fmt(p.amount):''}</td><td class="num">${sign<0?fmt(p.amount):''}</td><td class="num">${fmt(bal)}</td></tr>`);
  });
  if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="5" class="ghost">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>';
}
function buildTrialBalance(){
  let dr=0,cr=0; const rows=[];
  const sales=DB.invoices.filter(i=>i.type==='sale').reduce((s,i)=>s+i.subtotal,0);
  const outVAT=DB.invoices.filter(i=>i.type==='sale').reduce((s,i)=>s+i.vat,0);
  const purchases=DB.invoices.filter(i=>i.type==='purchase' && i.kind!=='exp').reduce((s,i)=>s+i.subtotal,0);
  const expenses=DB.invoices.filter(i=>i.type==='purchase' && i.kind==='exp').reduce((s,i)=>s+i.subtotal,0);
  const inVAT=DB.invoices.filter(i=>i.type==='purchase').reduce((s,i)=>s+i.vat,0);
  const cashIn=DB.payments.filter(p=>p.dir==='recv').reduce((s,p)=>s+p.amount,0);
  const cashOut=DB.payments.filter(p=>p.dir==='pay').reduce((s,p)=>s+p.amount,0);
  rows.push({acc:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',dr:0,cr:sales});
  rows.push({acc:'Ø¶Ø±ÙŠØ¨Ø© Ù…Ø®Ø±Ø¬Ø§Øª',dr:0,cr:outVAT});
  rows.push({acc:'Ù…Ø´ØªØ±ÙŠØ§Øª Ø®Ø§Ù…Ø§Øª/Ø£ØµÙˆÙ„',dr:purchases,cr:0});
  rows.push({acc:'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„',dr:expenses,cr:0});
  rows.push({acc:'Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¯Ø®Ù„Ø§Øª',dr:inVAT,cr:0});
  rows.push({acc:'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (ØªØ­ØµÙŠÙ„ - Ø³Ø¯Ø§Ø¯)',dr:cashIn,cr:cashOut});
  const tbody=document.getElementById('tbBody'); tbody.innerHTML='';
  rows.forEach(r=>{dr+=r.dr;cr+=r.cr;tbody.insertAdjacentHTML('beforeend', `<tr><td>${r.acc}</td><td class="num">${fmt(r.dr)}</td><td class="num">${fmt(r.cr)}</td></tr>`);});
  document.getElementById('tbDr').textContent=fmt(dr); document.getElementById('tbCr').textContent=fmt(cr);
}

/* ====== Ø£Ø±ØµØ¯Ø© ====== */
function renderPartyBalances(){
  const C=document.getElementById('custBalances'); const S=document.getElementById('suppBalances');
  C.innerHTML = DB.customers.map(c=>{
    const inv = DB.invoices.filter(i=>i.partyType==='customer' && i.partyName===c.name && i.type==='sale').reduce((s,i)=>s+i.total,0);
    const rec = DB.payments.filter(p=>p.partyType==='customer' && p.partyName===c.name && p.dir==='recv').reduce((s,p)=>s+p.amount,0);
    const bal = +(inv - rec).toFixed(2);
    return `<tr><td>${c.name}</td><td class="num">${fmt(inv)}</td><td class="num">${fmt(rec)}</td><td class="num"><strong>${fmt(bal)}</strong></td>
      <td><button class="btn" onclick="goStatement('customer','${c.name}')">ÙƒØ´Ù</button></td></tr>`;
  }).join('') || '<tr><td colspan="5" class="ghost">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>';

  S.innerHTML = DB.suppliers.map(s=>{
    const inv = DB.invoices.filter(i=>i.partyType==='supplier' && i.partyName===s.name && i.type==='purchase').reduce((sum,i)=>sum+i.total,0);
    const pay = DB.payments.filter(p=>p.partyType==='supplier' && p.partyName===s.name && p.dir==='pay').reduce((sum,p)=>sum+p.amount,0);
    const bal = +(inv - pay).toFixed(2);
    return `<tr><td>${s.name}</td><td class="num">${fmt(inv)}</td><td class="num">${fmt(pay)}</td><td class="num"><strong>${fmt(bal)}</strong></td>
      <td><button class="btn" onclick="goStatement('supplier','${s.name}')">ÙƒØ´Ù</button></td></tr>`;
  }).join('') || '<tr><td colspan="5" class="ghost">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>';
}
function goStatement(type,name){
  openTab('reportsTab', document.querySelectorAll('.tab')[2]);
  document.getElementById('partyType').value=type;
  document.getElementById('partyName').value=name;
  buildStatement();
}

/* ====== Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙƒØ§Ù…Ù„ ====== */
function seedFullDemo(){
  if(!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ²Ø±Ø¹ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¬Ø§Ù‡Ø². Ù…ÙˆØ§ÙÙ‚ØŸ')) return;
  DB={invoices:[],payments:[],customers:[{name:'Ø§Ù„Ø´Ø±Ù‚ Ù„Ù„Ø£Ø³Ù…Ù†Øª'},{name:'Ø§Ù„Ø¹Ø¨ÙˆØ± Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠ Ù„Ù„Ø£Ø«Ø§Ø«'},{name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'}],
      suppliers:[{name:'Ø§Ù„ØµÙŠÙ†ÙŠ Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª'},{name:'Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù…ØµØ§Ø¹Ø¯'},{name:'Ø§Ù„Ø³Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø£Ø®Ø´Ø§Ø¨'},{name:'Ø§Ù„ÙÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª'}]};
  const make = (net,name)=>{const r=+document.getElementById('taxRate').value||15;
    const netL=[{name:'Ø®Ø¯Ù…Ø© ØµÙŠØ§Ù†Ø©',unit:'Ø³Ø§Ø¹Ø©',qty:10,price:200,disc:0,vatPct:r,net:2000,vat:+(2000*r/100).toFixed(2),line:+(2000*(1+r/100)).toFixed(2)}];
    const vat = netL.reduce((s,l)=>s+l.vat,0); const total = netL.reduce((s,l)=>s+l.line,0);
    DB.invoices.push({type:'sale',partyType:'customer',partyName:name,lines:netL,subtotal:2000,vat,total,date:today(),no:'INV-'+(state.invoiceNo++)});
  };
  make(2000,'Ø§Ù„Ø´Ø±Ù‚ Ù„Ù„Ø£Ø³Ù…Ù†Øª'); make(2000,'Ø§Ù„Ø¹Ø¨ÙˆØ± Ù„Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª');
  DB.payments.push({dir:'recv',partyType:'customer',partyName:'Ø§Ù„Ø´Ø±Ù‚ Ù„Ù„Ø£Ø³Ù…Ù†Øª',amount:500,date:today(),no:'RCPT-'+(state.rcptNo++),invoiceNo:'INV-1001'});
  saveDB(); resetFlow(); openTab('listsTab', document.querySelectorAll('.tab')[3]);
}

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø© ====== */
function ensureParty(type,name){
  const arr = type==='customer'?DB.customers:DB.suppliers;
  if(!arr.find(x=>x.name===name)) arr.push({name});
  saveDB();
}

/* ====== ØªÙ‡ÙŠØ¦Ø© ====== */
document.getElementById('manual').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendManual(); } });
renderPartyBalances(); buildTrialBalance(); resetFlow();
</script>
</body>
</html>
