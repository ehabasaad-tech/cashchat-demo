<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CashChat — ديمو سريع (ملف واحد)</title>
<meta name="description" content="ديمو تفاعلي سريع لعمليات بيع/مشتريات/تحصيل/سداد مع حفظ محلي، شريط عائم لإضافة/إنهاء البنود، وحل لمشكلة الكيبورد على الموبايل.">

<style>
  :root{--bg:#0b1220;--panel:#0f172a;--line:#1e293b;--ink:#e6edf3;--mut:#9fb4c9;--pri:#0ea5e9;--ok:#22c55e;--danger:#ef4444;--vh:1vh}
  @supports (height:1dvh){ :root{--vh:1dvh} }

  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:#93c5fd;text-decoration:none}
  input,select,textarea{font-size:16px} /* لمنع Zoom iOS */

  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:#16a34a;color:#052e2b;font-weight:800;display:flex;align-items:center;justify-content:center}
  .wrap{max-width:960px;margin:auto;padding:12px}
  .cta{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:10px 12px;border:0;border-radius:10px;cursor:pointer}
  .btn-pri{background:var(--ok);color:#04200f;font-weight:800}
  .btn-ghost{background:var(--panel);color:#cfe7ff;border:1px solid #28405c}
  .btn-danger{background:var(--danger);color:#fff}

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .k{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .k b{display:block;font-size:12px;color:var(--mut)}
  .k big{display:block;font-size:20px;margin-top:4px}

  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  ul{list-style:none;padding:0;margin:8px 0 0;max-height:240px;overflow:auto}
  li{display:flex;justify-content:space-between;gap:8px;border-bottom:1px dashed var(--line);padding:6px 4px}
  .pill{background:#0ea5e922;border:1px solid var(--pri);border-radius:999px;padding:2px 8px;font-size:12px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* Dock & Sheet */
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  @media (max-width:820px){
    #dock{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--line);padding:10px;display:flex;gap:8px;z-index:20}
    #dock button{flex:1;padding:12px;border:0;border-radius:12px;background:var(--pri);color:#021018;font-weight:800}
    #dock button.secondary{background:#0f172a;color:#cfe7ff;border:1px solid #28405c}

    #sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--bg);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -10px 40px #000a;padding:12px;transition:bottom .25s;z-index:30;max-height:calc(100*var(--vh) - 110px);overflow:auto;padding-bottom:env(safe-area-inset-bottom)}
    #sheet.open{bottom:0}
  }

  /* نشاط اليوم */
  #todayPanel{position:fixed;right:12px;top:60px;width:320px;max-width:90vw;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;display:none;z-index:25}
  #todayPanel.open{display:block}

  /* شريط عائم لإضافة/إنهاء البنود — يطلع فوق الكيبورد */
  @media (max-width: 820px){
    #miniItemsBar{
      position:fixed; left:10px; right:10px; bottom:78px;
      display:flex; gap:8px; z-index:9999;
      background:#0f172a; border:1px solid #1e293b; padding:8px;
      border-radius:14px; box-shadow:0 -8px 28px #0008;
      padding-bottom:calc(env(safe-area-inset-bottom) + 8px);
      transform:translateY(0); transition:transform .15s ease;
    }
    #miniItemsBar button{flex:1;padding:12px;border:0;border-radius:12px;font-weight:800}
    #btnAddLine{background:#0ea5e9;color:#021018}
    #btnFinishLines{background:#22c55e;color:#04200f}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">💬$</div>
    <div>
      <div style="font-weight:800">CashChat</div>
      <small style="color:var(--mut)">ديمو تفاعلي — يحفظ محليًا فقط</small>
    </div>
  </div>
  <div class="cta">
    <a class="btn btn-ghost" href="https://wa.me/201000000000" target="_blank" rel="noopener">واتساب</a>
    <button id="btnVideo" class="btn btn-ghost">🎥 فتح الفيديو</button>
    <button id="btnToday" class="btn btn-ghost">📈 نشاط اليوم</button>
  </div>
</header>

<div class="wrap">
  <!-- KPIs -->
  <div class="kpis">
    <div class="k"><b>المبيعات</b><big id="k-sales">0</big></div>
    <div class="k"><b>مشتريات/مصروف</b><big id="k-exp">0</big></div>
    <div class="k"><b>صافي الربح</b><big id="k-profit">0</big></div>
  </div>

  <!-- لوح نشاط اليوم -->
  <div id="todayPanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <b>نشاط اليوم</b>
      <button id="closeToday" class="btn btn-ghost">إغلاق</button>
    </div>
    <ul id="todayList" style="max-height:300px;overflow:auto;margin-top:8px"></ul>
  </div>

  <!-- القوائم -->
  <div class="grid">
    <div class="card">
      <b>العملاء</b>
      <ul id="lstC"></ul>
      <div class="actions"><button id="addC" class="btn btn-ghost">+ عميل سريع</button></div>
    </div>
    <div class="card">
      <b>الأصناف/الخدمات</b>
      <ul id="lstI"></ul>
      <div class="actions"><button id="addI" class="btn btn-ghost">+ صنف/خدمة سريعة</button></div>
    </div>
    <div class="card">
      <b>فواتير</b>
      <ul id="lstV"></ul>
    </div>
  </div>

  <div class="actions" style="margin-top:12px">
    <button id="export" class="btn btn-ghost">تصدير JSON</button>
    <button id="clear" class="btn btn-danger">مسح البيانات المحلية</button>
  </div>
  <small style="color:var(--mut)">⚠️ هذا ديمو محلي (بدون سحابة). للنسخة السحابية جرّب لاحقًا Firebase.</small>
</div>

<!-- شريط سفلي للموبايل -->
<nav id="dock">
  <button data-op="sale">بيع</button>
  <button class="secondary" data-op="purchase">مشتريات</button>
  <button class="secondary" data-op="receipt">تحصيل</button>
  <button class="secondary" data-op="payment">سداد</button>
</nav>

<!-- Bottom Sheet -->
<div id="sheet" aria-hidden="true">
  <div style="height:4px;width:48px;background:#28405c;border-radius:999px;margin:6px auto"></div>
  <div class="card">
    <b id="title">عملية جديدة</b>
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:6px">
      <input id="party" placeholder="عميل/مورد (الاسم أو الكود)">
      <input id="date" type="date">
      <input id="ref"  placeholder="مرجع/ملاحظة (اختياري)">
    </div>

    <div id="saleFields" class="card" style="margin-top:10px">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <input id="item"  placeholder="الصنف/الخدمة">
        <input id="qty"   type="number" step="1" min="1" value="1" placeholder="الكمية">
        <input id="price" type="number" step="0.01" placeholder="السعر">
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:8px">
        <input id="disc" type="number" step="0.01" placeholder="خصم">
        <input id="tax"  type="number" step="0.01" placeholder="ضريبة %">
        <input id="total" type="number" step="0.01" placeholder="الإجمالي" readonly>
      </div>
    </div>

    <div id="moneyFields" class="card" style="display:none;margin-top:10px">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <input id="amount" type="number" step="0.01" placeholder="المبلغ">
        <select id="method">
          <option value="cash">نقدي</option>
          <option value="bank">شيك/تحويل</option>
        </select>
        <input id="bank" placeholder="اسم البنك/المرجع (اختياري)">
      </div>
    </div>

    <div class="actions">
      <button id="save" class="btn btn-pri">حفظ</button>
      <button id="close" class="btn btn-ghost">إغلاق</button>
    </div>
  </div>
</div>

<!-- شريط عائم لإضافة/إنهاء البنود -->
<div id="miniItemsBar" hidden>
  <button id="btnAddLine">+ إضافة بند</button>
  <button id="btnFinishLines">إنهاء البنود</button>
</div>

<script>
/* ========= تخزين محلي ========= */
const LS={C:'cc_demo_customers',I:'cc_demo_items',V:'cc_demo_invoices',OPS:'cc_demo_ops'};
const get=(k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const fmt=(n)=>Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});

/* Seed أول مرة */
(function(){
  if(get(LS.C).length) return;
  set(LS.C,[{id:1,name:'SAMI',code:'C001'},{id:2,name:'FAMILY',code:'C002'}]);
  set(LS.I,[{id:1,name:'فلتر زيت',price:180,type:'مواد'},{id:2,name:'طباعة ليزر',price:100,type:'خدمة'}]);
  set(LS.V,[{id:1,number:'INV-1001',customer:'C001',total:360,kind:'sale'}]);
  set(LS.OPS,[]);
})();

/* مراجع */
const $=(s)=>document.querySelector(s);
const listC=$('#lstC'), listI=$('#lstI'), listV=$('#lstV');
const kSales=$('#k-sales'), kExp=$('#k-exp'), kProfit=$('#k-profit');
const todayPanel=$('#todayPanel'), todayList=$('#todayList');

/* رسم */
function render(){
  const C=get(LS.C), I=get(LS.I), V=get(LS.V);
  listC.innerHTML=''; C.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${c.name} <span class="pill">${c.code||''}</span></span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='حذف';
    del.onclick=()=>{ set(LS.C,C.filter(x=>x.id!==c.id)); render(); };
    li.appendChild(del); listC.appendChild(li);
  });

  listI.innerHTML=''; I.forEach(i=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${i.name} — ${fmt(i.price)} <span class="pill">${i.type||''}</span></span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='حذف';
    del.onclick=()=>{ set(LS.I,I.filter(x=>x.id!==i.id)); render(); };
    li.appendChild(del); listI.appendChild(li);
  });

  listV.innerHTML=''; V.forEach(v=>{
    const li=document.createElement('li');
    const kind=v.kind==='purchase'?'(شراء)':v.kind==='receipt'?'(تحصيل)':v.kind==='payment'?'(سداد)':'';
    li.innerHTML=`<span>${v.number||'—'} ${kind} — عميل: ${v.customer||'—'} — ${fmt(v.total)}</span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='حذف';
    del.onclick=()=>{ set(LS.V,V.filter(x=>x.id!==v.id)); render(); };
    li.appendChild(del); listV.appendChild(li);
  });

  const sales   = V.filter(v=>v.kind==='sale' || !v.kind).reduce((s,v)=>s+Number(v.total||0),0);
  const buys    = V.filter(v=>v.kind==='purchase').reduce((s,v)=>s+Number(v.total||0),0);
  const expense = I.filter(x=>x.type==='مصروف').reduce((s,x)=>s+Number(x.price||0),0);
  kSales.textContent=fmt(sales);
  kExp.textContent  =fmt(buys + expense);
  kProfit.textContent=fmt(sales - (buys+expense));
}
render();

/* أزرار أعلى */
$('#btnVideo').onclick=()=>window.open('https://ehabasaad-tech.github.io/cashchat-demo/','_blank');
$('#btnToday').onclick=()=>{fillToday();todayPanel.classList.add('open');};
$('#closeToday').onclick=()=>todayPanel.classList.remove('open');

/* تصدير/مسح */
$('#export').onclick=()=>{
  const data={customers:get(LS.C),items:get(LS.I),invoices:get(LS.V),ops:get(LS.OPS)};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cashchat-demo-local.json'; a.click();
  URL.revokeObjectURL(a.href);
};
$('#clear').onclick=()=>{
  if(confirm('مسح كل البيانات المحلية؟')){ Object.values(LS).forEach(k=>localStorage.removeItem(k)); render(); todayPanel.classList.remove('open'); }
};

/* إضافة سريعة */
$('#addC').onclick=()=>{
  const name=prompt('اسم العميل؟'); if(!name) return;
  const code=prompt('كود العميل؟ (اتركه فاضي للتوليد)')||genCode('C',LS.C,'code');
  const arr=get(LS.C); arr.push({id:Date.now(),name,code}); set(LS.C,arr); render();
};
$('#addI').onclick=()=>{
  const name=prompt('اسم الصنف/الخدمة؟'); if(!name) return;
  const price=Number(prompt('السعر الافتراضي؟')||0);
  const type=prompt('النوع: مواد/مصروف/أصل/خدمة','مواد')||'مواد';
  const arr=get(LS.I); arr.push({id:Date.now(),name,price,type}); set(LS.I,arr); render();
};
function genCode(prefix,key,field){ const arr=get(key); const n=arr.filter(x=>(x[field]||'').startsWith(prefix)).length+1; return `${prefix}${String(n).padStart(3,'0')}`; }

/* Dock & Sheet */
const dock=document.getElementById('dock'), sheet=document.getElementById('sheet');
const F={title:$('#title'),party:$('#party'),date:$('#date'),ref:$('#ref'),
item:$('#item'),qty:$('#qty'),price:$('#price'),disc:$('#disc'),tax:$('#tax'),total:$('#total'),
amount:$('#amount'),method:$('#method'),bank:$('#bank'),
saleBox:$('#saleFields'),moneyBox:$('#moneyFields')};
F.date.valueAsDate=new Date(); F.tax.value=15;
['qty','price','disc','tax'].forEach(id=>F[id].addEventListener('input',calcTotal));

let op='sale';
dock.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>openSheet(b.dataset.op)));
$('#close').onclick=()=>sheet.classList.remove('open');
$('#save').onclick=saveOp;

function openSheet(kind){
  op=kind; sheet.classList.add('open');
  F.party.value=''; F.ref.value=''; F.item.value=''; F.qty.value=1; F.price.value=''; F.disc.value=''; F.total.value='';
  F.amount.value=''; F.method.value='cash'; F.bank.value='';
  if(op==='sale'||op==='purchase'){ F.title.textContent=(op==='sale'?'بيع':'مشتريات'); F.saleBox.style.display='block'; F.moneyBox.style.display='none'; calcTotal(); setTimeout(()=>F.item.focus(),50); }
  else { F.title.textContent=(op==='receipt'?'تحصيل':'سداد'); F.saleBox.style.display='none'; F.moneyBox.style.display='block'; setTimeout(()=>F.amount.focus(),50); }
}
function calcTotal(){
  const q=Number(F.qty.value||0), p=Number(F.price.value||0), d=Number(F.disc.value||0), t=Number(F.tax.value||0);
  const sub=Math.max(q*p - d,0); F.total.value=(Math.round((sub + sub*t/100)*100)/100);
}
function toast(m){const t=document.createElement('div');t.textContent=m;t.style.cssText='position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#22c55e;color:#03220e;padding:10px 14px;border-radius:10px;font-weight:800;z-index:40';document.body.appendChild(t);setTimeout(()=>t.remove(),1400);}

function saveOp(){
  const ts=Date.now(), today = new Date().toISOString().slice(0,10);
  if(op==='sale'||op==='purchase'){
    if(!F.item.value || !F.price.value){ alert('اكتب الصنف والسعر'); return; }
    const v=get(LS.V);
    const invNo = (op==='sale'?'INV':'PUR') + '-' + ts.toString().slice(-4);
    const total = Number(F.total.value||0);
    v.push({id:ts,number:invNo,customer:(F.party.value||'C001'),total,kind:op,date:today,note:F.ref.value});
    set(LS.V,v);
    // أضف الصنف إن كان جديدًا
    const I=get(LS.I);
    if(F.item.value && !I.some(x=>x.name===F.item.value)){
      I.push({id:ts,name:F.item.value,price:Number(F.price.value||0),type:(op==='purchase'?'مواد':'خدمة')});
      set(LS.I,I);
    }
    pushOp({ts,kind:op,title:(op==='sale'?'بيع':'مشتريات'),amount:total});
  } else {
    const amount = Number(F.amount.value||0);
    if(!amount){ alert('اكتب المبلغ'); return; }
    if(op==='receipt'){
      const v=get(LS.V); v.push({id:ts,number:'RCPT-'+ts.toString().slice(-4),customer:(F.party.value||'C001'),total:amount,kind:'receipt',date:today,note:F.ref.value}); set(LS.V,v);
      pushOp({ts,kind:'receipt',title:'تحصيل',amount});
    }else{
      const I=get(LS.I); I.push({id:ts,name:'سداد',price:amount,type:'مصروف'}); set(LS.I,I);
      pushOp({ts,kind:'payment',title:'سداد',amount});
    }
  }
  sheet.classList.remove('open'); render(); toast('تم الحفظ محليًا');
}
function pushOp(op){ const ops=get(LS.OPS); ops.push(op); set(LS.OPS,ops); }
function fillToday(){
  const ops=get(LS.OPS);
  const s=new Date(); s.setHours(0,0,0,0);
  const e=new Date(); e.setHours(23,59,59,999);
  const arr=ops.filter(o=>o.ts>=s.getTime() && o.ts<=e.getTime()).sort((a,b)=>b.ts-a.ts);
  todayList.innerHTML = arr.length ? arr.map(o=>`<li><span>${o.title}</span><span>${fmt(o.amount)}</span></li>`).join('') : '<li style="opacity:.75">لا يوجد نشاط اليوم بعد</li>';
}

/* ======== الشريط العائم + حل الكيبورد ======== */
(function(){
  const isMobile = matchMedia('(max-width:820px)').matches;
  const bar = document.getElementById('miniItemsBar');
  if(!isMobile || !bar) return;

  // إظهار الشريط
  bar.hidden = false;

  // محاولة معرفة كونتينر البنود (اختياري)
  const candidates=['#linesTable','.lines','.items-area','.invoice-lines','table.lines'];
  let lineContainer=null; for(const s of candidates){ const el=document.querySelector(s); if(el){ lineContainer=el; break; } }
  const finishBtn=document.getElementById('btnFinishLines');
  const addBtn=document.getElementById('btnAddLine');

  const hasLines=()=>{
    if(!lineContainer) return true;
    const rows=lineContainer.querySelectorAll('tr[data-line], tr.line, .line, .row-line');
    return rows.length>0;
  };
  function updateFinish(){ finishBtn.disabled=!hasLines(); finishBtn.style.opacity=finishBtn.disabled?.6:1; }
  updateFinish(); if(lineContainer){ new MutationObserver(updateFinish).observe(lineContainer,{childList:true,subtree:true}); }

  // ربط الأزرار: نجرب دوالك، وإلا نفتح الـSheet/نرسل Events
  addBtn.onclick=()=>{
    if(typeof window.addLine==='function'){ window.addLine(); updateFinish(); return; }
    if(typeof window.addRow ==='function'){ window.addRow();  updateFinish(); return; }
    // في الديمو: افتح Sheet بيع بسرعة
    if(sheet.classList.contains('open')===false) openSheet('sale'); else { /* لو مفتوح اعتبرها بند جديد */ }
    // حدث عام يمكن سماعه
    window.dispatchEvent(new CustomEvent('cashchat:add-line'));
    updateFinish();
  };
  finishBtn.onclick=()=>{
    if(typeof window.finishLines==='function'){ window.finishLines(); return; }
    if(typeof window.endItems   ==='function'){ window.endItems();    return; }
    // في الديمو: لو Sheet مفتوح ومعبّي إجمالي، احفظ
    if(sheet.classList.contains('open') && (op==='sale'||op==='purchase') && Number(F.total.value||0)>0){
      saveOp();
    }else{
      window.dispatchEvent(new CustomEvent('cashchat:finish-lines'));
      toast('تم إنهاء البنود (ديمو)');
    }
  };

  // حل الكيبورد: visualViewport + --vh + رفع الشريط والـDock/Sheet
  const dock=document.getElementById('dock');
  function applyViewportFix(){
    const vh=(window.visualViewport? visualViewport.height : innerHeight)/100;
    document.documentElement.style.setProperty('--vh',vh+'px');
    if(!window.visualViewport) return;
    const kb = Math.max(0, innerHeight - visualViewport.height);
    bar.style.transform = kb ? `translateY(-${kb}px)` : 'translateY(0)';
    if(sheet){
      sheet.style.paddingBottom = `calc(${kb}px + env(safe-area-inset-bottom))`;
      sheet.style.maxHeight = `calc(100 * var(--vh) - 110px)`;
    }
    if(dock) dock.style.transform = kb ? `translateY(-${kb}px)` : 'translateY(0)';
  }
  if(window.visualViewport){
    visualViewport.addEventListener('resize',applyViewportFix);
    visualViewport.addEventListener('scroll',applyViewportFix);
  }
  applyViewportFix();

  // تأكيد ظهور الحقل في منتصف الشاشة عند الكتابة
  document.addEventListener('focusin',(e)=>{
    const t=e.target; const tag=(t.tagName||'').toLowerCase();
    if(tag==='input'||tag==='select'||tag==='textarea'){
      setTimeout(()=>{ try{ t.scrollIntoView({block:'center',behavior:'smooth'});}catch{} },80);
    }
  });

  // لو فيه Dock سفلي قديم وبدون visualViewport
  const extraBottom=document.querySelector('#dock,.mobile-dock,.bottom-bar');
  if(extraBottom && !window.visualViewport){
    bar.style.bottom=(extraBottom.offsetHeight+12)+'px';
  }
})();
</script>
</body>
</html>
