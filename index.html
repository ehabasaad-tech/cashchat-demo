<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CashChat — Easy / Pro (Mobile-First)</title>
<style>
:root{--head-h:40px;--actbar-h:52px;--input-h:136px}
*{box-sizing:border-box}body{margin:0;background:#0b0b0b;color:#e5e7eb;font-family:Tahoma,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.wrap{max-width:1150px;margin:auto;padding:10px}
.bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#111827;border:1px solid #1f2937;border-radius:12px;padding:8px}
.mode{display:inline-flex;border:1px solid #2a3346;border-radius:999px;overflow:hidden}
.mode button{padding:6px 12px;border:0;background:#0f172a;color:#e5e7eb;cursor:pointer}
.mode .on{background:#128c7e;color:#fff}
.btn{background:#0f172a;border:1px solid #2a3346;color:#e5e7eb;border-radius:10px;padding:7px 10px;cursor:pointer}
.btn.p{background:#128c7e;border-color:#128c7e}
.tab{padding:8px 10px;background:#0f172a;border:1px solid #2a3346;border-radius:10px;cursor:pointer;white-space:nowrap}
.tab.on{background:#128c7e;color:#fff}
.nav{display:flex;gap:6px;overflow:auto;padding:8px 0}
.pnl{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:10px;margin-top:8px}
.grid{display:grid;gap:10px}.g2{grid-template-columns:1fr}#chatP .grid.g2>:nth-child(2){display:none}
.phone{height:78vh;background:#e5ddd5;border:8px solid #000;border-radius:16px;position:relative;overflow:hidden}
.head{position:absolute;left:0;right:0;top:0;background:#075e54;color:#fff;padding:8px;height:var(--head-h)}
.actions{position:absolute;left:0;right:0;top:var(--head-h);height:var(--actbar-h);display:flex;gap:6px;align-items:center;justify-content:center;background:#f0f2f5;border-bottom:1px solid #d6d9dc;padding:6px 8px}
.abtn{background:#fff;border:1px solid #d0d5da;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:bold;display:flex;gap:6px;align-items:center}
.abtn.on{background:#128c7e;color:#fff;border-color:#128c7e}
.chat{position:absolute;left:0;right:0;top:calc(var(--head-h) + var(--actbar-h));bottom:var(--input-h);padding:8px;overflow:auto}
.b{max-width:85%;padding:8px 10px;margin:6px;border-radius:10px;color:#111;box-shadow:0 1px 0 rgba(0,0,0,.08)}
.bot{background:#fff;margin-left:auto}.me{background:#dcf8c6;margin-right:auto}
.act{position:absolute;left:0;right:0;bottom:0;border-top:1px solid #e5e7eb;background:#f9fafb;padding:8px;height:var(--input-h)}
.q{display:flex;gap:6px;overflow:auto;margin-bottom:6px;align-items:center;flex-wrap:wrap}
.fld{width:100%;border:1px solid #cbd5e1;border-radius:20px;padding:8px;background:#fff;color:#111}
table{width:100%;border-collapse:collapse}th,td{border:1px solid #2b3242;padding:6px;background:#0f172a}th{background:#0c1220}
.num{text-align:left;font-variant-numeric:tabular-nums}.muted{opacity:.7}.hide{display:none!important}
.mode-easy .pro-only{display:none!important}.mode-pro .easy-only{display:none!important}
.sheet{background:#fff;color:#111;border:1px solid #d1d5db;border-radius:12px;padding:16px;margin-top:10px}
.sheet .row{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}.sheet .cell{flex:1 1 160px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;background:#fafafa}
.sheet .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.sheet h2{margin:0}.badge{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-weight:bold}
.w-50{flex:1 1 48%}
.kpi-ctrl{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
.kpi-ctrl input{background:#0f172a;border:1px solid #2a3346;color:#e5e7eb;border-radius:8px;padding:6px}
.kpi-bar{position:sticky;top:8px;z-index:20;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0 6px}
.kpi{background:#0f172a;border:1px solid #2a3346;border-radius:14px;padding:10px;cursor:pointer;transition:transform .15s}.kpi:hover{transform:translateY(-2px)}
.kpi .label{font-size:12px;opacity:.8}.kpi .value{font-size:22px;font-weight:700}.kpi.sales{border-color:#10b981}.kpi.cogs{border-color:#f59e0b}.kpi.exp{border-color:#ef4444}.kpi.net{border-color:#60a5fa}
#drill,#actQuick{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
#drill .box,#actQuick .box{background:#111827;border:1px solid #1f2937;border-radius:12px;max-width:950px;width:95vw;max-height:80vh;overflow:auto;padding:10px}
.insights{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
.card{background:#0f172a;border:1px solid #2a3346;border-radius:10px;padding:10px}.card h4{margin:0 0 6px 0}
.rowlink{display:flex;justify-content:space-between;padding:6px;border-radius:8px;background:#0c1220;margin:4px 0;cursor:pointer}

/* Bottom action bar + FAB */
.bottom-bar{position:fixed;left:0;right:0;bottom:0;background:#0f172a;border-top:1px solid #2a3346;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:8px;z-index:60}
.bottom-bar .btn{padding:12px 8px}
.fab{position:fixed;right:12px;bottom:74px;background:#128c7e;color:#fff;border:none;border-radius:999px;padding:14px 16px;font-size:16px;z-index:61;box-shadow:0 6px 16px rgba(0,0,0,.35);cursor:pointer}

/* Typeahead inputs */
.ta-wrap{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.ta{border:1px solid #cbd5e1;background:#fff;color:#111;border-radius:10px;padding:8px;min-width:220px}
.ta[dir="ltr"]{text-align:left}
.hint{opacity:.75;font-size:12px}

/* Responsive tweaks */
@media(max-width:768px){
  .kpi-bar{grid-template-columns:1fr 1fr;overflow-x:auto;scroll-snap-type:x mandatory}
  .actions{position:sticky;top:0}
  body{padding-bottom:84px} /* room for bottom bar */
  .phone{height:74vh}
  #actQuick .box,#drill .box{max-height:75vh}
}
@media print{
  body{background:#fff;color:#111}.wrap>*,.wrap{max-width:none}
  .bar,.nav,#chatP,#catP,#regsP,#coaP,.actions,.act,#journal,#kbar,.kpi-ctrl,.kpi-bar,.insights,#actQuick,.bottom-bar,.fab{display:none!important}
  #docP{display:block!important;border:none}
}
</style>
<style>
/* === Mobile Enhancements v2 (Unified) === */
:root { --kb-safe: 0px; }

/* Safe areas for iOS notch & bottom bar */
.head, header, .topbar, .appbar { padding-top: max(8px, env(safe-area-inset-top)); }
.bottom-bar { padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
.fab { bottom: calc(96px + env(safe-area-inset-bottom)); }
.act { padding-bottom: calc(8px + var(--kb-safe, 0px)); }

/* Comfortable touch targets */
.btn, .abtn, button, .action-btn { min-height: 44px; min-width: 44px; touch-action: manipulation; }

/* Prevent KPI/summary overlap and improve grid on small screens */
@media (max-width: 480px){
  .kpis, .kpi, .kpi-card, .kpi-grid, .stats, .stats-grid, .stat-card, .summary-cards {
    position: static !important; z-index: 1 !important; overflow: visible !important;
  }
  .kpi-grid, .stats-grid, .cards-grid {
    display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 8px !important;
  }
  .kpi-card, .stat-card, .card { margin:0 !important; padding:10px !important; border-radius:12px !important; }
  main, .content, .chat, .page, .container { padding-bottom: calc(160px + env(safe-area-inset-bottom)) !important; }
}

/* Collapsible utility bar */
#mobile-utility-bar.collapsed #util-stack { display:none; }
#mobile-utility-bar.expanded #util-stack { display:flex; }
#util-toggle { width:48px; height:48px; border-radius:9999px; box-shadow:0 6px 16px rgba(0,0,0,.25); }
.util-secondary { min-height:44px; min-width:44px; }

/* Simple toast */
#app-toast {
  position: fixed; left: 50%; bottom: calc(24px + env(safe-area-inset-bottom));
  transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff;
  padding: 10px 14px; border-radius: 10px; font-size: 14px; z-index: 99999;
  opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
}
#app-toast.show { opacity: 1; }
</style>
</head>
<body class="mode-easy">
<div class="wrap">
  <div class="bar">
    <strong>CashChat</strong>
    <div class="mode" id="modeGrp">
      <button id="mEasy" class="on" data-i18n="easy">سهل</button><button id="mPro" data-i18n="pro">محترف</button>
    </div>
    <span data-i18n="company">الشركة</span><input id="company" value="البركة للمقاولات" style="width:170px">
    <span class="pro-only" data-i18n="tax">الضريبة</span>
    <select id="taxMode" class="pro-only"><option value="taxed" selected>خاضع</option><option value="exempt">معفى</option></select>
    <span class="pro-only" data-i18n="rate">النسبة</span><input id="taxRate" class="pro-only" type="number" value="15" min="0" step="0.5" style="width:64px">% 
    <select id="lang"><option value="ar" selected>العربية</option><option value="en">English</option></select>
    <button class="btn" onclick="seedDemo()" id="btnSeed">🌱 ديمو</button>
    <button class="btn" onclick="wipeAll()" id="btnWipe">🧹 مسح</button>
    <button class="btn" id="btnK" title="Ctrl+K">🔎 بحث</button>
    <button class="btn" onclick="undoLast()" title="Undo last" id="btnUndo">↶ تراجع</button>
    <button class="btn" onclick="openActQuick()" title="نشاط اليوم" id="btnActQuick">📅 <span data-i18n="activity">نشاط اليوم</span></button>
  </div>

  <div class="kpi-ctrl">
    <span data-i18n="period">الفترة</span>
    <input id="kpiFrom" type="date">
    <input id="kpiTo" type="date">
    <button class="btn p" onclick="renderKPIs();renderInsights()" data-i18n="show">عرض</button>
  </div>

  <div class="kpi-bar" id="kpiBar">
    <div class="kpi sales" onclick="drill('sales')"><div class="label" data-i18n="kpi_sales">المبيعات</div><div class="value" id="kpiSales">0</div></div>
    <div class="kpi cogs"  onclick="drill('cogs')"><div class="label" data-i18n="kpi_cogs">تكلفة المبيعات</div><div class="value" id="kpiCogs">0</div></div>
    <div class="kpi exp"   onclick="drill('exp')"><div class="label" data-i18n="kpi_exp">المصروفات</div><div class="value" id="kpiExp">0</div></div>
    <div class="kpi net"   onclick="drill('net')"><div class="label" data-i18n="kpi_net">صافي الربح</div><div class="value" id="kpiNet">0</div></div>
  </div>

  <div class="insights" id="insights">
    <div class="card"><h4>Top Customers Due</h4><div id="insTopCust"></div></div>
    <div class="card"><h4>Top Items Sold</h4><div id="insTopItems"></div></div>
    <div class="card"><h4>Cash & Banks</h4><div id="insCashBanks"></div></div>
  </div>

  <div id="drill"><div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong id="drillTitle">تحليل</strong>
      <button class="btn" onclick="closeDrill()">إغلاق</button>
    </div>
    <table>
      <thead><tr><th data-i18n="date">التاريخ</th><th data-i18n="docNo">الرقم</th><th>الوصف</th><th class="num" data-i18n="amount">المبلغ</th></tr></thead>
      <tbody id="drillBody"></tbody>
    </table>
  </div></div>

  <div id="actQuick"><div class="box">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap">
      <div style="display:flex;gap:8px;align-items:center">
        <strong data-i18n="activity">نشاط اليوم</strong>
        <input type="date" id="actQDate">
        <button class="btn p" onclick="renderActivityQuick()" data-i18n="show">عرض</button>
        <button class="btn" onclick="exportActivityQuick()">⬇️ CSV</button>
      </div>
      <button class="btn" onclick="closeActQuick()">إغلاق</button>
    </div>
    <table>
      <thead>
        <tr>
          <th data-i18n="date">التاريخ</th>
          <th data-i18n="docNo">الرقم</th>
          <th data-i18n="type">النوع</th>
          <th data-i18n="party">الطرف</th>
          <th class="num" data-i18n="amount">المبلغ</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="actQBody"><tr><td colspan="6" style="opacity:.6">—</td></tr></tbody>
    </table>
  </div></div>

  <div class="nav">
    <div class="tab on" id="tChat" data-i18n="tab_chat">المحادثة</div>
    <div class="tab" id="tDoc" data-i18n="tab_doc">الوثيقة</div>
    <div class="tab" id="tCat" data-i18n="tab_cat">الأصناف</div>
    <div class="tab" id="tRegs" data-i18n="tab_regs">السجلات</div>
    <div class="tab pro-only" id="tCoa" data-i18n="tab_coa">الحسابات</div>
  </div>

  <div class="pnl" id="chatP">
    <div class="grid g2">
      <div>
        <div class="phone">
          <div class="head">شات محاسبي</div>
          <div class="actions" id="actions"></div>
          <div id="chat" class="chat"></div>
          <div class="act">
            <div class="q" id="quick"></div>
            <div class="ta-wrap">
              <input id="manual" class="fld" placeholder="...">
              <button class="btn" onclick="sendManual()" id="btnSend">إرسال</button>
              <button class="btn" onclick="resetFlow()" id="btnClear">مسح</button>
            </div>
          </div>
        </div>
      </div><div></div>
    </div>
  </div>

  <div class="pnl hide" id="docP">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap">
      <strong id="docTitle">Document</strong>
      <div>
        <button class="btn" id="btnNewOp" onclick="newOperation()">عملية جديدة</button>
        <button class="btn" onclick="window.print()" id="btnPDF">🖨️ PDF</button>
      </div>
    </div>
    <div id="normalDoc">
      <table>
        <thead id="docHead"><tr>
          <th>الوصف</th><th class="num">Qty</th><th class="num">Price</th><th class="num">Net</th><th class="num">Total</th>
        </tr></thead>
        <tbody id="docBody"><tr><td colspan="5" style="opacity:.6">—</td></tr></tbody>
        <tfoot id="docFoot"></tfoot>
      </table>
    </div>
    <div id="receiptTpl" class="hide">
      <div class="sheet">
        <div class="title">
          <div>
            <div class="muted" id="rcptCompany">—</div>
            <h2 id="rcptTitle">إيصال</h2>
          </div>
          <div><span class="badge" id="rcptNo">#</span></div>
        </div>
        <div class="row">
          <div class="cell w-50"><b id="lblRcptDate">التاريخ</b>: <span id="rcptDate"></span></div>
        </div>
        <div class="row">
          <div class="cell w-50"><b id="lblRcptFrom">استلمنا من</b>: <span id="rcptFrom"></span></div>
          <div class="cell w-50"><b id="lblRcptAmt">المبلغ</b>: <span id="rcptAmt"></span></div>
        </div>
        <div class="row">
          <div class="cell w-50"><b id="lblRcptMethod">الطريقة</b>: <span id="rcptMethod"></span></div>
          <div class="cell w-50"><b id="lblRcptBank">البنك/الصندوق</b>: <span id="rcptBank"></span></div>
        </div>
        <div class="row">
          <div class="cell"><b id="lblRcptFor">عن</b>: <span id="rcptFor"></span></div>
        </div>
        <div class="signs">
          <div class="sign">المستلم / Received By</div>
          <div class="sign">المحاسب / Accountant</div>
          <div class="sign">المعتمد / Approved</div>
        </div>
      </div>
    </div>
  </div>

  <div class="pnl hide" id="catP">
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
      <input id="itNA" placeholder="اسم (عربي)" class="ta">
      <input id="itNE" placeholder="Name (EN)" class="ta" dir="ltr">
      <input id="itP" type="number" inputmode="decimal" placeholder="سعر" style="width:120px" class="ta">
      <select id="itT" class="ta"><option value="service">خدمة</option><option value="material">صنف</option><option value="asset">أصل</option><option value="exp">مصروف</option></select>
      <label style="opacity:.8">مخزون؟ <input id="itTr" type="checkbox" checked></label>
      <input id="itOQ" type="number" inputmode="numeric" placeholder="رصيد" style="width:110px" class="ta">
      <input id="itOC" type="number" inputmode="decimal" placeholder="تكلفة/وحدة" style="width:130px" class="ta">
      <button class="btn p" onclick="addItem()">حفظ</button>
    </div>
    <table><thead><tr><th>الكود</th><th>الاسم</th><th>النوع</th><th class="num">سعر</th><th class="num">مخزون</th><th class="num">متوسط تكلفة</th></tr></thead><tbody id="catBody"></tbody></table>
  </div>

  <div class="pnl hide" id="regsP">
    <div class="grid g2">
      <div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
          <strong>العملاء</strong><input id="custName" class="ta" placeholder="اسم"><button class="btn" onclick="addCustomer()">إضافة</button>
        </div>
        <table><thead><tr><th>الكود</th><th>الاسم</th><th>تصنيف</th></tr></thead><tbody id="custBody"></tbody></table>
      </div>
      <div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
          <strong>الموردون</strong><input id="suppName" class="ta" placeholder="اسم"><button class="btn" onclick="addSupplier()">إضافة</button>
        </div>
        <table><thead><tr><th>الكود</th><th>الاسم</th><th>تصنيف</th></tr></thead><tbody id="suppBody"></tbody></table>
      </div>

      <div class="pnl" style="grid-column:1/-1">
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
          <strong>البنوك والصناديق</strong>
          <select id="finKind" class="ta"><option value="bank">بنك</option><option value="cash">صندوق</option></select>
          <input id="finName" class="ta" placeholder="الاسم">
          <button class="btn" onclick="addFin()">إضافة</button>
        </div>
        <div id="finList"></div>
      </div>

      <div class="pnl" id="activityP" style="grid-column:1/-1">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
          <strong data-i18n="activity">نشاط اليوم</strong>
          <input type="date" id="actDate">
          <button class="btn p" onclick="renderActivity()" data-i18n="show">عرض</button>
          <button class="btn" onclick="exportActivity()">⬇️ CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th data-i18n="date">التاريخ</th>
              <th data-i18n="docNo">الرقم</th>
              <th data-i18n="type">النوع</th>
              <th data-i18n="party">الطرف</th>
              <th class="num" data-i18n="amount">المبلغ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="actBody"><tr><td colspan="6" style="opacity:.6">—</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="pnl hide pro-only" id="coaP">
    <div class="subnav">
      <div class="tab on" id="subCoa">شجرة الحسابات</div>
      <div class="tab" id="subTB">ميزان المراجعة</div>
      <div class="tab" id="subLed">دفتر أستاذ (عميل/مورد)</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <span data-i18n="period">الفترة</span>
      <input id="coaFrom" type="date"><input id="coaTo" type="date">
      <button class="btn p" onclick="renderAccountsView()" data-i18n="show">عرض</button>
      <button class="btn" onclick="exportTB()">⬇️ CSV TB</button>
      <button class="btn" onclick="exportLedger()">⬇️ CSV Ledger</button>
    </div>

    <div id="viewCoa">
      <table>
        <thead><tr><th>الكود</th><th>الحساب</th><th>النوع</th><th class="num">مدين</th><th class="num">دائن</th><th class="num">الرصيد</th></tr></thead>
        <tbody id="coaBody"><tr><td colspan="6" style="opacity:.6">—</td></tr></tbody>
      </table>
    </div>

    <div id="viewTB" class="hide">
      <table>
        <thead><tr><th>الكود</th><th>الحساب</th><th class="num">مدين</th><th class="num">دائن</th></tr></thead>
        <tbody id="tbBody"><tr><td colspan="4" style="opacity:.6">—</td></tr></tbody>
        <tfoot id="tbFoot"></tfoot>
      </table>
    </div>

    <div id="viewLed" class="hide">
      <div style="display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap">
        <select id="ledType" class="ta"><option value="customer">عملاء</option><option value="supplier">موردون</option></select>
        <select id="ledParty" class="ta"></select>
        <button class="btn p" onclick="renderPartyLedger()">عرض الدفتر</button>
      </div>
      <table>
        <thead><tr><th>التاريخ</th><th>المستند</th><th>الوصف</th><th class="num">مدين</th><th class="num">دائن</th><th class="num">الرصيد</th></tr></thead>
        <tbody id="ledBody"><tr><td colspan="6" style="opacity:.6">—</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Bottom action bar -->
<div class="bottom-bar">
  <button class="btn" onclick="quickStart('sale')">🧾 <span data-i18n="btnSale">بيع</span></button>
  <button class="btn" onclick="quickStart('purchase')">🛒 <span data-i18n="btnPurchase">مشتريات</span></button>
  <button class="btn" onclick="startReceipt()">💵 <span data-i18n="receipt">تحصيل</span></button>
  <button class="btn" onclick="startPayment()">💳 <span data-i18n="payment">سداد</span></button>
</div>
<button class="fab" onclick="newOperation()">＋ <span data-i18n="newOp">عملية جديدة</span></button>

<div id="kbar" class="hide" style="position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);padding-top:8vh;z-index:9999">
  <div style="background:#111827;border:1px solid #1f2937;border-radius:12px;width:min(800px,95vw);max-height:72vh;overflow:auto">
    <div style="padding:8px;border-bottom:1px solid #1f2937"><input id="kq" placeholder="ابحث عن عميل/مورد/صنف/فاتورة/إيصال..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #2a3346;background:#0f172a;color:#e5e7eb"></div>
    <div id="kres"></div>
  </div>
</div>

<script>
/* ==== i18n ==== */
var T={ar:{easy:"سهل",pro:"محترف",company:"الشركة",tax:"الضريبة",rate:"النسبة",period:"الفترة",show:"عرض",
kpi_sales:"المبيعات",kpi_cogs:"تكلفة المبيعات",kpi_exp:"المصروفات",kpi_net:"صافي الربح",
tab_chat:"المحادثة",tab_doc:"الوثيقة",tab_cat:"الأصناف",tab_regs:"السجلات",tab_coa:"الحسابات",
btnSale:"🧾 بيع",btnPurchase:"🛒 مشتريات",receipt:"تحصيل",payment:"سداد",pick:"اختر...",newCust:"— عميل جديد —",newSupp:"— مورد جديد —",
enter:"اكتب الاسم ثم إضافة",itemStep:"اختر/اكتب بند ← نوع/كمية/سعر ثم إضافة",addLine:"إضافة بند",finish:"إنهاء البنود",net:"الصافي",total:"الإجمالي",
custom:"+ بند مخصص",saveDoc:"حفظ المستند",more:"بند آخر",pm:"طريقة الدفع",cash:"نقدي",cheque:"شيك",bank:"تحويل بنكي",
whichBank:"البنك",back:"رجوع",newOp:"عملية جديدة",
rcpt_title_recv:"إيصال تحصيل",rcpt_title_pay:"إيصال سداد",rcpt_date:"التاريخ",rcpt_from:"استلمنا من",rcpt_amt:"المبلغ",rcpt_method:"الطريقة",rcpt_bank:"البنك/الصندوق",rcpt_for:"عن",
activity:'نشاط اليوم', openDoc:'فتح', docNo:'الرقم', type:'النوع', party:'الطرف', amount:'المبلغ', date:'التاريخ',
saleT:'بيع', purchaseT:'مشتريات', receiptT:'تحصيل', paymentT:'سداد'},
en:{easy:"Easy",pro:"Pro",company:"Company",tax:"VAT",rate:"%",period:"Period",show:"Show",
kpi_sales:"Sales",kpi_cogs:"COGS",kpi_exp:"Expenses",kpi_net:"Net Profit",
tab_chat:"Chat",tab_doc:"Document",tab_cat:"Catalog",tab_regs:"Registers",tab_coa:"Accounts",
btnSale:"🧾 Sales",btnPurchase:"🛒 Purchases",receipt:"Receipt",payment:"Payment",pick:"Select...",newCust:"— New Customer —",newSupp:"— New Supplier —",
enter:"Type a name then Add",itemStep:"Pick/type item → type/qty/price then Add",addLine:"Add Line",finish:"Finish Lines",net:"Net",total:"Total",
custom:"+ Custom line",saveDoc:"Save Document",more:"Add more",pm:"Payment Method",cash:"Cash",cheque:"Cheque",bank:"Bank Transfer",
whichBank:"Bank",back:"Back",newOp:"New Operation",
rcpt_title_recv:"Receipt",rcpt_title_pay:"Payment",rcpt_date:"Date",rcpt_from:"Paid by",rcpt_amt:"Amount",rcpt_method:"Method",rcpt_bank:"Bank/Cashbox",rcpt_for:"For",
activity:'Daily Activity', openDoc:'Open', docNo:'No.', type:'Type', party:'Party', amount:'Amount', date:'Date',
saleT:'Sale', purchaseT:'Purchase', receiptT:'Receipt', paymentT:'Payment'}};
function t(k){return (T[DB.meta.lang]&&T[DB.meta.lang][k])||k}
function translateUI(){document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.getAttribute('data-i18n'))});
const L={date:'lblRcptDate',from:'lblRcptFrom',amt:'lblRcptAmt',m:'lblRcptMethod',b:'lblRcptBank',f:'lblRcptFor'};
['date','from','amt','m','b','f'].forEach(k=>{if($(L[k])) $(L[k]).textContent=t('rcpt_'+k)});
const bno=$('btnNewOp'); if(bno) bno.textContent=t('newOp');}

/* ==== helpers & DB ==== */
const K='ccp_easypro_v7';
const $=id=>document.getElementById(id);
function pad(n){return String(n).padStart(3,'0')}
function fmt(n){let v=Number(n); if(!Number.isFinite(v)) v=0; const loc=(document.documentElement.lang==='ar')?'ar-EG':'en-US'; return v.toLocaleString(loc,{minimumFractionDigits:2,maximumFractionDigits:2})}
function today(){return new Date().toISOString().slice(0,10)}
var DB=loadDB();
function loadDB(){try{let d=JSON.parse(localStorage.getItem(K))||{};d.meta=d.meta||{company:'البركة للمقاولات',taxMode:'taxed',taxRate:15,lang:'ar'};
d.ui=d.ui||{mode:'easy',from:'',to:''};d.seq=d.seq||{customer:0,supplier:0,sales:0,purchase:0,receipt:0,item:0,bank:0,cash:0};
d.customers=d.customers||[]; d.suppliers=d.suppliers||[]; d.accounts=d.accounts||{banks:[],cash:[]};
d.catalog=d.catalog||[{id:nextItemId(d),name_ar:'خدمة صيانة',name_en:'Maintenance',price:200,type:'service',track:false,stockQty:0,avgCost:0},{id:nextItemId(d),name_ar:'فلتر زيت',name_en:'Oil Filter',price:180,type:'material',track:true,stockQty:0,avgCost:0}];
d.invoices=d.invoices||[]; d.payments=d.payments||[]; d.journals=d.journals||[]; return d;}catch(e){return {meta:{company:'ACME',taxMode:'taxed',taxRate:15,lang:'en'},ui:{mode:'easy'},seq:{},customers:[],suppliers:[],accounts:{banks:[],cash:[]},catalog:[],invoices:[],payments:[],journals:[]}}}
function persist(){localStorage.setItem(K,JSON.stringify(DB))}
function rerenderAll(){renderRegs();renderCat();renderFin();renderActions();renderKPIs();renderAccountsView();renderInsights()}
function save(skipRender=false){localStorage.setItem(K,JSON.stringify(DB)); if(!skipRender) rerenderAll()}

/* ==== UI core ==== */
var chat=$('chat'),quick=$('quick');var st={mode:null,partyType:null,partyCode:'',partyName:'',lines:[],payType:'cash'};
function bubble(h,w){var d=document.createElement('div');d.className='b '+(w==='me'?'me':'bot');d.innerHTML=h;chat.appendChild(d);chat.scrollTop=chat.scrollHeight}
function qBtns(a){quick.innerHTML='';(a||[]).forEach(b=>{var x=document.createElement('button');x.className='btn';x.textContent=b.label;x.onclick=b.onClick;quick.appendChild(x)})}
function qHTML(h){quick.innerHTML=h}
function resetFlow(){chat.innerHTML='';qBtns([]);st={mode:null,partyType:null,partyCode:'',partyName:'',lines:[],payType:'cash'};greet();renderActions()}
function openTab(id,el){['chat','doc','cat','regs','coa'].forEach(x=>{var p=$(x+'P');if(p)p.classList.add('hide')});document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));$(id+'P').classList.remove('hide');if(el)el.classList.add('on')}
function sendManual(){var i=$('manual');if(!i.value.trim())return;bubble(i.value,'me');i.value=''}
function applyLang(){var L=DB.meta.lang;document.documentElement.lang=L;document.documentElement.dir=L==='ar'?'rtl':'ltr';translateUI();renderRegs();renderCat();renderFin();renderActions();greet()}
function applyMode(){var m=(DB.ui&&DB.ui.mode)||'easy';document.body.classList.toggle('mode-easy',m==='easy');document.body.classList.toggle('mode-pro',m==='pro');$('mEasy').classList.toggle('on',m==='easy');$('mPro').classList.toggle('on',m==='pro')}
function renderActions(){var bar=$('actions');if(!bar)return;function mk(id,txt,active){return '<button class="abtn '+(active?'on':'')+'" id="'+id+'" '+(active?'disabled':'')+'>'+txt+'</button>'}
var isSale=st.mode==='sale',isPur=st.mode==='purchase',isRecv=(st.mode==='cash'&&st.partyType==='customer'),isPay=(st.mode==='cash'&&st.partyType==='supplier');
bar.innerHTML=['<button class="abtn" id="abHome">↩︎ '+t('back')+'</button>',mk('abSale',t('btnSale'),isSale),mk('abRec',t('receipt'),isRecv),mk('abPur',t('btnPurchase'),isPur),mk('abPay',t('payment'),isPay)].join('');
$('abHome').onclick=()=>{resetFlow();openTab('chat')};$('abSale').onclick=()=>quickStart('sale');$('abPur').onclick=()=>quickStart('purchase');$('abRec').onclick=()=>startReceipt();$('abPay').onclick=()=>startPayment();}
function greet(){bubble('<b>'+ (t('newOp')) + ' — ' + (document.body.classList.contains('mode-pro')?'Pro':'Easy') +'</b>');qBtns([{label:t('btnSale'),onClick:()=>quickStart('sale')},{label:t('btnPurchase'),onClick:()=>quickStart('purchase')},{label:t('receipt'),onClick:()=>startReceipt()},{label:t('payment'),onClick:()=>startPayment()}])}
function quickStart(k){chat.innerHTML='';qBtns([]);st.mode=k;if(k==='sale')startSale();if(k==='purchase')startPurchase();renderActions()}
function startSale(){bubble('<b>'+(DB.meta.lang==='ar'?'اختَر طريقة الدفع:':'Pick payment method:')+'</b>');qBtns([{label:(DB.meta.lang==='ar'?'نقدي':'Cash'),onClick:()=>{st.payType='cash';st.partyType='customer';askParty();renderActions()}},{label:(DB.meta.lang==='ar'?'آجل':'Credit'),onClick:()=>{st.payType='credit';st.partyType='customer';askParty();renderActions()}}])}
function startPurchase(){bubble('<b>'+(DB.meta.lang==='ar'?'تسجيل مشتريات — اختر المورد:':'Record Purchase — Pick supplier:')+'</b>');st.partyType='supplier';askParty();renderActions()}
function startReceipt(){st.mode='cash';st.partyType='customer';chat.innerHTML='';askParty();renderActions()}
function startPayment(){st.mode='cash';st.partyType='supplier';chat.innerHTML='';askParty();renderActions()}
function newOperation(){openTab('chat');resetFlow()}

/* ==== Party (Typeahead) ==== */
function balCustomer(code,f,t){var inv=DB.invoices.filter(i=>i.type==='sale'&&i.partyCode===code&&rangeOK(i.date,f,t)).reduce((s,i)=>s+(+i.total||0),0);var rc=DB.payments.filter(p=>p.dir==='recv'&&p.partyCode===code&&rangeOK(p.date,f,t)).reduce((s,p)=>s+(+p.amount||0),0);return +(inv-rc).toFixed(2)}
function balSupplier(code,f,t){var pinv=DB.invoices.filter(i=>i.type==='purchase'&&i.partyCode===code&&rangeOK(i.date,f,t)).reduce((s,i)=>s+(+i.total||0),0);var pay=DB.payments.filter(p=>p.dir==='pay'&&p.partyCode===code&&rangeOK(p.date,f,t)).reduce((s,p)=>s+(+p.amount||0),0);return +(pinv-pay).toFixed(2)}
function partyOptionsHTML(pt){var f=$('kpiFrom').value||'',t=$('kpiTo').value||'';var list=(pt==='customer'?DB.customers:DB.suppliers).slice();return list.map(p=>{var bal=pt==='customer'?balCustomer(p.code,f,t):balSupplier(p.code,f,t);var label=p.code+' — '+p.name+' — '+(DB.meta.lang==='ar'?'رصيد':'Bal')+' '+fmt(bal);return '<option value="'+p.code+' — '+p.name+'">'+label+'</option>'}).join('')}
function askParty(){var pt=st.partyType;bubble(pt==='customer'?(DB.meta.lang==='ar'?'اختَر العميل أو اكتب للبحث:':'Pick/type customer'):(DB.meta.lang==='ar'?'اختَر المورد أو اكتب للبحث:':'Pick/type supplier'));
var html='<div class="ta-wrap"><input class="ta" id="partyInput" list="partyList" placeholder="'+t('enter')+'"><datalist id="partyList">'+partyOptionsHTML(pt)+'</datalist><button class="btn" id="partyBtn">'+(DB.meta.lang==='ar'?'اختيار/إضافة':'Select/Add')+'</button></div><div class="hint">'+(DB.meta.lang==='ar'?'اكتب اسم/كود الطرف وسيظهر اقتراح — إن لم يوجد سيتم إضافته':'Type code/name to search — new value will be added if not found')+'</div>';
qHTML(html);$('partyBtn').onclick=confirmParty}
function findPartyByInput(val,pt){val=String(val||'').trim();if(!val)return null;var list=(pt==='customer'?DB.customers:DB.suppliers);var code=val.split(' — ')[0];var byCode=list.find(x=>x.code.toLowerCase()===code.toLowerCase());if(byCode)return byCode;var byName=list.find(x=>x.name.toLowerCase()===val.toLowerCase());if(byName)return byName;return null}
function confirmParty(){var inp=$('partyInput');var val=(inp&&inp.value)||'';var p=findPartyByInput(val,st.partyType);if(p){st.partyCode=p.code;st.partyName=p.name;bubble(p.code+' — '+p.name,'me')}else{var name=val||'';if(!name){alert(t('enter'));return}var code=nextCode(st.partyType==='customer'?'customer':'supplier');var list=st.partyType==='customer'?DB.customers:DB.suppliers;list.push({code,name});save(true);st.partyCode=code;st.partyName=name;bubble(((DB.meta.lang==='ar')?'تم إضافة: ':'Added: ')+code+' — '+name,'me')}
if(st.mode==='cash'){askCashAmount()}else{st.lines=[];askItem()}}

/* ==== Items (Typeahead) ==== */
function ITEMS(){return DB.catalog}
function findItemByName(name){name=String(name||'').trim().toLowerCase();return ITEMS().find(it=>String(it.name_ar||'').toLowerCase()===name || String(it.name_en||'').toLowerCase()===name)}
function askItem(){var isSale=(st.mode==='sale'); bubble(t('itemStep'));
var opts=ITEMS().map(it=>'<option value="'+(document.documentElement.lang==='ar'?it.name_ar:it.name_en)+'">'+((DB.meta.lang==='ar'?it.name_ar:it.name_en)+' — '+it.price)+'</option>').join('');
var typeOptsSale='<option value="service">'+(DB.meta.lang==='ar'?'خدمة':'Service')+'</option><option value="material">'+(DB.meta.lang==='ar'?'خامات (مخزون)':'Materials (Inv)')+'</option><option value="exp">'+(DB.meta.lang==='ar'?'مصروف':'Expense')+'</option><option value="asset">'+(DB.meta.lang==='ar'?'أصل ثابت':'Fixed Asset')+'</option>';
var typeOptsPur ='<option value="material">'+(DB.meta.lang==='ar'?'خامات (مخزون)':'Materials (Inv)')+'</option><option value="exp">'+(DB.meta.lang==='ar'?'مصروف':'Expense')+'</option><option value="asset">'+(DB.meta.lang==='ar'?'أصل ثابت':'Fixed Asset')+'</option>';
var typeSel='<select id="ptype" class="ta" style="min-width:160px">'+(isSale?typeOptsSale:typeOptsPur)+'</select>';
qHTML('<div class="ta-wrap"><input id="itemName" class="ta" list="itemList" placeholder="'+(DB.meta.lang==='ar'?'اسم البند':'Item name')+'"><datalist id="itemList">'+opts+'</datalist>'+typeSel+' <input id="qty" type="number" inputmode="numeric" min="1" value="1" style="width:80px" class="ta"> <input id="price" type="number" inputmode="decimal" min="0" style="width:100px" class="ta" placeholder="'+(DB.meta.lang==='ar'?'السعر':'Price')+'"> <button class="btn" id="btnAdd">'+t('addLine')+'</button> <button class="btn" id="btnFin">'+t('finish')+'</button></div>');
function syncFromName(){var nm=($('itemName').value||'').trim();var it=findItemByName(nm);var tSel=$('ptype'),p=$('price');if(it){p.value=it.price||0;tSel.value=it.type||'service';tSel.disabled=true}else{tSel.disabled=false}}
$('itemName').addEventListener('input',syncFromName);syncFromName();
$('btnAdd').onclick=addLine; $('btnFin').onclick=finishLines}
function checkStock(it,qty){if(st.mode!=='sale')return true;if(it.type!=='material')return true;var stk=+((it.stockQty)||0);return qty<=stk}
function pushLine(type,name_ar,name_en,qty,price){var net=+(price*qty).toFixed(2);st.lines.push({type,name_ar,name_en,qty,price,net,line:net})}
function addLine(){var nm=($('itemName').value||'').trim(); if(!nm){alert(DB.meta.lang==='ar'?'اكتب اسم البند':'Type item name');return}
var isSale=(st.mode==='sale');var q=Math.max(1,+$('qty').value||1),p=Math.max(0,+$('price').value||0);var it=findItemByName(nm),type,name_ar=nm,name_en=nm;
if(it){type=it.type;name_ar=it.name_ar;name_en=it.name_en;if(isSale&&type==='material'&&!checkStock(it,q)){alert(DB.meta.lang==='ar'?'لا يمكن البيع بالسالب. المتاح: ':'Insufficient stock. Available: ')+(it.stockQty||0);return}if(p===0)p=+it.price||0}
else{type=($('ptype')||{value:(isSale?'service':'exp')}).value;
  if(type==='material'){var exist=DB.catalog.find(x=>x.type==='material'&&(x.name_ar===nm||x.name_en===nm));if(!exist){DB.catalog.push({id:nextItemId(DB),name_ar:nm,name_en:nm,price:p,type:'material',track:true,stockQty:0,avgCost:+p});save(true)}else if(isSale&&!checkStock(exist,q)){alert(DB.meta.lang==='ar'?'لا يمكن البيع بالسالب. المتاح: ':'Insufficient stock. Available: ')+(exist.stockQty||0);return}}}
pushLine(type,name_ar,name_en,q,p);bubble('+ '+((DB.meta.lang==='ar')?name_ar:name_en)+' × '+q,'me')}
function totals(lines){var net=lines.reduce((s,l)=>s+l.net,0);return{subtotal:+net.toFixed(2),total:+net.toFixed(2)}}
function finishLines(){var sum=totals(st.lines);bubble(((DB.meta.lang==='ar')?'ملخص:':'Summary:')+' '+t('net')+' '+fmt(sum.subtotal)+' = <b>'+t('total')+' '+fmt(sum.total)+'</b>.');
var opts=[{label:t('saveDoc'),onClick:()=>{st.mode==='sale'?saveSale(false):finalizePurchase(false)}}];
if(st.mode==='sale') opts.push({label:(DB.meta.lang==='ar'?'حفظ + تحصيل':'Save + Collect'),onClick:()=>saveSale(true)});
if(st.mode==='purchase') opts.push({label:(DB.meta.lang==='ar'?'حفظ + سداد':'Save + Pay'),onClick:()=>finalizePurchase(true)});
opts.push({label:(DB.meta.lang==='ar'?'حفظ + طباعة':'Save + Print'),onClick:()=>{ if(st.mode==='sale'){saveSale(false); setTimeout(()=>window.print(),80)} else if(st.mode==='purchase'){finalizePurchase(false); setTimeout(()=>window.print(),80)} }});
qBtns(opts)}

/* ==== Posting & undo ==== */
var undoStack=[];
function nextCode(kind){var n=(DB.seq[kind]=+(DB.seq[kind]||0)+1);return(kind==='customer'?'C':'S')+pad(n)}
function nextDoc(kind){var y=new Date().getFullYear();var n=(DB.seq[kind]=+(DB.seq[kind]||0)+1);var p=kind==='sales'?'INV':kind==='purchase'?'PINV':'RCPT';return p+'-'+y+'-'+String(n).padStart(4,'0')}
function nextItemId(store){store.seq=store.seq||{};store.seq.item=+(store.seq.item||0)+1;return'ITM-'+String(store.seq.item).padStart(3,'0')}
function nextFinCode(kind){var key=kind==='bank'?'bank':'cash';var n=(DB.seq[key]=+(DB.seq[key]||0)+1);return(kind==='bank'?'BK':'CA')+String(n).padStart(3,'0')}

function saveSale(goCollect){var sum=totals(st.lines),no=nextDoc('sales');var cogs=0;
st.lines.filter(l=>l.type==='material').forEach(l=>{var item=DB.catalog.find(x=>x.name_ar===l.name_ar&&x.type==='material');var q=l.qty;var cost=((item&&item.avgCost)||0)*q;cogs+=cost;if(item){item.stockQty=+((item.stockQty||0)-q).toFixed(4)}});
var doc={type:'sale',payType:st.payType,partyType:'customer',partyCode:st.partyCode,partyName:st.partyName,lines:st.lines,subtotal:sum.subtotal,total:sum.total,date:today(),no:no,cogs:+cogs.toFixed(2)};
DB.invoices.push(doc);postSales(doc);undoStack.push({kind:'sale',payload:doc});save();
buildDoc(doc,(DB.meta.lang==='ar')?'فاتورة بيع':'Sales Invoice');openTab('doc');if(goCollect){collectOn(doc)}}
function finalizePurchase(goPay){var sum=totals(st.lines),no=nextDoc('purchase');
st.lines.forEach(l=>{if(l.type==='material'){var item=DB.catalog.find(x=>x.type==='material'&&(x.name_ar===l.name_ar||x.name_en===l.name_en));if(item){var oq=item.stockQty||0,oc=item.avgCost||0,nq=oq+l.qty,navg=nq>0?((oq*oc+l.net)/nq):oc;item.stockQty=+nq.toFixed(4);item.avgCost=+navg.toFixed(4)}}});
var doc={type:'purchase',partyType:'supplier',partyCode:st.partyCode,partyName:st.partyName,lines:st.lines,subtotal:sum.subtotal,total:sum.total,date:today(),no:no};
DB.invoices.push(doc);postPurchase(doc);undoStack.push({kind:'purchase',payload:doc});save();
buildDoc(doc,(DB.meta.lang==='ar')?'فاتورة مشتريات':'Purchase Invoice');openTab('doc');if(goPay){payOn(doc)}}
function undoLast(){var last=undoStack.pop(); if(!last){alert('Nothing to undo');return}
if(last.kind==='sale'){var inv=last.payload; inv.lines.filter(l=>l.type==='material').forEach(l=>{var it=DB.catalog.find(x=>x.type==='material'&&(x.name_ar===l.name_ar));if(it) it.stockQty=+((it.stockQty||0)+l.qty).toFixed(4)}); DB.invoices=DB.invoices.filter(i=>i.no!==inv.no); DB.journals=DB.journals.filter(j=>j.docNo!==inv.no)}
else if(last.kind==='purchase'){var pinv=last.payload; pinv.lines.filter(l=>l.type==='material').forEach(l=>{var it=DB.catalog.find(x=>x.type==='material'&&(x.name_ar===l.name_ar));if(it) it.stockQty=+((it.stockQty||0)-l.qty).toFixed(4)}); DB.invoices=DB.invoices.filter(i=>i.no!==pinv.no); DB.journals=DB.journals.filter(j=>j.docNo!==pinv.no)}
else if(last.kind==='rcpt'){var r=last.payload; DB.payments=DB.payments.filter(p=>p.no!==r.no); DB.journals=DB.journals.filter(j=>j.docNo!==r.no)}
save(); alert('Undone.')}
function postSales(inv){var L=[{acc:'AR',dr:inv.total,cr:0},{acc:'REV',dr:0,cr:inv.subtotal}];if(inv.cogs>0){L.push({acc:'COGS',dr:inv.cogs,cr:0},{acc:'INV',dr:0,cr:inv.cogs})}DB.journals.push({docNo:inv.no,type:'sales',date:inv.date,lines:L})}
function postPurchase(p){var sumMat=0,sumExp=0,sumFA=0;(p.lines||[]).forEach(l=>{if(l.type==='material')sumMat+=+l.net||0;else if(l.type==='asset')sumFA+=+l.net||0;else sumExp+=+l.net||0});var L=[];if(sumMat>0)L.push({acc:'INV',dr:sumMat,cr:0});if(sumFA>0)L.push({acc:'FA',dr:sumFA,cr:0});if(sumExp>0)L.push({acc:'EXP',dr:sumExp,cr:0});L.push({acc:'AP',dr:0,cr:p.total});DB.journals.push({docNo:p.no,type:'purchase',date:p.date,lines:L})}

/* ==== Receipts/Payments ==== */
function finOptions(kind){var arr=(kind==='bank'?(DB.accounts&&DB.accounts.banks?DB.accounts.banks:[]):(DB.accounts&&DB.accounts.cash?DB.accounts.cash:[]));return arr.map(x=>'<option value="'+x.key+'">'+x.name+' — '+x.accCode+'</option>').join('')}
function getFinByKey(key){var a=(DB.accounts&&DB.accounts.banks?DB.accounts.banks:[]),c=(DB.accounts&&DB.accounts.cash?DB.accounts.cash:[]);return a.concat(c).find(x=>x.key===key)||null}
function finNameByKey(key){var r=getFinByKey(key);return r?r.name:''}
function payMethodUI(){return '<label>'+t('pm')+':</label><select id=pmSel><option value=cash>'+t('cash')+'</option><option value=bank>'+t('bank')+'</option><option value=cheque>'+t('cheque')+'</option></select> <span id=pmCash><label>'+(DB.meta.lang==='ar'?'الصندوق':'Cashbox')+':</label><select id=cashSel>'+ (finOptions('cash')||'<option></option>') +'</select></span> <span id=pmBank class=hide><label>'+t('whichBank')+':</label><select id=bankSel>'+ (finOptions('bank')||'<option></option>') +'</select> <input id=chqNo placeholder="'+t('cheque')+' #" style="width:110px" class="ta"></span>'}
function attachMethodWatcher(){var m=$('pmSel'),b=$('pmBank'),c=$('pmCash');if(!m||!b||!c)return;var sync=()=>{var isBank=(m.value==='bank'||m.value==='cheque');b.classList.toggle('hide',!isBank);c.classList.toggle('hide',m.value!=='cash')};m.onchange=sync;sync()}
function openInvoicesOf(pt,pc){return DB.invoices.filter(i=>i.partyType===pt&&(pt==='customer'?i.type==='sale':i.type==='purchase')&&i.partyCode===pc).map(inv=>{var paid=DB.payments.filter(p=>p.linkNo===inv.no).reduce((s,p)=>s+p.amount,0);var remain=+(inv.total-paid).toFixed(2);return Object.assign({},inv,{remain})}).filter(i=>i.remain>0)}
function askCashAmount(){bubble(DB.meta.lang==='ar'?'أدخل المبلغ ثم اختر طريقة الدفع:':'Enter amount and pick method:');qHTML('<input id=amt placeholder="'+(DB.meta.lang==='ar'?'المبلغ':'Amount')+'" class="ta" inputmode="decimal" style="width:130px"> '+payMethodUI()+' <button class=btn onclick=postAmount()>'+(DB.meta.lang==='ar'?'تسجيل':'Post')+'</button>');attachMethodWatcher()}
function postAmount(){var v=+(String(($('amt').value)||'0').replace(/,/g,''));if(v<=0){alert(DB.meta.lang==='ar'?'اكتب مبلغ صحيح':'Enter valid amount');return}var method=($('pmSel')||{value:'cash'}).value,bankKey=($('bankSel')||{value:''}).value,cashKey=($('cashSel')||{value:''}).value,chqNo=($('chqNo')||{value:''}).value;var bankName=finNameByKey(bankKey),cashName=finNameByKey(cashKey);var dir=(st.partyType==='customer')?'recv':'pay',no=nextDoc('receipt');var rec={dir,partyType:st.partyType,partyCode:st.partyCode,partyName:st.partyName||'',amount:v,date:today(),no,method,bankKey,bankName,cashKey,cashName,chqNo,linkNo:''};DB.payments.push(rec);postReceipt(rec);undoStack.push({kind:'rcpt',payload:rec});save();var title=dir==='recv'?t('rcpt_title_recv'):t('rcpt_title_pay');var doc={isReceipt:true,desc:title,lines:[{name:title,qty:1,price:v,line:v}],subtotal:v,total:v,date:today(),no,rcpt:{dir,partyCode:st.partyCode,partyName:st.partyName||'',method,bankKey,bankName,cashKey,cashName,chqNo,amount:v,linkNo:''}};buildDoc(doc,title);openTab('doc')}
function postReceipt(r){var acc=(r.method==='cash'?(r.cashKey||'CASH'):(r.bankKey||'BANK'));if(r.dir==='recv'){DB.journals.push({docNo:r.no,type:'receipt',date:r.date,lines:[{acc,dr:r.amount,cr:0},{acc:'AR',dr:0,cr:r.amount}]})}else{DB.journals.push({docNo:r.no,type:'payment',date:r.date,lines:[{acc:'AP',dr:r.amount,cr:0},{acc,dr:0,cr:r.amount}]})}}
function collectOn(inv){var list=openInvoicesOf('customer',inv.partyCode),opts=list.map(i=>'<option value="'+i.no+'" '+(i.no===inv.no?'selected':'')+'>'+i.no+' — '+(DB.meta.lang==='ar'?'متبقّي':'Remain')+' '+fmt(i.remain)+'</option>').join('');bubble(DB.meta.lang==='ar'?'اختَر الفاتورة للتحصيل وطريقة الدفع:':'Pick invoice to collect & method:');qHTML('<select id=selInv>'+ (opts||'<option>'+(DB.meta.lang==='ar'?'لا يوجد':'None')+'</option>') +'</select> <input id=amt placeholder="'+(DB.meta.lang==='ar'?'المبلغ':'Amount')+'" class="ta" inputmode="decimal" style="width:120px" value=""> '+payMethodUI()+' <button class=btn onclick=postLink("recv")>'+(DB.meta.lang==='ar'?'تسجيل':'Post')+'</button>');attachMethodWatcher()}
function payOn(inv){var list=openInvoicesOf('supplier',inv.partyCode),opts=list.map(i=>'<option value="'+i.no+'" '+(i.no===inv.no?'selected':'')+'>'+i.no+' — '+(DB.meta.lang==='ar'?'متبقّي':'Remain')+' '+fmt(i.remain)+'</option>').join('');bubble(DB.meta.lang==='ar'?'اختَر الفاتورة للسداد وطريقة الدفع:':'Pick invoice to pay & method:');qHTML('<select id=selInv>'+ (opts||'<option>'+(DB.meta.lang==='ar'?'لا يوجد':'None')+'</option>') +'</select> <input id=amt placeholder="'+(DB.meta.lang==='ar'?'المبلغ':'Amount')+'" class="ta" inputmode="decimal" style="width:120px" value=""> '+payMethodUI()+' <button class=btn onclick=postLink("pay")>'+(DB.meta.lang==='ar'?'تسجيل':'Post')+'</button>');attachMethodWatcher()}
function postLink(dir){var inv=($('selInv')||{}).value,val=+(String(($('amt').value)||'0').replace(/,/g,''));if(!inv||val<=0){alert(DB.meta.lang==='ar'?'اختر الفاتورة واكتب مبلغ صحيح':'Pick invoice and valid amount');return}var method=($('pmSel')||{value:'cash'}).value,bankKey=($('bankSel')||{value:''}).value,cashKey=($('cashSel')||{value:''}).value,chqNo=($('chqNo')||{value:''}).value;var bankName=finNameByKey(bankKey),cashName=finNameByKey(cashKey);var no=nextDoc('receipt'),org=DB.invoices.find(i=>i.no===inv)||{};var rec={dir,partyType:org.partyType,partyCode:org.partyCode,partyName:org.partyName||'',amount:val,date:today(),no,linkNo:inv,method,bankKey,bankName,cashKey,cashName,chqNo};DB.payments.push(rec);postReceipt(rec);undoStack.push({kind:'rcpt',payload:rec});save();var title=dir==='recv'?t('rcpt_title_recv'):t('rcpt_title_pay');var doc={isReceipt:true,desc:title+' — '+(org.no||''),lines:[{name:title,qty:1,price:val,line:val}],subtotal:val,total:val,date:today(),no,rcpt:{dir,partyCode:org.partyCode,partyName:org.partyName||'',method,bankKey,bankName,cashKey,cashName,chqNo,amount:val,linkNo:inv}};buildDoc(doc,title);openTab('doc')}

/* ==== Document ==== */
var lastDoc=null,lastTitle='';
function buildDoc(doc,title){$('docTitle').textContent=title+' — '+$('company').value;var normal=$('normalDoc'),rcpt=$('receiptTpl');
if(doc.isReceipt){normal.classList.add('hide');rcpt.classList.remove('hide');
$('rcptCompany').textContent=$('company').value; $('rcptTitle').textContent=title;
$('rcptNo').textContent=doc.no||'#'; $('rcptDate').textContent=doc.date||today();
var r=doc.rcpt||{};var who=(r.dir==='recv')?(DB.meta.lang==='ar'?'من العميل: ':'From: '):(DB.meta.lang==='ar'?'إلى المورد: ':'To: ');
$('rcptFrom').textContent=who+(r.partyName||r.partyCode||''); $('rcptAmt').textContent=fmt(doc.total||0);
$('rcptMethod').textContent=(r.method==='cash'?(DB.meta.lang==='ar'?'نقدي':'Cash'):r.method==='cheque'?(DB.meta.lang==='ar'?'شيك':'Cheque'):(DB.meta.lang==='ar'?'تحويل':'Bank'));
$('rcptBank').textContent=(r.method==='cash'?(r.cashName||'—'):(r.bankName||'—')); $('rcptFor').textContent=doc.desc||'—';
}else{rcpt.classList.add('hide');normal.classList.remove('hide');
var body=$('docBody'),foot=$('docFoot');body.innerHTML='';
var lines=doc.lines&&doc.lines.length?doc.lines:[{name:doc.desc||'—',qty:1,price:doc.total,net:doc.total,line:doc.total}];
lines.forEach(l=>body.insertAdjacentHTML('beforeend','<tr><td>'+((DB.meta.lang==='ar')?(l.name_ar||l.name):(l.name_en||l.name))+'</td><td class=num>'+fmt(l.qty)+'</td><td class=num>'+fmt(l.price)+'</td><td class=num>'+fmt(l.net||0)+'</td><td class=num>'+fmt(l.line||0)+'</td></tr>'));
foot.innerHTML='<tr><td colspan=4>'+t('net')+'</td><td class=num><b>'+fmt(doc.subtotal||0)+'</b></td></tr><tr><td colspan=4><b>'+t('total')+'</b></td><td class=num><b>'+fmt(doc.total||0)+'</b></td></tr>'}
lastDoc=doc;lastTitle=title}

/* ==== KPIs + Insights ==== */
function rangeOK(d,f,t){return(!f||d>=f)&&(!t||d<=t)}
function journalsFlat(){return DB.journals.flatMap(j=>(j.lines||[]).map(l=>({date:j.date,no:j.docNo,acc:l.acc,dr:+(l.dr||0),cr:+(l.cr||0)}))).sort((a,b)=>a.date.localeCompare(b.date))}
function renderKPIs(){var f=$('kpiFrom')?$('kpiFrom').value:'';var t=$('kpiTo')?$('kpiTo').value:'';DB.ui.from=f;DB.ui.to=t;persist();
var J=journalsFlat().filter(r=>rangeOK(r.date,f,t));
var sales=J.filter(x=>x.acc==='REV').reduce((s,x)=>s+(+x.cr||0),0);
var cogs =J.filter(x=>x.acc==='COGS').reduce((s,x)=>s+(+x.dr||0),0);
var exp  =J.filter(x=>x.acc==='EXP').reduce((s,x)=>s+(+x.dr||0),0);
var net=sales-(cogs+exp); $('kpiSales').textContent=fmt(sales);$('kpiCogs').textContent=fmt(cogs);$('kpiExp').textContent=fmt(exp);$('kpiNet').textContent=fmt(net)}
function drill(kind){var f=($('kpiFrom')||{}).value||'',t=($('kpiTo')||{}).value||'';var rows=[];
if(kind==='sales'){rows=DB.invoices.filter(i=>i.type==='sale'&&rangeOK(i.date,f,t)).map(i=>({date:i.date,no:i.no,desc:(i.partyCode||'')+' '+(i.partyName||''),amt:+i.total||0}))}
else if(kind==='cogs'){rows=DB.invoices.filter(i=>i.type==='sale'&&rangeOK(i.date,f,t)&&(i.cogs||0)>0).map(i=>({date:i.date,no:i.no,desc:'COGS '+(i.partyCode||''),amt:+i.cogs||0}))}
else if(kind==='exp'){rows=DB.invoices.filter(i=>i.type==='purchase'&&rangeOK(i.date,f,t)).flatMap(i=>(i.lines||[]).filter(l=>l.type==='exp'||l.type==='service').map(l=>({date:i.date,no:i.no,desc:(i.partyCode||'')+' - '+(l.name_ar||l.name_en||''),amt:+l.net||0})))}
else if(kind==='net'){var J=journalsFlat().filter(r=>rangeOK(r.date,f,t));var sales=J.filter(x=>x.acc==='REV').reduce((s,x)=>s+(+x.cr||0),0);var cogs=J.filter(x=>x.acc==='COGS').reduce((s,x)=>s+(+x.dr||0),0);var exp=J.filter(x=>x.acc==='EXP').reduce((s,x)=>s+(+x.dr||0),0);rows=[{date:'—',no:'',desc:'Sales',amt:sales},{date:'—',no:'',desc:'COGS',amt:-cogs},{date:'—',no:'',desc:'Expenses',amt:-exp},{date:'—',no:'',desc:'Net',amt:sales-(cogs+exp)}]}
var title=(kind==='sales'?t('kpi_sales'):kind==='cogs'?t('kpi_cogs'):kind==='exp'?t('kpi_exp'):t('kpi_net'));
var body=rows.map(r=>'<tr><td>'+r.date+'</td><td>'+r.no+'</td><td>'+r.desc+'</td><td class="num">'+fmt(r.amt)+'</td></tr>').join('')||'<tr><td colspan="4" style="opacity:.6">—</td></tr>';
$('drillTitle').textContent='Breakdown — '+title;$('drillBody').innerHTML=body;$('drill').style.display='flex'}
function closeDrill(){$('drill').style.display='none'}
function renderInsights(){var f=$('kpiFrom').value,t=$('kpiTo').value;
var dues=DB.customers.map(c=>({code:c.code,name:c.name,due:balCustomer(c.code,f,t)})).filter(x=>x.due>0).sort((a,b)=>b.due-a.due).slice(0,5);
$('insTopCust').innerHTML=dues.map(d=>'<div class="rowlink" onclick="openCustomerLedger(\''+d.code+'\')"><span>'+d.code+' — '+d.name+'</span><b>'+fmt(d.due)+'</b></div>').join('')||'<div class="muted">—</div>';
var sold={};DB.invoices.filter(i=>i.type==='sale'&&rangeOK(i.date,f,t)).forEach(i=>i.lines.forEach(l=>{var key=l.name_ar||l.name_en||'';sold[key]=(sold[key]||0)+(+l.qty||0)}));var arr=Object.keys(sold).map(k=>({name:k,qty:sold[k]})).sort((a,b)=>b.qty-a.qty).slice(0,5);
$('insTopItems').innerHTML=arr.map(a=>'<div class="rowlink"><span>'+a.name+'</span><b>'+fmt(a.qty)+'</b></div>').join('')||'<div class="muted">—</div>';
var accs=(DB.accounts.banks||[]).concat(DB.accounts.cash||[]);$('insCashBanks').innerHTML=accs.map(a=>{var b=accBalance(a.key,f,t);return '<div class="rowlink" onclick="openLedger(\''+a.key+'\')"><span>'+a.name+'</span><b>'+fmt(b.bal)+'</b></div>'}).join('')||'<div class="muted">—</div>'}

/* ==== Accounts / TB / Ledger ==== */
function accPretty(code){var map={'AR':'العملاء','AP':'الموردون','REV':'الإيرادات','COGS':'تكلفة المبيعات','EXP':'المصروفات','INV':'المخزون','FA':'الأصول الثابتة','BANK':'البنك','CASH':'الصندوق'};var dyn=(DB.accounts&&DB.accounts.banks?DB.accounts.banks:[]).concat(DB.accounts&&DB.accounts.cash?DB.accounts.cash:[]);var f=dyn.find(x=>x.key===code);return f?f.name+' ('+(f.accCode||f.code||'')+')':(map[code]||code)}
function accType(code){if(code==='AR'||code==='INV'||code==='FA'||code==='BANK'||code==='CASH')return'أصول';if(code==='AP')return'خصوم';if(code==='REV')return'إيراد';if(code==='COGS'||code==='EXP')return'مصروف';var dynB=DB.accounts&&DB.accounts.banks?DB.accounts.banks:[];var dynC=DB.accounts&&DB.accounts.cash?DB.accounts.cash:[];if(dynB.concat(dynC).some(x=>x.key===code))return'أصول';return'—'}
function accBalance(code,f,t){var J=journalsFlat().filter(r=>r.acc===code&&rangeOK(r.date,f,t));var dr=J.reduce((s,r)=>s+(+r.dr||0),0),cr=J.reduce((s,r)=>s+(+r.cr||0),0);return{dr,cr,bal:+(dr-cr).toFixed(2)}}
function allAccounts(){var base=['AR','AP','REV','COGS','EXP','INV','FA','BANK','CASH'];var dyn=[];if(DB.accounts&&DB.accounts.banks)dyn=dyn.concat(DB.accounts.banks.map(b=>b.key));if(DB.accounts&&DB.accounts.cash)dyn=dyn=dyn.concat(DB.accounts.cash.map(c=>c.key));return base.concat(dyn)}
function renderCOA(){var f=$('coaFrom').value||'',t=$('coaTo').value||'';var body=$('coaBody');var rows=allAccounts().map(code=>{var b=accBalance(code,f,t);return{code,name:accPretty(code),type:accType(code),dr:b.dr,cr:b.cr,bal:b.bal}}).filter(r=>r.dr||r.cr||r.bal);rows.sort((a,b)=>a.code.localeCompare(b.code));body.innerHTML=rows.map(r=>'<tr onclick="openLedger(\''+r.code+'\')" style="cursor:pointer"><td>'+r.code+'</td><td>'+r.name+'</td><td>'+r.type+'</td><td class="num">'+fmt(r.dr)+'</td><td class="num">'+fmt(r.cr)+'</td><td class="num"><b>'+fmt(r.bal)+'</b></td></tr>').join('')||'<tr><td colspan="6" style="opacity:.6">—</td></tr>'}
function renderTB(){var f=$('coaFrom').value||'',t=$('coaTo').value||'';var rows=allAccounts().map(code=>{var b=accBalance(code,f,t);return{code,name:accPretty(code),dr:b.dr,cr:b.cr}}).filter(r=>r.dr||r.cr);rows.sort((a,b)=>a.code.localeCompare(b.code));$('tbBody').innerHTML=rows.map(r=>'<tr><td>'+r.code+'</td><td>'+r.name+'</td><td class="num">'+fmt(r.dr)+'</td><td class="num">'+fmt(r.cr)+'</td></tr>').join('')||'<tr><td colspan="4" style="opacity:.6">—</td></tr>';var tDr=rows.reduce((s,r)=>s+r.dr,0),tCr=rows.reduce((s,r)=>s+r.cr,0);$('tbFoot').innerHTML='<tr><td colspan="2"><b>الإجمالي</b></td><td class="num"><b>'+fmt(tDr)+'</b></td><td class="num"><b>'+fmt(tCr)+'</b></td></tr>'}
function openLedger(code){var f=$('coaFrom').value||'',t=$('coaTo').value||'';var rows=journalsFlat().filter(r=>r.acc===code&&rangeOK(r.date,f,t));var body=rows.map(r=>{var amt=(r.dr?r.dr:-r.cr);return'<tr><td>'+r.date+'</td><td>'+r.no+'</td><td>'+accPretty(code)+'</td><td class="num">'+fmt(amt)+'</td></tr>'}).join('')||'<tr><td colspan="4" style="opacity:.6">— لا توجد قيود —</td></tr>';$('drillTitle').textContent='دفتر الأستاذ — '+accPretty(code)+' ('+code+')';$('drillBody').innerHTML=body;$('drill').style.display='flex'}
function renderPartyOptions(){var type=($('ledType')||{value:'customer'}).value;var box=$('ledParty');if(!box)return;var arr=(type==='customer'?DB.customers:DB.suppliers).slice();box.innerHTML=arr.map(p=>'<option value="'+p.code+'">'+p.code+' — '+p.name+'</option>').join('')||'<option>—</option>'}
function renderPartyLedger(){var type=($('ledType')||{value:'customer'}).value;var code=($('ledParty')||{value:''}).value;var f=$('coaFrom').value||'',t=$('coaTo').value||'';var rows=[];
if(type==='customer'){var inv=DB.invoices.filter(i=>i.type==='sale'&&i.partyCode===code&&rangeOK(i.date,f,t)).map(i=>({date:i.date,no:i.no,desc:'فاتورة بيع',dr:+i.total,cr:0}));var rc=DB.payments.filter(p=>p.dir==='recv'&&p.partyCode===code&&rangeOK(p.date,f,t)).map(p=>({date:p.date,no:p.no,desc:'إيصال تحصيل'+(p.linkNo?(' ('+p.linkNo+')'):''),dr:0,cr:+p.amount}));rows=inv.concat(rc).sort((a,b)=>a.date.localeCompare(b.date)||a.no.localeCompare(b.no));var bal=0;rows=rows.map(r=>{bal+=r.dr-r.cr;r.bal=bal;return r})}
else{var pinv=DB.invoices.filter(i=>i.type==='purchase'&&i.partyCode===code&&rangeOK(i.date,f,t)).map(i=>({date:i.date,no:i.no,desc:'فاتورة مشتريات',dr:0,cr:+i.total}));var pay=DB.payments.filter(p=>p.dir==='pay'&&p.partyCode===code&&rangeOK(p.date,f,t)).map(p=>({date:p.date,no:p.no,desc:'إيصال سداد'+(p.linkNo?(' ('+p.linkNo+')'):''),dr:+p.amount,cr:0}));rows=pinv.concat(pay).sort((a,b)=>a.date.localeCompare(b.date)||a.no.localeCompare(b.no));var bal2=0;rows=rows.map(r=>{bal2+=r.cr-r.dr;r.bal=bal2;return r})}
$('ledBody').innerHTML=rows.map(r=>'<tr><td>'+r.date+'</td><td>'+r.no+'</td><td>'+r.desc+'</td><td class="num">'+fmt(r.dr)+'</td><td class="num">'+fmt(r.cr)+'</td><td class="num"><b>'+fmt(r.bal)+'</b></td></tr>').join('')||'<tr><td colspan="6" style="opacity:.6">—</td></tr>'}
function renderAccountsView(){var tabCoa=$('subCoa'),tabTB=$('subTB'),tabLed=$('subLed');var vCoa=$('viewCoa'),vTB=$('viewTB'),vLed=$('viewLed');function setOn(t){[tabCoa,tabTB,tabLed].forEach(x=>x.classList.remove('on'));t.classList.add('on')}
vCoa.classList.toggle('hide',!tabCoa.classList.contains('on'));vTB.classList.toggle('hide',!tabTB.classList.contains('on'));vLed.classList.toggle('hide',!tabLed.classList.contains('on'));
if(tabCoa.classList.contains('on'))renderCOA();if(tabTB.classList.contains('on'))renderTB();if(tabLed.classList.contains('on')){renderPartyOptions();renderPartyLedger()}
if(!tabCoa._wired){tabCoa._wired=tabTB._wired=tabLed._wired=true;tabCoa.addEventListener('click',()=>{setOn(tabCoa);renderAccountsView()});tabTB.addEventListener('click',()=>{setOn(tabTB);renderAccountsView()});tabLed.addEventListener('click',()=>{setOn(tabLed);renderAccountsView()});$('ledType').addEventListener('change',()=>renderPartyOptions())}}

/* ==== Registers & Catalog ==== */
function renderRegs(){var C=$('custBody'),S=$('suppBody');if(!C||!S)return;C.innerHTML=DB.customers.map(c=>'<tr><td>'+c.code+'</td><td>'+c.name+'</td><td>'+(DB.meta.lang==='ar'?'أصول (العملاء)':'Asset (AR)')+'</td></tr>').join('')||'<tr><td colspan=3 style="opacity:.6">—</td></tr>';S.innerHTML=DB.suppliers.map(s=>'<tr><td>'+s.code+'</td><td>'+s.name+'</td><td>'+(DB.meta.lang==='ar'?'خصوم (الموردون)':'Liability (AP)')+'</td></tr>').join('')||'<tr><td colspan=3 style="opacity:.6">—</td></tr>'}
function renderCat(){var B=$('catBody');if(!B)return;B.innerHTML=DB.catalog.map(it=>'<tr><td>'+it.id+'</td><td>'+(DB.meta.lang==='ar'?it.name_ar:it.name_en)+'</td><td>'+ (it.type==='material'?'مخزون':it.type==='asset'?'أصول':it.type==='exp'?'مصروف':'خدمة') +'</td><td class=num>'+fmt(it.price)+'</td><td class=num>'+fmt(it.stockQty||0)+'</td><td class=num>'+fmt(it.avgCost||0)+'</td></tr>').join('')||'<tr><td colspan=6 style="opacity:.6">—</td></tr>'}
function addItem(){var a=($('itNA').value||'').trim(),e=($('itNE').value||'').trim()||a,p=+$('itP').value||0,t=($('itT')||{value:'service'}).value,tr=($('itTr')||{checked:false}).checked,oq=+(($('itOQ')||{}).value||0),oc=+(($('itOC')||{}).value||0);if(!a){alert(DB.meta.lang==='ar'?'اكتب الاسم':'Enter name');return}var id=nextItemId(DB);DB.catalog.push({id,name_ar:a,name_en:e,price:p,type:t,track:tr,stockQty:oq,avgCost:tr?oc:0});save();['itNA','itNE','itP','itOQ','itOC'].forEach(x=>{var el=$(x);if(el)el.value=''})}
function renderFin(){var banks=(DB.accounts&&DB.accounts.banks?DB.accounts.banks:[]),cash=(DB.accounts&&DB.accounts.cash?DB.accounts.cash:[]);var row=(r,kind)=>'<div class="pnl" style="margin:6px 0"><div>'+r.accCode+' — <b>'+r.name+'</b> <span class="muted">('+(kind==='bank'?'بنك':'صندوق')+')</span></div></div>';var html=(banks.map(r=>row(r,'bank')).join('')+cash.map(r=>row(r,'cash')).join(''))||'<span style="opacity:.6">—</span>';var box=$('finList');if(box)box.innerHTML=html}
function addFin(){var kind=($('finKind')||{}).value||'bank';var name=$('finName')?String($('finName').value||'').trim():'';if(!name)return;var code=nextFinCode(kind);var accCode=(kind==='bank'?'1102-':'1101-')+code.slice(-3);DB.accounts=DB.accounts||{banks:[],cash:[]};var arr=kind==='bank'?DB.accounts.banks:DB.accounts.cash;var accKey=(kind==='bank'?'BANK_':'CASH_')+code;arr.push({code,name,key:accKey,accCode});save();if($('finName'))$('finName').value='';bubble((DB.meta.lang==='ar'?'تم إضافة ':'Added ')+name+' ('+code+')','me')}
function addCustomer(){var n=($('custName').value||'').trim();if(!n)return;var code=nextCode('customer');DB.customers.push({code,name:n});$('custName').value='';save()}
function addSupplier(){var n=($('suppName').value||'').trim();if(!n)return;var code=nextCode('supplier');DB.suppliers.push({code,name:n});$('suppName').value='';save()}

/* ==== Search (Ctrl+K) + balances ==== */
function kOpen(){var kb=$('kbar');kb.style.display='flex';kb.classList.remove('hide');$('kq').focus();buildK('')}
function kClose(){var kb=$('kbar');kb.classList.add('hide');kb.style.display='none'}
function buildK(q){var res=$('kres');var QQ=(q||'').toLowerCase();var f=$('kpiFrom').value||'',t=$('kpiTo').value||'';function sec(title,html){return '<div style="padding:8px;border-top:1px solid #1f2937"><div class="muted" style="margin-bottom:6px">'+title+'</div>'+ (html||'<div style="opacity:.6">—</div>') +'</div>'}function li(txt,cls,attrs){return '<button class="btn '+(cls||'')+'" '+(attrs||'')+' style="margin:4px">'+txt+'</button>'}
var customers=DB.customers.filter(c=>c.name.toLowerCase().includes(QQ)||c.code.toLowerCase().includes(QQ)).slice(0,10).map(c=>li(c.code+' — '+c.name+' — '+(DB.meta.lang==='ar'?'رصيد':'Balance')+' '+fmt(balCustomer(c.code,f,t)),'kbtn','data-kind="cust" data-code="'+c.code+'"')).join('');
var suppliers=DB.suppliers.filter(s=>s.name.toLowerCase().includes(QQ)||s.code.toLowerCase().includes(QQ)).slice(0,10).map(s=>li(s.code+' — '+s.name+' — '+(DB.meta.lang==='ar'?'رصيد':'Balance')+' '+fmt(balSupplier(s.code,f,t)),'kbtn','data-kind="supp" data-code="'+s.code+'"')).join('');
var items=DB.catalog.filter(i=>(i.name_ar||'').includes(q)|| (i.name_en||'').toLowerCase().includes(QQ)).slice(0,10).map(i=>li((document.documentElement.lang==='ar'?i.name_ar:i.name_en),'kbtn','data-kind="cat"')).join('');
var invs=DB.invoices.filter(i=>(i.no||'').toLowerCase().includes(QQ)).slice(0,10).map(i=>li(i.no+' — '+i.type,'kbtn','data-kind="doc" data-doc="'+i.no+'"')).join('');
var rcpts=DB.payments.filter(p=>(p.no||'').toLowerCase().includes(QQ)).slice(0,10).map(p=>li(p.no+' — '+(p.dir==='recv'?'Receipt':'Payment'),'kbtn','data-kind="rcpt" data-doc="'+p.no+'"')).join('');
res.innerHTML=sec('Customers',customers)+sec('Suppliers',suppliers)+sec('Items',items)+sec('Invoices',invs)+sec('Receipts',rcpts);
Array.from(res.querySelectorAll('.kbtn')).forEach(b=>b.addEventListener('click',function(){var k=this.getAttribute('data-kind');if(k==='cust'||k==='supp'){openTab('regs')}else if(k==='cat'){openTab('cat')}else if(k==='doc'){var no=this.getAttribute('data-doc');var inv=DB.invoices.find(x=>x.no===no);var title=(inv.type==='sale'?(DB.meta.lang==='ar'?'فاتورة بيع':'Sales Invoice'):(DB.meta.lang==='ar'?'فاتورة مشتريات':'Purchase Invoice'));buildDoc(inv,title);openTab('doc')}else if(k==='rcpt'){var no=this.getAttribute('data-doc');var P=DB.payments.find(x=>x.no===no);var title=(P.dir==='recv'?t('rcpt_title_recv'):t('rcpt_title_pay'));var doc={isReceipt:true,desc:title,lines:[{name:title,qty:1,price:P.amount,line:P.amount}],subtotal:P.amount,total:P.amount,date:P.date,no:P.no,rcpt:{dir:P.dir,partyCode:P.partyCode,partyName:P.partyName||'',method:P.method,bankKey:P.bankKey,bankName:P.bankName,cashKey:P.cashKey,cashName:P.cashName,chqNo:P.chqNo,amount:P.amount,linkNo:P.linkNo||''}};buildDoc(doc,title);openTab('doc')}kClose()}))}
function openCustomerLedger(code){openTab('coa');$('subLed').click();$('ledType').value='customer';renderPartyOptions();$('ledParty').value=code;renderPartyLedger()}

/* ==== Daily Activity (Registers + Quick Modal) ==== */
function openDocByNo(no){const inv = DB.invoices.find(i=>i.no===no);if (inv){const title = inv.type==='sale' ? (DB.meta.lang==='ar'?'فاتورة بيع':'Sales Invoice') : (DB.meta.lang==='ar'?'فاتورة مشتريات':'Purchase Invoice');buildDoc(inv, title); openTab('doc'); return;}
const p = DB.payments.find(x=>x.no===no);if (p){const title = p.dir==='recv' ? t('rcpt_title_recv') : t('rcpt_title_pay');const doc = {isReceipt:true, desc:title, lines:[{name:title, qty:1, price:p.amount, line:p.amount}],subtotal:p.amount, total:p.amount, date:p.date, no:p.no,rcpt:{dir:p.dir, partyCode:p.partyCode, partyName:p.partyName||'', method:p.method,bankKey:p.bankKey, bankName:p.bankName, cashKey:p.cashKey, cashName:p.cashName,chqNo:p.chqNo, amount:p.amount, linkNo:p.linkNo||''}};buildDoc(doc, title); openTab('doc'); return;}
alert(DB.meta.lang==='ar'?'المستند غير موجود':'Document not found')}
function activityRowsForDate(d){const rows=[];DB.invoices.filter(x=>x.date===d).forEach(x=>{rows.push({date:x.date,no:x.no,type:(x.type==='sale'?t('saleT'):t('purchaseT')),party:(x.partyCode||'')+' '+(x.partyName||''),amount:+x.total})});DB.payments.filter(x=>x.date===d).forEach(x=>{rows.push({date:x.date,no:x.no,type:(x.dir==='recv'?t('receiptT'):t('paymentT')),party:(x.partyCode||'')+' '+(x.partyName||''),amount:+x.amount})});rows.sort((a,b)=> a.no.localeCompare(b.no));return rows}
function renderActivity(){const d = ($('actDate').value || today());const rows = activityRowsForDate(d);$('actBody').innerHTML = rows.map(r=>`<tr><td>${r.date}</td><td>${r.no}</td><td>${r.type}</td><td>${r.party}</td><td class="num">${fmt(r.amount)}</td><td><button class="btn" onclick="openDocByNo('${r.no}')">${t('openDoc')}</button></td></tr>`).join('') || '<tr><td colspan="6" style="opacity:.6">—</td></tr>'}
function typeEN(localType){const mapAR={ 'بيع':'Sale','مشتريات':'Purchase','تحصيل':'Receipt','سداد':'Payment' };const mapEN={ 'Sale':'Sale','Purchase':'Purchase','Receipt':'Receipt','Payment':'Payment' };return (mapEN[localType]||mapAR[localType]||localType)}
function exportActivity(){const d = ($('actDate').value || today());const rows = activityRowsForDate(d);const csv = 'Date,No.,Type,Party,Amount\n' + rows.map(r => [r.date, r.no, typeEN(r.type), `"${(r.party||'').replace(/"/g,'""')}"`, r.amount].join(',')).join('\n');download('activity_'+d+'.csv', csv)}
/* Quick modal */
function openActQuick(){ $('actQDate').value = today(); renderActivityQuick(); $('actQuick').style.display='flex' }
function closeActQuick(){ $('actQuick').style.display='none' }
function renderActivityQuick(){const d = ($('actQDate').value || today());const rows = activityRowsForDate(d);$('actQBody').innerHTML = rows.map(r=>`<tr><td>${r.date}</td><td>${r.no}</td><td>${r.type}</td><td>${r.party}</td><td class="num">${fmt(r.amount)}</td><td><button class="btn" onclick="openDocByNo('${r.no}');closeActQuick()">${t('openDoc')}</button></td></tr>`).join('') || '<tr><td colspan="6" style="opacity:.6">—</td></tr>'}
function exportActivityQuick(){const d = ($('actQDate').value || today());const rows = activityRowsForDate(d);const csv = 'Date,No.,Type,Party,Amount\n' + rows.map(r => [r.date, r.no, typeEN(r.type), `"${(r.party||'').replace(/"/g,'""')}"`, r.amount].join(',')).join('\n');download('activity_'+d+'_quick.csv', csv)}

/* ==== Export CSV generic ==== */
function download(name,content){var a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(content);a.download=name;document.body.appendChild(a);a.click();a.remove()}
function exportTB(){var f=$('coaFrom').value||'',t=$('coaTo').value||'';var rows=allAccounts().map(code=>{var b=accBalance(code,f,t);return{code,name:accPretty(code),dr:b.dr,cr:b.cr}}).filter(r=>r.dr||r.cr);var csv='Code,Name,Debit,Credit\n'+rows.map(r=>[r.code,'"'+r.name.replace(/"/g,'""')+'"',r.dr,r.cr].join(',')).join('\n');download('trial_balance.csv',csv)}
function exportLedger(){var f=$('coaFrom').value||'',t=$('coaTo').value||'';var acc=prompt('Account code (e.g., AR, INV, BANK_... )');if(!acc)return;var rows=journalsFlat().filter(r=>r.acc===acc&&rangeOK(r.date,f,t));var csv='Date,Doc,Account,Debit,Credit\n'+rows.map(r=>[r.date,r.no,accPretty(acc),r.dr,r.cr].join(',')).join('\n');download('ledger_'+acc+'.csv', csv)}

/* ==== Events & init ==== */
$('manual').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendManual()}});$('company').addEventListener('input',e=>{DB.meta.company=e.target.value;save(true)});
$('lang').addEventListener('change',e=>{DB.meta.lang=e.target.value;applyLang();save(true)});
window.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&!e.shiftKey&&e.key.toLowerCase()==='k'){e.preventDefault();kOpen()}if(e.key==='Escape'){kClose();closeActQuick()}});
$('btnK').addEventListener('click',kOpen);$('mEasy').addEventListener('click',()=>{DB.ui=DB.ui||{};DB.ui.mode='easy';save(true);applyMode()});$('mPro').addEventListener('click',()=>{DB.ui=DB.ui||{};DB.ui.mode='pro';save(true);applyMode()});
function attachNav(){['Chat','Doc','Cat','Regs','Coa'].forEach(n=>{$('t'+n).addEventListener('click',function(){openTab(n.toLowerCase(),this);if(n==='Coa')renderAccountsView()})})}

/* Demo + Wipe */
function seedDemo(){if(!confirm(DB.meta.lang==='ar'?'زرع بيانات تجريبية؟':'Seed demo data?'))return;
DB={meta:{company:'البركة للمقاولات',taxMode:'taxed',taxRate:15,lang:DB.meta.lang},ui:{mode:DB.ui&&DB.ui.mode||'easy',from:'',to:''},seq:{customer:0,supplier:0,sales:0,purchase:0,receipt:0,item:0,bank:0,cash:0},customers:[],suppliers:[],accounts:{banks:[],cash:[]},catalog:[],invoices:[],payments:[],journals:[]};
DB.accounts.banks.push({code:'BK001',name:'QNB',key:'BANK_BK001',accCode:'1102-001'});DB.accounts.cash.push({code:'CA001',name:'Main Cash',key:'CASH_CA001',accCode:'1101-001'});
var srv={id:nextItemId(DB),name_ar:'خدمة صيانة',name_en:'Maintenance',price:200,type:'service',track:false,stockQty:0,avgCost:0},
    mat={id:nextItemId(DB),name_ar:'فلتر زيت',name_en:'Oil Filter',price:180,type:'material',track:true,stockQty:5,avgCost:120};
DB.catalog.push(srv,mat);
var c1={code:nextCode('customer'),name:'الشرق للأسمنت'},s1={code:nextCode('supplier'),name:'الصيني للتوريدات'};
DB.customers.push(c1); DB.suppliers.push(s1);
st.partyType='supplier';st.partyCode=s1.code;st.partyName=s1.name;st.lines=[{type:'material',name_ar:mat.name_ar,name_en:mat.name_en,qty:10,price:100,net:1000,line:1000}];finalizePurchase();
st.mode='sale';st.payType='credit';st.partyType='customer';st.partyCode=c1.code;st.partyName=c1.name;st.lines=[{type:'service',name_ar:srv.name_ar,name_en:srv.name_en,qty:5,price:200,net:1000,line:1000},{type:'material',name_ar:mat.name_ar,name_en:mat.name_en,qty:2,price:180,net:360,line:360}];saveSale();
var inv=DB.invoices.find(x=>x.type==='sale');var no=nextDoc('receipt');
var rec={dir:'recv',partyType:'customer',partyCode:c1.code,partyName:c1.name,amount:500,date:today(),no,linkNo:inv.no,method:'bank',bankKey:'BANK_BK001',bankName:'QNB',cashKey:'',cashName:'',chqNo:''};
DB.payments.push(rec);postReceipt(rec);save();resetFlow();openTab('chat');renderActions();applyMode()}
function wipeAll(){if(confirm(DB.meta.lang==='ar'?'مسح كل البيانات؟':'Wipe all data?')){localStorage.removeItem(K);location.reload()}}

/* boot */
applyMode();applyLang();rerenderAll();resetFlow();attachNav();
(function(){const td=today();const from=td.slice(0,8)+'01';if ($('kpiFrom')) $('kpiFrom').value=DB.ui.from||from;if ($('kpiTo')) $('kpiTo').value=DB.ui.to||td;if ($('coaFrom')) $('coaFrom').value=$('kpiFrom').value;if ($('coaTo')) $('coaTo').value=$('kpiTo').value;if ($('actDate')) $('actDate').value=td;if ($('actQDate')) $('actQDate').value=td})();
renderKPIs();renderAccountsView();renderInsights();renderActivity();renderActivityQuick();
</script>

<!-- Utility Bar (v2 - collapsible) -->
<div id="mobile-utility-bar" class="collapsed" style="position:fixed; right:12px; bottom: calc(96px + env(safe-area-inset-bottom)); z-index:99998; display:flex; gap:8px; flex-direction:column; align-items:flex-end;">
  <div id="util-stack" style="display:none; flex-direction:column; gap:8px;">
    <button id="btn-save-doc" class="btn util-secondary" title="حفظ">💾</button>
    <button id="btn-export-backup" class="btn util-secondary" title="تصدير نسخة احتياطية">⬇️</button>
    <button id="btn-import-backup" class="btn util-secondary" title="استيراد نسخة احتياطية">⬆️</button>
    <button id="btn-print" class="btn util-secondary" title="طباعة/تنزيل PDF">🖨️</button>
  </div>
  <button id="util-toggle" class="btn" title="أدوات">⋮</button>
</div>
<div id="app-toast" role="status" aria-live="polite"></div>


<script>
(function(){
  // keyboard safe area
  try{
    if (window.visualViewport) {
      const r = document.documentElement;
      const upd = () => r.style.setProperty('--kb-safe', Math.max(0, window.innerHeight - visualViewport.height) + 'px');
      visualViewport.addEventListener('resize', upd);
      visualViewport.addEventListener('scroll', upd);
      window.addEventListener('resize', upd);
      upd();
    }
  }catch(e){}

  function showToast(msg, ms){
    var t = document.getElementById('app-toast'); if(!t) return;
    t.textContent = msg; t.classList.add('show'); clearTimeout(t._hid);
    t._hid = setTimeout(()=>t.classList.remove('show'), ms||1600);
  }

  function getAllLocalStorage(){
    const d = {}; for (let i=0; i<localStorage.length; i++){ const k = localStorage.key(i); d[k]=localStorage.getItem(k); } return d;
  }
  function setAllLocalStorage(data){ for (const k in data){ try{ localStorage.setItem(k, data[k]); }catch(e){} } }

  function appSave(){
    try{
      if (typeof window.saveDocument === 'function') window.saveDocument();
      else if (window.app && typeof window.app.save === 'function') window.app.save();
      localStorage.setItem('app:lastSnapshot', JSON.stringify({ts:new Date().toISOString(), data:getAllLocalStorage()}));
      showToast('تم الحفظ');
    }catch(e){ console.error(e); showToast('تعذر الحفظ'); }
  }
  function exportBackup(){
    const blob = new Blob([JSON.stringify(getAllLocalStorage(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = 'backup-'+ new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') +'.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('تم تصدير النسخة');
  }
  function importBackup(){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = () => {
      const f = inp.files && inp.files[0]; if(!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try{
          const data = JSON.parse(rd.result);
          if(!confirm('سيتم استبدال البيانات الحالية بالنسخة المختارة. المتابعة؟')) return;
          setAllLocalStorage(data); showToast('تم الاستيراد'); location.reload();
        }catch(e){ console.error(e); showToast('ملف غير صالح'); }
      };
      rd.readAsText(f);
    };
    inp.click();
  }
  function doPrint(){ window.print(); }

  window.addEventListener('DOMContentLoaded', function(){
    // buttons
    var bSave = document.getElementById('btn-save-doc');
    var bExp  = document.getElementById('btn-export-backup');
    var bImp  = document.getElementById('btn-import-backup');
    var bPrn  = document.getElementById('btn-print');
    if (bSave) bSave.addEventListener('click', appSave);
    if (bExp)  bExp.addEventListener('click', exportBackup);
    if (bImp)  bImp.addEventListener('click', importBackup);
    if (bPrn)  bPrn.addEventListener('click', doPrint);

    // input UX
    var inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(function(el){
      if (!el.hasAttribute('enterkeyhint')) el.setAttribute('enterkeyhint', 'send');
      if (!el.hasAttribute('autocomplete')) el.setAttribute('autocomplete','off');
      if (!el.hasAttribute('autocapitalize')) el.setAttribute('autocapitalize','none');
      if (!el.placeholder) el.placeholder = 'اكتب: بيع 2 × منتج بـ 180';
    });

    // collapsible utility bar
    var bar = document.getElementById('mobile-utility-bar');
    var toggle = document.getElementById('util-toggle');
    function setState(exp){ if (!bar) return; bar.classList.toggle('expanded', !!exp); bar.classList.toggle('collapsed', !exp); }
    if (toggle && bar){
      toggle.addEventListener('click', function(e){ e.stopPropagation(); setState(!bar.classList.contains('expanded')); });
      document.addEventListener('click', function(ev){ if (!bar.contains(ev.target)) setState(false); });
    }

    // auto-dim while scrolling (keeps it out of the way)
    var hideTimer;
    window.addEventListener('scroll', function(){
      if(!bar) return; bar.style.opacity = '.25'; clearTimeout(hideTimer); hideTimer = setTimeout(()=> bar.style.opacity='1', 300);
    }, {passive:true});
  });

  // confirm before destructive buttons
  document.addEventListener('click', function(e){
    var el = e.target; if (!el) return;
    var txt = (el.textContent || '').trim(); var action = el.getAttribute && (el.getAttribute('data-action') || el.className || '');
    if (/مسح|حذف|Reset|Clear/i.test(txt) || /clear|reset|wipe/i.test(action)) {
      if (!confirm('هل أنت متأكد من مسح البيانات؟')) { e.preventDefault(); e.stopPropagation(); }
    }
  }, true);

  // shortcuts
  document.addEventListener('keydown', function(e){
    if (e.ctrlKey && (e.key === 's' || e.key === 'S')) { e.preventDefault(); appSave(); }
    if (e.ctrlKey && (e.key === 'n' || e.key === 'N')) { 
      if (typeof window.newOperation === 'function') window.newOperation();
      else document.dispatchEvent(new CustomEvent('app:new'));
      showToast('عملية جديدة'); e.preventDefault();
    }
    if (e.key === 'F1') { alert('اختصارات: Ctrl+S حفظ | Ctrl+N عملية جديدة | Ctrl+K بحث'); e.preventDefault(); }
  });
})();
</script>

</body>
</html>
