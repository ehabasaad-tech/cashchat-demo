<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CashChat â€” Ø¯ÙŠÙ…Ùˆ Ø³Ø±ÙŠØ¹ (Ù…Ù„Ù ÙˆØ§Ø­Ø¯)</title>
<meta name="description" content="Ø¯ÙŠÙ…Ùˆ ØªÙØ§Ø¹Ù„ÙŠ Ø³Ø±ÙŠØ¹ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨ÙŠØ¹/Ù…Ø´ØªØ±ÙŠØ§Øª/ØªØ­ØµÙŠÙ„/Ø³Ø¯Ø§Ø¯ Ù…Ø¹ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØŒ Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… Ù„Ø¥Ø¶Ø§ÙØ©/Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ØŒ ÙˆØ­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.">

<style>
  :root{--bg:#0b1220;--panel:#0f172a;--line:#1e293b;--ink:#e6edf3;--mut:#9fb4c9;--pri:#0ea5e9;--ok:#22c55e;--danger:#ef4444;--vh:1vh}
  @supports (height:1dvh){ :root{--vh:1dvh} }

  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:#93c5fd;text-decoration:none}
  input,select,textarea{font-size:16px} /* Ù„Ù…Ù†Ø¹ Zoom iOS */

  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:#16a34a;color:#052e2b;font-weight:800;display:flex;align-items:center;justify-content:center}
  .wrap{max-width:960px;margin:auto;padding:12px}
  .cta{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:10px 12px;border:0;border-radius:10px;cursor:pointer}
  .btn-pri{background:var(--ok);color:#04200f;font-weight:800}
  .btn-ghost{background:var(--panel);color:#cfe7ff;border:1px solid #28405c}
  .btn-danger{background:var(--danger);color:#fff}

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .k{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .k b{display:block;font-size:12px;color:var(--mut)}
  .k big{display:block;font-size:20px;margin-top:4px}

  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  ul{list-style:none;padding:0;margin:8px 0 0;max-height:240px;overflow:auto}
  li{display:flex;justify-content:space-between;gap:8px;border-bottom:1px dashed var(--line);padding:6px 4px}
  .pill{background:#0ea5e922;border:1px solid var(--pri);border-radius:999px;padding:2px 8px;font-size:12px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* Dock & Sheet */
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  @media (max-width:820px){
    #dock{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--line);padding:10px;display:flex;gap:8px;z-index:20}
    #dock button{flex:1;padding:12px;border:0;border-radius:12px;background:var(--pri);color:#021018;font-weight:800}
    #dock button.secondary{background:#0f172a;color:#cfe7ff;border:1px solid #28405c}

    #sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--bg);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -10px 40px #000a;padding:12px;transition:bottom .25s;z-index:30;max-height:calc(100*var(--vh) - 110px);overflow:auto;padding-bottom:env(safe-area-inset-bottom)}
    #sheet.open{bottom:0}
  }

  /* Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ… */
  #todayPanel{position:fixed;right:12px;top:60px;width:320px;max-width:90vw;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;display:none;z-index:25}
  #todayPanel.open{display:block}

  /* Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… Ù„Ø¥Ø¶Ø§ÙØ©/Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ â€” ÙŠØ·Ù„Ø¹ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ */
  @media (max-width: 820px){
    #miniItemsBar{
      position:fixed; left:10px; right:10px; bottom:78px;
      display:flex; gap:8px; z-index:9999;
      background:#0f172a; border:1px solid #1e293b; padding:8px;
      border-radius:14px; box-shadow:0 -8px 28px #0008;
      padding-bottom:calc(env(safe-area-inset-bottom) + 8px);
      transform:translateY(0); transition:transform .15s ease;
    }
    #miniItemsBar button{flex:1;padding:12px;border:0;border-radius:12px;font-weight:800}
    #btnAddLine{background:#0ea5e9;color:#021018}
    #btnFinishLines{background:#22c55e;color:#04200f}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">ğŸ’¬$</div>
    <div>
      <div style="font-weight:800">CashChat</div>
      <small style="color:var(--mut)">Ø¯ÙŠÙ…Ùˆ ØªÙØ§Ø¹Ù„ÙŠ â€” ÙŠØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·</small>
    </div>
  </div>
  <div class="cta">
    <a class="btn btn-ghost" href="https://wa.me/201000000000" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
    <button id="btnVideo" class="btn btn-ghost">ğŸ¥ ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
    <button id="btnToday" class="btn btn-ghost">ğŸ“ˆ Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</button>
  </div>
</header>

<div class="wrap">
  <!-- KPIs -->
  <div class="kpis">
    <div class="k"><b>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</b><big id="k-sales">0</big></div>
    <div class="k"><b>Ù…Ø´ØªØ±ÙŠØ§Øª/Ù…ØµØ±ÙˆÙ</b><big id="k-exp">0</big></div>
    <div class="k"><b>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</b><big id="k-profit">0</big></div>
  </div>

  <!-- Ù„ÙˆØ­ Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ… -->
  <div id="todayPanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <b>Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</b>
      <button id="closeToday" class="btn btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <ul id="todayList" style="max-height:300px;overflow:auto;margin-top:8px"></ul>
  </div>

  <!-- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
  <div class="grid">
    <div class="card">
      <b>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</b>
      <ul id="lstC"></ul>
      <div class="actions"><button id="addC" class="btn btn-ghost">+ Ø¹Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹</button></div>
    </div>
    <div class="card">
      <b>Ø§Ù„Ø£ØµÙ†Ø§Ù/Ø§Ù„Ø®Ø¯Ù…Ø§Øª</b>
      <ul id="lstI"></ul>
      <div class="actions"><button id="addI" class="btn btn-ghost">+ ØµÙ†Ù/Ø®Ø¯Ù…Ø© Ø³Ø±ÙŠØ¹Ø©</button></div>
    </div>
    <div class="card">
      <b>ÙÙˆØ§ØªÙŠØ±</b>
      <ul id="lstV"></ul>
    </div>
  </div>

  <div class="actions" style="margin-top:12px">
    <button id="export" class="btn btn-ghost">ØªØµØ¯ÙŠØ± JSON</button>
    <button id="clear" class="btn btn-danger">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
  </div>
  <small style="color:var(--mut)">âš ï¸ Ù‡Ø°Ø§ Ø¯ÙŠÙ…Ùˆ Ù…Ø­Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø³Ø­Ø§Ø¨Ø©). Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§ Firebase.</small>
</div>

<!-- Ø´Ø±ÙŠØ· Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
<nav id="dock">
  <button data-op="sale">Ø¨ÙŠØ¹</button>
  <button class="secondary" data-op="purchase">Ù…Ø´ØªØ±ÙŠØ§Øª</button>
  <button class="secondary" data-op="receipt">ØªØ­ØµÙŠÙ„</button>
  <button class="secondary" data-op="payment">Ø³Ø¯Ø§Ø¯</button>
</nav>

<!-- Bottom Sheet -->
<div id="sheet" aria-hidden="true">
  <div style="height:4px;width:48px;background:#28405c;border-radius:999px;margin:6px auto"></div>
  <div class="card">
    <b id="title">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</b>
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:6px">
      <input id="party" placeholder="Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯ (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)">
      <input id="date" type="date">
      <input id="ref"  placeholder="Ù…Ø±Ø¬Ø¹/Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    </div>

    <div id="saleFields" class="card" style="margin-top:10px">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <input id="item"  placeholder="Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø®Ø¯Ù…Ø©">
        <input id="qty"   type="number" step="1" min="1" value="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input id="price" type="number" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:8px">
        <input id="disc" type="number" step="0.01" placeholder="Ø®ØµÙ…">
        <input id="tax"  type="number" step="0.01" placeholder="Ø¶Ø±ÙŠØ¨Ø© %">
        <input id="total" type="number" step="0.01" placeholder="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" readonly>
      </div>
    </div>

    <div id="moneyFields" class="card" style="display:none;margin-top:10px">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <input id="amount" type="number" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <select id="method">
          <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
          <option value="bank">Ø´ÙŠÙƒ/ØªØ­ÙˆÙŠÙ„</option>
        </select>
        <input id="bank" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ/Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
    </div>

    <div class="actions">
      <button id="save" class="btn btn-pri">Ø­ÙØ¸</button>
      <button id="close" class="btn btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… Ù„Ø¥Ø¶Ø§ÙØ©/Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ -->
<div id="miniItemsBar" hidden>
  <button id="btnAddLine">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
  <button id="btnFinishLines">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
</div>

<script>
/* ========= ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ========= */
const LS={C:'cc_demo_customers',I:'cc_demo_items',V:'cc_demo_invoices',OPS:'cc_demo_ops'};
const get=(k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const fmt=(n)=>Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2});

/* Seed Ø£ÙˆÙ„ Ù…Ø±Ø© */
(function(){
  if(get(LS.C).length) return;
  set(LS.C,[{id:1,name:'SAMI',code:'C001'},{id:2,name:'FAMILY',code:'C002'}]);
  set(LS.I,[{id:1,name:'ÙÙ„ØªØ± Ø²ÙŠØª',price:180,type:'Ù…ÙˆØ§Ø¯'},{id:2,name:'Ø·Ø¨Ø§Ø¹Ø© Ù„ÙŠØ²Ø±',price:100,type:'Ø®Ø¯Ù…Ø©'}]);
  set(LS.V,[{id:1,number:'INV-1001',customer:'C001',total:360,kind:'sale'}]);
  set(LS.OPS,[]);
})();

/* Ù…Ø±Ø§Ø¬Ø¹ */
const $=(s)=>document.querySelector(s);
const listC=$('#lstC'), listI=$('#lstI'), listV=$('#lstV');
const kSales=$('#k-sales'), kExp=$('#k-exp'), kProfit=$('#k-profit');
const todayPanel=$('#todayPanel'), todayList=$('#todayList');

/* Ø±Ø³Ù… */
function render(){
  const C=get(LS.C), I=get(LS.I), V=get(LS.V);
  listC.innerHTML=''; C.forEach(c=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${c.name} <span class="pill">${c.code||''}</span></span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ set(LS.C,C.filter(x=>x.id!==c.id)); render(); };
    li.appendChild(del); listC.appendChild(li);
  });

  listI.innerHTML=''; I.forEach(i=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${i.name} â€” ${fmt(i.price)} <span class="pill">${i.type||''}</span></span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ set(LS.I,I.filter(x=>x.id!==i.id)); render(); };
    li.appendChild(del); listI.appendChild(li);
  });

  listV.innerHTML=''; V.forEach(v=>{
    const li=document.createElement('li');
    const kind=v.kind==='purchase'?'(Ø´Ø±Ø§Ø¡)':v.kind==='receipt'?'(ØªØ­ØµÙŠÙ„)':v.kind==='payment'?'(Ø³Ø¯Ø§Ø¯)':'';
    li.innerHTML=`<span>${v.number||'â€”'} ${kind} â€” Ø¹Ù…ÙŠÙ„: ${v.customer||'â€”'} â€” ${fmt(v.total)}</span>`;
    const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ set(LS.V,V.filter(x=>x.id!==v.id)); render(); };
    li.appendChild(del); listV.appendChild(li);
  });

  const sales   = V.filter(v=>v.kind==='sale' || !v.kind).reduce((s,v)=>s+Number(v.total||0),0);
  const buys    = V.filter(v=>v.kind==='purchase').reduce((s,v)=>s+Number(v.total||0),0);
  const expense = I.filter(x=>x.type==='Ù…ØµØ±ÙˆÙ').reduce((s,x)=>s+Number(x.price||0),0);
  kSales.textContent=fmt(sales);
  kExp.textContent  =fmt(buys + expense);
  kProfit.textContent=fmt(sales - (buys+expense));
}
render();

/* Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ */
$('#btnVideo').onclick=()=>window.open('https://ehabasaad-tech.github.io/cashchat-demo/','_blank');
$('#btnToday').onclick=()=>{fillToday();todayPanel.classList.add('open');};
$('#closeToday').onclick=()=>todayPanel.classList.remove('open');

/* ØªØµØ¯ÙŠØ±/Ù…Ø³Ø­ */
$('#export').onclick=()=>{
  const data={customers:get(LS.C),items:get(LS.I),invoices:get(LS.V),ops:get(LS.OPS)};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cashchat-demo-local.json'; a.click();
  URL.revokeObjectURL(a.href);
};
$('#clear').onclick=()=>{
  if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ')){ Object.values(LS).forEach(k=>localStorage.removeItem(k)); render(); todayPanel.classList.remove('open'); }
};

/* Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© */
$('#addC').onclick=()=>{
  const name=prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ'); if(!name) return;
  const code=prompt('ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ Ù„Ù„ØªÙˆÙ„ÙŠØ¯)')||genCode('C',LS.C,'code');
  const arr=get(LS.C); arr.push({id:Date.now(),name,code}); set(LS.C,arr); render();
};
$('#addI').onclick=()=>{
  const name=prompt('Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù/Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ'); if(!name) return;
  const price=Number(prompt('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŸ')||0);
  const type=prompt('Ø§Ù„Ù†ÙˆØ¹: Ù…ÙˆØ§Ø¯/Ù…ØµØ±ÙˆÙ/Ø£ØµÙ„/Ø®Ø¯Ù…Ø©','Ù…ÙˆØ§Ø¯')||'Ù…ÙˆØ§Ø¯';
  const arr=get(LS.I); arr.push({id:Date.now(),name,price,type}); set(LS.I,arr); render();
};
function genCode(prefix,key,field){ const arr=get(key); const n=arr.filter(x=>(x[field]||'').startsWith(prefix)).length+1; return `${prefix}${String(n).padStart(3,'0')}`; }

/* Dock & Sheet */
const dock=document.getElementById('dock'), sheet=document.getElementById('sheet');
const F={title:$('#title'),party:$('#party'),date:$('#date'),ref:$('#ref'),
item:$('#item'),qty:$('#qty'),price:$('#price'),disc:$('#disc'),tax:$('#tax'),total:$('#total'),
amount:$('#amount'),method:$('#method'),bank:$('#bank'),
saleBox:$('#saleFields'),moneyBox:$('#moneyFields')};
F.date.valueAsDate=new Date(); F.tax.value=15;
['qty','price','disc','tax'].forEach(id=>F[id].addEventListener('input',calcTotal));

let op='sale';
dock.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>openSheet(b.dataset.op)));
$('#close').onclick=()=>sheet.classList.remove('open');
$('#save').onclick=saveOp;

function openSheet(kind){
  op=kind; sheet.classList.add('open');
  F.party.value=''; F.ref.value=''; F.item.value=''; F.qty.value=1; F.price.value=''; F.disc.value=''; F.total.value='';
  F.amount.value=''; F.method.value='cash'; F.bank.value='';
  if(op==='sale'||op==='purchase'){ F.title.textContent=(op==='sale'?'Ø¨ÙŠØ¹':'Ù…Ø´ØªØ±ÙŠØ§Øª'); F.saleBox.style.display='block'; F.moneyBox.style.display='none'; calcTotal(); setTimeout(()=>F.item.focus(),50); }
  else { F.title.textContent=(op==='receipt'?'ØªØ­ØµÙŠÙ„':'Ø³Ø¯Ø§Ø¯'); F.saleBox.style.display='none'; F.moneyBox.style.display='block'; setTimeout(()=>F.amount.focus(),50); }
}
function calcTotal(){
  const q=Number(F.qty.value||0), p=Number(F.price.value||0), d=Number(F.disc.value||0), t=Number(F.tax.value||0);
  const sub=Math.max(q*p - d,0); F.total.value=(Math.round((sub + sub*t/100)*100)/100);
}
function toast(m){const t=document.createElement('div');t.textContent=m;t.style.cssText='position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#22c55e;color:#03220e;padding:10px 14px;border-radius:10px;font-weight:800;z-index:40';document.body.appendChild(t);setTimeout(()=>t.remove(),1400);}

function saveOp(){
  const ts=Date.now(), today = new Date().toISOString().slice(0,10);
  if(op==='sale'||op==='purchase'){
    if(!F.item.value || !F.price.value){ alert('Ø§ÙƒØªØ¨ Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„Ø³Ø¹Ø±'); return; }
    const v=get(LS.V);
    const invNo = (op==='sale'?'INV':'PUR') + '-' + ts.toString().slice(-4);
    const total = Number(F.total.value||0);
    v.push({id:ts,number:invNo,customer:(F.party.value||'C001'),total,kind:op,date:today,note:F.ref.value});
    set(LS.V,v);
    // Ø£Ø¶Ù Ø§Ù„ØµÙ†Ù Ø¥Ù† ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ù‹Ø§
    const I=get(LS.I);
    if(F.item.value && !I.some(x=>x.name===F.item.value)){
      I.push({id:ts,name:F.item.value,price:Number(F.price.value||0),type:(op==='purchase'?'Ù…ÙˆØ§Ø¯':'Ø®Ø¯Ù…Ø©')});
      set(LS.I,I);
    }
    pushOp({ts,kind:op,title:(op==='sale'?'Ø¨ÙŠØ¹':'Ù…Ø´ØªØ±ÙŠØ§Øª'),amount:total});
  } else {
    const amount = Number(F.amount.value||0);
    if(!amount){ alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº'); return; }
    if(op==='receipt'){
      const v=get(LS.V); v.push({id:ts,number:'RCPT-'+ts.toString().slice(-4),customer:(F.party.value||'C001'),total:amount,kind:'receipt',date:today,note:F.ref.value}); set(LS.V,v);
      pushOp({ts,kind:'receipt',title:'ØªØ­ØµÙŠÙ„',amount});
    }else{
      const I=get(LS.I); I.push({id:ts,name:'Ø³Ø¯Ø§Ø¯',price:amount,type:'Ù…ØµØ±ÙˆÙ'}); set(LS.I,I);
      pushOp({ts,kind:'payment',title:'Ø³Ø¯Ø§Ø¯',amount});
    }
  }
  sheet.classList.remove('open'); render(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§');
}
function pushOp(op){ const ops=get(LS.OPS); ops.push(op); set(LS.OPS,ops); }
function fillToday(){
  const ops=get(LS.OPS);
  const s=new Date(); s.setHours(0,0,0,0);
  const e=new Date(); e.setHours(23,59,59,999);
  const arr=ops.filter(o=>o.ts>=s.getTime() && o.ts<=e.getTime()).sort((a,b)=>b.ts-a.ts);
  todayList.innerHTML = arr.length ? arr.map(o=>`<li><span>${o.title}</span><span>${fmt(o.amount)}</span></li>`).join('') : '<li style="opacity:.75">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</li>';
}

/* ======== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù… + Ø­Ù„ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ======== */
(function(){
  const isMobile = matchMedia('(max-width:820px)').matches;
  const bar = document.getElementById('miniItemsBar');
  if(!isMobile || !bar) return;

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·
  bar.hidden = false;

  // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹Ø±ÙØ© ÙƒÙˆÙ†ØªÙŠÙ†Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  const candidates=['#linesTable','.lines','.items-area','.invoice-lines','table.lines'];
  let lineContainer=null; for(const s of candidates){ const el=document.querySelector(s); if(el){ lineContainer=el; break; } }
  const finishBtn=document.getElementById('btnFinishLines');
  const addBtn=document.getElementById('btnAddLine');

  const hasLines=()=>{
    if(!lineContainer) return true;
    const rows=lineContainer.querySelectorAll('tr[data-line], tr.line, .line, .row-line');
    return rows.length>0;
  };
  function updateFinish(){ finishBtn.disabled=!hasLines(); finishBtn.style.opacity=finishBtn.disabled?.6:1; }
  updateFinish(); if(lineContainer){ new MutationObserver(updateFinish).observe(lineContainer,{childList:true,subtree:true}); }

  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±: Ù†Ø¬Ø±Ø¨ Ø¯ÙˆØ§Ù„ÙƒØŒ ÙˆØ¥Ù„Ø§ Ù†ÙØªØ­ Ø§Ù„Ù€Sheet/Ù†Ø±Ø³Ù„ Events
  addBtn.onclick=()=>{
    if(typeof window.addLine==='function'){ window.addLine(); updateFinish(); return; }
    if(typeof window.addRow ==='function'){ window.addRow();  updateFinish(); return; }
    // ÙÙŠ Ø§Ù„Ø¯ÙŠÙ…Ùˆ: Ø§ÙØªØ­ Sheet Ø¨ÙŠØ¹ Ø¨Ø³Ø±Ø¹Ø©
    if(sheet.classList.contains('open')===false) openSheet('sale'); else { /* Ù„Ùˆ Ù…ÙØªÙˆØ­ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯ */ }
    // Ø­Ø¯Ø« Ø¹Ø§Ù… ÙŠÙ…ÙƒÙ† Ø³Ù…Ø§Ø¹Ù‡
    window.dispatchEvent(new CustomEvent('cashchat:add-line'));
    updateFinish();
  };
  finishBtn.onclick=()=>{
    if(typeof window.finishLines==='function'){ window.finishLines(); return; }
    if(typeof window.endItems   ==='function'){ window.endItems();    return; }
    // ÙÙŠ Ø§Ù„Ø¯ÙŠÙ…Ùˆ: Ù„Ùˆ Sheet Ù…ÙØªÙˆØ­ ÙˆÙ…Ø¹Ø¨Ù‘ÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ Ø§Ø­ÙØ¸
    if(sheet.classList.contains('open') && (op==='sale'||op==='purchase') && Number(F.total.value||0)>0){
      saveOp();
    }else{
      window.dispatchEvent(new CustomEvent('cashchat:finish-lines'));
      toast('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø¯ÙŠÙ…Ùˆ)');
    }
  };

  // Ø­Ù„ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯: visualViewport + --vh + Ø±ÙØ¹ Ø§Ù„Ø´Ø±ÙŠØ· ÙˆØ§Ù„Ù€Dock/Sheet
  const dock=document.getElementById('dock');
  function applyViewportFix(){
    const vh=(window.visualViewport? visualViewport.height : innerHeight)/100;
    document.documentElement.style.setProperty('--vh',vh+'px');
    if(!window.visualViewport) return;
    const kb = Math.max(0, innerHeight - visualViewport.height);
    bar.style.transform = kb ? `translateY(-${kb}px)` : 'translateY(0)';
    if(sheet){
      sheet.style.paddingBottom = `calc(${kb}px + env(safe-area-inset-bottom))`;
      sheet.style.maxHeight = `calc(100 * var(--vh) - 110px)`;
    }
    if(dock) dock.style.transform = kb ? `translateY(-${kb}px)` : 'translateY(0)';
  }
  if(window.visualViewport){
    visualViewport.addEventListener('resize',applyViewportFix);
    visualViewport.addEventListener('scroll',applyViewportFix);
  }
  applyViewportFix();

  // ØªØ£ÙƒÙŠØ¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
  document.addEventListener('focusin',(e)=>{
    const t=e.target; const tag=(t.tagName||'').toLowerCase();
    if(tag==='input'||tag==='select'||tag==='textarea'){
      setTimeout(()=>{ try{ t.scrollIntoView({block:'center',behavior:'smooth'});}catch{} },80);
    }
  });

  // Ù„Ùˆ ÙÙŠÙ‡ Dock Ø³ÙÙ„ÙŠ Ù‚Ø¯ÙŠÙ… ÙˆØ¨Ø¯ÙˆÙ† visualViewport
  const extraBottom=document.querySelector('#dock,.mobile-dock,.bottom-bar');
  if(extraBottom && !window.visualViewport){
    bar.style.bottom=(extraBottom.offsetHeight+12)+'px';
  }
})();
</script>
</body>
</html>
